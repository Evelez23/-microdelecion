<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oso Abrazos - Aventura Completa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }
        
        body {
            background: linear-gradient(to bottom, #6a11cb, #2575fc);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
        }
        
        h1 {
            font-size: 2.8rem;
            text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5);
            color: #FFD700;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .subtitle {
            font-size: 1.3rem;
            margin-bottom: 25px;
            text-align: center;
            line-height: 1.5;
        }
        
        .game-wrapper {
            position: relative;
            width: 100%;
            height: 500px;
            margin-bottom: 30px;
        }
        
        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
            border: 5px solid #FFD700;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
        }
        
        #gameCanvas {
            display: block;
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            width: 100%;
            height: 100%;
        }
        
        #ui {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 12px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 16px;
            z-index: 10;
            min-width: 180px;
        }
        
        .ui-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .power-bar {
            width: 100px;
            height: 12px;
            background: #444;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .power-level {
            height: 100%;
            background: linear-gradient(to right, #FF69B4, #FF1493);
            width: 100%;
            border-radius: 8px;
            transition: width 0.3s;
        }
        
        #levelIndicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 10;
        }
        
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        
        #coverImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        
        #startButton {
            position: absolute;
            bottom: 40px;
            background: linear-gradient(to bottom, #FFD700, #FF9800);
            border: none;
            padding: 15px 30px;
            font-size: 1.3rem;
            border-radius: 50px;
            color: #8B4513;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            z-index: 21;
        }
        
        #startButton:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        #hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 10;
            text-align: center;
        }
        
        #soundToggle {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid white;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 15;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .boss-health {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 25px;
            background: #333;
            border-radius: 12px;
            overflow: hidden;
            z-index: 15;
            border: 3px solid #fff;
            display: none;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }

        .boss-health-bar {
            height: 100%;
            background: linear-gradient(to right, #ff0000, #ff6600, #ffcc00);
            width: 100%;
            transition: width 0.5s;
            position: relative;
        }

        .boss-health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 16;
            font-size: 14px;
        }

        .fire-warning {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: linear-gradient(to top, rgba(255, 0, 0, 0.3), transparent);
            z-index: 14;
            display: none;
            animation: warningPulse 0.5s infinite;
            text-align: center;
            padding-top: 15px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
        }

        @keyframes warningPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        .victory-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.4), rgba(255, 140, 0, 0.2));
            z-index: 30;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        .victory-title {
            font-size: 3.5rem;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
            color: #FFD700;
            animation: victoryBounce 1s ease-in-out infinite alternate;
        }

        .victory-image {
            width: 300px;
            height: 200px;
            object-fit: contain;
            margin: 20px 0;
            border: 3px solid #FFD700;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        @keyframes victoryBounce {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 40;
        }

        .progress-bar {
            width: 300px;
            height: 20px;
            background: #555;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }

        .instructions {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: left;
        }

        .instructions h3 {
            margin-bottom: 10px;
            color: #FFD700;
        }

        .instructions ul {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .fallback-shape {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Efecto de destello para el lobo */
        .boss-flash {
            animation: bossFlash 0.5s;
        }

        @keyframes bossFlash {
            0% { filter: brightness(1); }
            50% { filter: brightness(3); }
            100% { filter: brightness(1); }
        }

        @media (max-width: 850px) {
            .game-wrapper {
                height: 400px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            #ui {
                font-size: 14px;
                padding: 8px;
            }
            
            .boss-health {
                width: 300px;
            }
        }
    </style>
</head>
<body>
    <h1>üêª Oso Abrazos - Aventura Completa</h1>
    <p class="subtitle">¬°Ayuda al Oso Abrazos a recolectar corazones y derrotar al Lobo Feroz con el poder del Unicornio!</p>
    
    <div class="container">
        <div class="game-wrapper">
            <div id="gameContainer">
                <canvas id="gameCanvas" width="800" height="500"></canvas>

                <!-- UI del juego -->
                <div id="ui">
                    <div class="ui-item">‚≠ê Puntos: <span id="score">0</span></div>
                    <div class="ui-item">‚ù§Ô∏è Vidas: <span id="lives">3</span></div>
                    <div class="ui-item">üó∫Ô∏è Nivel: <span id="level">1-1</span></div>
                    <div id="unicornPower" class="ui-item" style="display: none;">
                        <span>ü¶Ñ Poder:</span>
                        <div class="power-bar">
                            <div class="power-level" id="unicornPowerLevel"></div>
                        </div>
                    </div>
                    <div id="heartsCollected" class="ui-item" style="display: none;">
                        <span>üíï Corazones: <span id="heartCount">0</span>/3</span>
                    </div>
                </div>

                <!-- Barra de salud del jefe -->
                <div id="bossHealth" class="boss-health">
                    <div class="boss-health-bar" id="bossHealthBar">
                        <div class="boss-health-text">üê∫ Lobo Feroz - Vida: <span id="bossHealthText">5/5</span></div>
                    </div>
                </div>

                <!-- Advertencia de ataque -->
                <div id="fireWarning" class="fire-warning">
                    ‚ö†Ô∏è ¬°CUIDADO! El lobo va a atacar con fuego ‚ö†Ô∏è
                </div>

                <div id="levelIndicator" class="level-indicator">Nivel 1-1</div>

                <!-- Pantalla de inicio -->
                <div id="startScreen">
                    <img id="coverImage" src="https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/oso_portada.png" alt="Portada del Juego">
                    <button id="startButton">üéÆ ¬°Comenzar Aventura!</button>
                </div>
                
                <!-- Pantalla de carga -->
                <div id="loadingScreen" class="loading-screen">
                    <h2>Cargando recursos del juego...</h2>
                    <div class="progress-bar">
                        <div class="progress" id="loadingProgress"></div>
                    </div>
                    <p id="loadingText">0%</p>
                </div>

                <!-- Pantalla de victoria -->
                <div id="victoryScreen" class="victory-animation">
                    <h2 class="victory-title">üéâ ¬°VICTORIA! üéâ</h2>
                    <img id="victoryImage" class="victory-image" src="https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/uniyosocombat.png" alt="Oso y Unicornio">
                    <p style="font-size: 1.5rem; margin: 10px 0;">¬°Has derrotado al Lobo Feroz!</p>
                    <p style="font-size: 1.2rem; margin: 10px 0;">Puntuaci√≥n final: <span id="finalScore">0</span></p>
                    <button id="restartButton" style="margin-top: 20px; padding: 12px 24px; font-size: 1.2rem; background: #4CAF50; color: white; border: none; border-radius: 50px; cursor: pointer;">üîÑ Jugar de nuevo</button>
                </div>
                
                <button id="soundToggle">üîä</button>
                
                <div id="hint">üí° Usa las flechas para moverte y la barra espaciadora para saltar</div>
            </div>
        </div>

        <div class="instructions">
            <h3>üéÆ Instrucciones:</h3>
            <ul>
                <li>‚û°Ô∏è Movimiento: Flechas izquierda/derecha</li>
                <li>‚¨ÜÔ∏è Salto: Flecha arriba o barra espaciadora</li>
                <li>ü§ó Abrazar: Mant√©n presionada la tecla Z</li>
                <li>ü¶Ñ Poder especial: Presiona X para activar el poder del unicornio (debes recolectar 3 corazones primero)</li>
                <li>üíï Recolecta 3 corazones para invocar al unicornio</li>
                <li>üê∫ Derrota al lobo en el nivel final para ganar</li>
            </ul>
        </div>
    </div>

    <script>
        // Variables globales
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('gameContainer');
        
        // URLs corregidas para im√°genes seg√∫n tu estructura de repositorio
        const imageUrls = {
            bear: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/oso_idle.svg',
            bearJump: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/oso_jump.svg',
            bearHug: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/oso_hugging.svg',
            wolf: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/lobo.svg',
            wolfAngry: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/loboferoz.png',
            wolfHurt: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/lobotriste.png',
            heart: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/lovepower.png',
            unicorn: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/unirshup.png',
            bearWithUnicorn: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/osoyuni.png',
            background1: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/fondos/bosque1.jpg',
            background2: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/fondos/bosque2.jpg',
            background3: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/fondos/bosque3.jpg',
            backgroundBoss: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/fondos/background%20final.jpeg',
            enemy1: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/Enemigos-01.svg',
            enemy2: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/Enemigos-02.svg',
            enemy3: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/Enemigos-03.svg',
            fireball: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/fire.png',
            squirrel: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/ardilla.png',
            rabbit: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/conejo.png',
            bird: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/pajarito.png',
            honey: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/miel.png'
        };

        // URLs para sonidos
        const soundUrls = {
            background: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/background.mp3.mp3',
            jump: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/jump.mp3.mp3',
            collect: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/collect.mp3.mp3',
            hug: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/hug.mp3.mp3',
            hurt: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/hurt.mp3.mp3',
            enemy: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/enemy.mp3.mp3',
            powerup: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/powerup.mp3.mp3',
            bossBattle: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/para%20la%20batalla.mp3',
            victory: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/power-up-game-sound-effect-359227.mp3'
        };

        // Variables de juego
        let player, enemies = [], hearts = [], platforms = [], friends = [], items = [], background;
        let keys = {};
        let score = 0;
        let lives = 3;
        let currentLevel = 1;
        let currentSubLevel = 1;
        let gameStarted = false;
        let heartsCollected = 0;
        let unicornPower = 0;
        let unicornActive = false;
        let bossHealth = 5;
        let bossMaxHealth = 5;
        let bossAttackTimer = 0;
        let bossFlashTimer = 0;
        let bossIsFlashing = false;
        let loadedResources = 0;
        let totalResources = Object.keys(imageUrls).length + Object.keys(soundUrls).length;
        let sounds = {};
        let images = {};

        // Inicializar el juego
        function init() {
            // Configurar eventos de teclado
            window.addEventListener('keydown', (e) => {
                keys[e.key] = true;
                
                // Saltar con espacio o flecha arriba
                if ((e.key === ' ' || e.key === 'ArrowUp') && player && player.grounded) {
                    player.velocityY = -15;
                    playSound('jump');
                }
                
                // Llamar al unicornio con la tecla 'X'
                if ((e.key === 'x' || e.key === 'X') && heartsCollected >= 3 && !unicornActive) {
                    activateUnicorn();
                }
                
                // Abrazar con la tecla 'Z'
                if ((e.key === 'z' || e.key === 'Z') && player && player.grounded) {
                    player.isHugging = true;
                    setTimeout(() => {
                        if (player) player.isHugging = false;
                    }, 500);
                    playSound('hug');
                    checkHug();
                }
            });
            
            window.addEventListener('keyup', (e) => {
                keys[e.key] = false;
            });
            
            // Configurar botones
            document.getElementById('startButton').addEventListener('click', startGame);
            document.getElementById('restartButton').addEventListener('click', restartGame);
            document.getElementById('soundToggle').addEventListener('click', toggleSound);
            
            // Cargar recursos
            loadResources();
        }
        
        // Cargar recursos
        function loadResources() {
            // Cargar im√°genes
            for (const [name, url] of Object.entries(imageUrls)) {
                const img = new Image();
                img.onload = () => {
                    loadedResources++;
                    updateLoadingProgress();
                    images[name] = img;
                };
                img.onerror = () => {
                    console.error(`Error al cargar la imagen: ${name}`);
                    loadedResources++;
                    updateLoadingProgress();
                    // Crear una imagen de respaldo b√°sica
                    images[name] = createFallbackImage(name);
                };
                img.src = url;
            }
            
            // Cargar sonidos
            for (const [name, url] of Object.entries(soundUrls)) {
                const audio = new Audio();
                audio.addEventListener('canplaythrough', () => {
                    loadedResources++;
                    updateLoadingProgress();
                    sounds[name] = audio;
                });
                audio.addEventListener('error', () => {
                    console.error(`Error al cargar el sonido: ${name}`);
                    loadedResources++;
                    updateLoadingProgress();
                });
                audio.src = url;
                audio.preload = 'auto';
            }
        }
        
        // Crear imagen de respaldo
        function createFallbackImage(name) {
            const canvas = document.createElement('canvas');
            canvas.width = 50;
            canvas.height = 50;
            const ctx = canvas.getContext('2d');
            
            // Dibujar forma b√°sica seg√∫n el tipo de imagen
            if (name.includes('bear')) {
                ctx.fillStyle = '#8B4513';
                ctx.beginPath();
                ctx.arc(25, 25, 20, 0, Math.PI * 2);
                ctx.fill();
            } else if (name.includes('wolf')) {
                ctx.fillStyle = '#808080';
                ctx.beginPath();
                ctx.arc(25, 25, 20, 0, Math.PI * 2);
                ctx.fill();
            } else if (name.includes('heart')) {
                ctx.fillStyle = '#FF69B4';
                ctx.beginPath();
                ctx.moveTo(25, 5);
                ctx.bezierCurveTo(45, 5, 45, 45, 25, 45);
                ctx.bezierCurveTo(5, 45, 5, 5, 25, 5);
                ctx.fill();
            } else {
                ctx.fillStyle = '#3498db';
                ctx.fillRect(0, 0, 50, 50);
            }
            
            const img = new Image();
            img.src = canvas.toDataURL();
            return img;
        }
        
        // Actualizar barra de progreso
        function updateLoadingProgress() {
            const progress = (loadedResources / totalResources) * 100;
            document.getElementById('loadingProgress').style.width = `${progress}%`;
            document.getElementById('loadingText').textContent = `${Math.round(progress)}%`;
            
            if (loadedResources >= totalResources) {
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 500);
            }
        }
        
        // Iniciar juego
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            gameStarted = true;
            resetGame();
            playSound('background', true);
            gameLoop();
        }
        
        // Reiniciar juego
        function resetGame() {
            // Reiniciar variables
            score = 0;
            lives = 3;
            heartsCollected = 0;
            unicornPower = 0;
            unicornActive = false;
            currentLevel = 1;
            currentSubLevel = 1;
            
            // Crear jugador
            player = {
                x: 100,
                y: 300,
                width: 60,
                height: 80,
                velocityX: 0,
                velocityY: 0,
                speed: 5,
                jumpForce: 15,
                grounded: false,
                image: images.bear,
                isJumping: false,
                isHugging: false
            };
            
            // Configurar nivel
            setupLevel(currentLevel, currentSubLevel);
            
            // Actualizar UI
            updateUI();
        }
        
        // Configurar nivel
        function setupLevel(level, subLevel) {
            // Limpiar arrays
            enemies = [];
            hearts = [];
            platforms = [];
            friends = [];
            items = [];
            
            // Configurar niveles
            if (level === 1) {
                // Nivel 1
                background = images.background1;
                
                if (subLevel === 1) {
                    // Nivel 1-1
                    createPlatform(0, 400, 800, 100);
                    createPlatform(200, 300, 100, 20);
                    createPlatform(500, 250, 100, 20);
                    
                    // Crear corazones
                    createHeart(250, 250);
                    createHeart(550, 200);
                    
                    // Crear amigos
                    createFriend(350, 330, 'squirrel');
                    createFriend(450, 330, 'rabbit');
                    
                    // Actualizar UI
                    document.getElementById('levelIndicator').textContent = 'Nivel 1-1: Introducci√≥n';
                    document.getElementById('heartsCollected').style.display = 'block';
                    document.getElementById('unicornPower').style.display = 'none';
                    document.getElementById('bossHealth').style.display = 'none';
                } else if (subLevel === 2) {
                    // Nivel 1-2
                    createPlatform(0, 400, 800, 100);
                    createPlatform(100, 300, 100, 20);
                    createPlatform(300, 250, 100, 20);
                    createPlatform(600, 300, 100, 20);
                    
                    // Crear enemigos
                    createEnemy(400, 330, 'normal');
                    
                    // Crear amigos
                    createFriend(200, 330, 'bird');
                    createFriend(500, 330, 'squirrel');
                    
                    // Crear miel
                    createItem(350, 250, 'honey');
                    
                    // Actualizar UI
                    document.getElementById('levelIndicator').textContent = 'Nivel 1-2: Encuentro con el lobo';
                }
            } else if (level === 2) {
                // Nivel 2
                background = images.backgroundBoss;
                
                if (subLevel === 1) {
                    // Nivel 2-1
                    createPlatform(0, 400, 800, 100);
                    createPlatform(150, 300, 100, 20);
                    createPlatform(350, 250, 100, 20);
                    createPlatform(550, 300, 100, 20);
                    
                    // Crear corazones
                    createHeart(200, 250);
                    createHeart(400, 200);
                    createHeart(600, 250);
                    
                    // Crear enemigos
                    createEnemy(300, 330, 'normal');
                    createEnemy(500, 330, 'normal');
                    
                    // Actualizar UI
                    document.getElementById('levelIndicator').textContent = 'Nivel 2-1: Preparaci√≥n para la batalla';
                } else if (subLevel === 2) {
                    // Nivel 2-2: Batalla con el lobo
                    createPlatform(0, 400, 800, 100);
                    createPlatform(200, 300, 400, 20);
                    
                    // Crear jefe (lobo)
                    createEnemy(400, 330, 'boss');
                    
                    // Cambiar m√∫sica
                    stopSound('background');
                    playSound('bossBattle', true);
                    
                    // Mostrar barra de salud del jefe
                    document.getElementById('bossHealth').style.display = 'block';
                    updateBossHealth();
                    
                    // Actualizar UI
                    document.getElementById('levelIndicator').textContent = 'Nivel 2-2: Batalla con el lobo';
                    document.getElementById('heartsCollected').style.display = 'none';
                    document.getElementById('unicornPower').style.display = 'block';
                }
            }
            
            // Actualizar indicador de nivel
            document.getElementById('level').textContent = `${level}-${subLevel}`;
        }
        
        // Crear plataforma
        function createPlatform(x, y, width, height) {
            platforms.push({ x, y, width, height });
        }
        
        // Crear coraz√≥n
        function createHeart(x, y) {
            hearts.push({
                x, y,
                width: 30,
                height: 30,
                collected: false,
                type: 'heart'
            });
        }
        
        // Crear amigo
        function createFriend(x, y, type) {
            let image;
            switch(type) {
                case 'squirrel':
                    image = images.squirrel;
                    break;
                case 'rabbit':
                    image = images.rabbit;
                    break;
                case 'bird':
                    image = images.bird;
                    break;
            }
            
            friends.push({
                x, y,
                width: 50,
                height: 50,
                type,
                image,
                hugged: false
            });
        }
        
        // Crear item
        function createItem(x, y, type) {
            items.push({
                x, y,
                width: 30,
                height: 30,
                type,
                collected: false,
                image: type === 'honey' ? images.honey : images.heart
            });
        }
        
        // Crear enemigo
        function createEnemy(x, y, type) {
            const enemy = {
                x, y,
                width: 60,
                height: 60,
                type,
                health: type === 'boss' ? bossMaxHealth : 1,
                speed: type === 'boss' ? 2 : 1,
                direction: 1,
                attackCooldown: 0,
                image: type === 'boss' ? images.wolf : images['enemy' + Math.floor(Math.random() * 3 + 1)]
            };
            
            if (type === 'boss') {
                enemy.width = 80;
                enemy.height = 80;
            }
            
            enemies.push(enemy);
        }
        
        // Activar unicornio
        function activateUnicorn() {
            unicornActive = true;
            unicornPower = 100;
            player.image = images.bearWithUnicorn;
            player.width = 72; // 20% m√°s grande
            player.height = 96; // 20% m√°s grande
            playSound('powerup');
            
            // Mostrar mensaje
            showHint('¬°Poder de unicornio activado! Ahora puedes derrotar al lobo', 3000);
            
            // Actualizar UI
            updateUnicornPower();
        }
        
        // Comprobar abrazos
        function checkHug() {
            for (const friend of friends) {
                if (
                    !friend.hugged &&
                    player.x < friend.x + friend.width &&
                    player.x + player.width > friend.x &&
                    player.y < friend.y + friend.height &&
                    player.y + player.height > friend.y
                ) {
                    friend.hugged = true;
                    score += 50;
                    playSound('collect');
                    updateUI();
                }
            }
        }
        
        // Actualizar UI
        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = lives;
            document.getElementById('heartCount').textContent = heartsCollected;
            document.getElementById('level').textContent = `${currentLevel}-${currentSubLevel}`;
            
            updateUnicornPower();
        }
        
        // Actualizar poder del unicornio
        function updateUnicornPower() {
            const powerLevel = document.getElementById('unicornPowerLevel');
            powerLevel.style.width = `${unicornPower}%`;
        }
        
        // Actualizar salud del jefe
        function updateBossHealth() {
            const healthBar = document.getElementById('bossHealthBar');
            const healthText = document.getElementById('bossHealthText');
            const healthPercent = (bossHealth / bossMaxHealth) * 100;
            
            healthBar.style.width = `${healthPercent}%`;
            healthText.textContent = `${bossHealth}/${bossMaxHealth}`;
        }
        
        // Reproducir sonido
        function playSound(soundName, loop = false) {
            if (sounds[soundName]) {
                const sound = sounds[soundName].cloneNode();
                sound.loop = loop;
                sound.volume = 0.7;
                sound.play().catch(e => console.log("Error reproduciendo sonido:", e));
                return sound;
            }
            return null;
        }
        
        // Detener sonido
        function stopSound(soundName) {
            if (sounds[soundName]) {
                sounds[soundName].pause();
                sounds[soundName].currentTime = 0;
            }
        }
        
        // Mostrar pista
        function showHint(text, duration) {
            const hint = document.getElementById('hint');
            hint.textContent = text;
            hint.style.opacity = '1';
            
            setTimeout(() => {
                hint.style.opacity = '0';
            }, duration);
        }
        
        // Alternar sonido
        function toggleSound() {
            const soundToggle = document.getElementById('soundToggle');
            if (sounds.background.paused) {
                sounds.background.play();
                soundToggle.textContent = 'üîä';
            } else {
                sounds.background.pause();
                soundToggle.textContent = 'üîá';
            }
        }
        
        // Bucle principal del juego
        function gameLoop() {
            if (!gameStarted) return;
            
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar fondo
            if (background && background.complete) {
                ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
            } else {
                // Fondo por defecto
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, "#87CEEB");
                gradient.addColorStop(1, "#E0F7FA");
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Actualizar y dibujar plataformas
            drawPlatforms();
            
            // Actualizar y dibujar jugador
            updatePlayer();
            drawPlayer();
            
            // Actualizar y dibujar enemigos
            updateEnemies();
            drawEnemies();
            
            // Actualizar y dibujar corazones
            updateHearts();
            drawHearts();
            
            // Actualizar y dibujar amigos
            updateFriends();
            drawFriends();
            
            // Actualizar y dibujar items
            updateItems();
            drawItems();
            
            // Comprobar colisiones
            checkCollisions();
            
            // Comprobar si se complet√≥ el nivel
            checkLevelCompletion();
            
            // Continuar el bucle
            requestAnimationFrame(gameLoop);
        }
        
        // Actualizar jugador
        function updatePlayer() {
            // Movimiento horizontal
            player.velocityX = 0;
            
            if (keys['ArrowLeft']) {
                player.velocityX = -player.speed;
            }
            
            if (keys['ArrowRight']) {
                player.velocityX = player.speed;
            }
            
            // Gravedad
            player.velocityY += 0.7;
            
            // Limitar velocidad vertical
            if (player.velocityY > 15) {
                player.velocityY = 15;
            }
            
            // Aplicar velocidad
            player.x += player.velocityX;
            player.y += player.velocityY;
            
            // Limitar al canvas
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
            if (player.y > canvas.height) {
                // El jugador cay√≥ al vac√≠o
                playerLoseLife();
            }
            
            // Comprobar colisi√≥n con plataformas
            player.grounded = false;
            for (const platform of platforms) {
                if (
                    player.x < platform.x + platform.width &&
                    player.x + player.width > platform.x &&
                    player.y + player.height > platform.y &&
                    player.y < platform.y + 10 &&
                    player.velocityY > 0
                ) {
                    player.y = platform.y - player.height;
                    player.velocityY = 0;
                    player.grounded = true;
                }
            }
            
            // Actualizar poder del unicornio
            if (unicornActive) {
                unicornPower -= 0.2;
                if (unicornPower <= 0) {
                    unicornActive = false;
                    player.image = images.bear;
                    player.width = 60;
                    player.height = 80;
                }
                updateUnicornPower();
            }
        }
        
        // Dibujar jugador
        function drawPlayer() {
            if (player.image && player.image.complete) {
                ctx.drawImage(player.image, player.x, player.y, player.width, player.height);
            } else {
                // Dibujar placeholder si la imagen no est√° cargada
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(player.x, player.y, player.width, player.height);
            }
        }
        
        // Actualizar enemigos
        function updateEnemies() {
            for (const enemy of enemies) {
                // Movimiento de los enemigos
                if (enemy.type === 'boss') {
                    // Movimiento del jefe
                    enemy.x += enemy.speed * enemy.direction;
                    
                    // Cambiar direcci√≥n al llegar a los l√≠mites
                    if (enemy.x < 100 || enemy.x > canvas.width - enemy.width - 100) {
                        enemy.direction *= -1;
                    }
                    
                    // Ataque del jefe
                    enemy.attackCooldown++;
                    if (enemy.attackCooldown >= 120) {
                        enemy.attackCooldown = 0;
                        
                        // Mostrar advertencia
                        document.getElementById('fireWarning').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('fireWarning').style.display = 'none';
                        }, 2000);
                    }
                    
                    // Efecto de destello
                    if (bossIsFlashing) {
                        bossFlashTimer++;
                        if (bossFlashTimer >= 30) {
                            bossIsFlashing = false;
                            bossFlashTimer = 0;
                            enemy.image = images.wolf;
                        }
                    }
                } else {
                    // Movimiento de enemigos normales
                    enemy.x += enemy.speed * enemy.direction;
                    
                    // Cambiar direcci√≥n al llegar a los l√≠mites
                    if (enemy.x < 0 || enemy.x > canvas.width - enemy.width) {
                        enemy.direction *= -1;
                    }
                }
            }
        }
        
        // Dibujar enemigos
        function drawEnemies() {
            for (const enemy of enemies) {
                if (enemy.image && enemy.image.complete) {
                    ctx.drawImage(enemy.image, enemy.x, enemy.y, enemy.width, enemy.height);
                } else {
                    // Dibujar placeholder si la imagen no est√° cargada
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                }
                
                // Dibujar barra de salud para el jefe
                if (enemy.type === 'boss') {
                    const barWidth = enemy.width;
                    const barHeight = 8;
                    const healthPercent = enemy.health / enemy.maxHealth;
                    
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(enemy.x, enemy.y - 15, barWidth, barHeight);
                    
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                    ctx.fillRect(enemy.x, enemy.y - 15, barWidth * healthPercent, barHeight);
                }
            }
        }
        
        // Actualizar corazones
        function updateHearts() {
            for (const heart of hearts) {
                // Animaci√≥n de flotaci√≥n
                heart.y += Math.sin(Date.now() / 500) * 0.5;
            }
        }
        
        // Dibujar corazones
        function drawHearts() {
            for (const heart of hearts) {
                if (!heart.collected) {
                    if (images.heart && images.heart.complete) {
                        ctx.drawImage(images.heart, heart.x, heart.y, heart.width, heart.height);
                    } else {
                        // Dibujar placeholder si la imagen no est√° cargada
                        ctx.fillStyle = '#FF69B4';
                        ctx.beginPath();
                        ctx.moveTo(heart.x + heart.width/2, heart.y);
                        ctx.bezierCurveTo(
                            heart.x + heart.width, heart.y,
                            heart.x + heart.width, heart.y + heart.height,
                            heart.x + heart.width/2, heart.y + heart.height
                        );
                        ctx.bezierCurveTo(
                            heart.x, heart.y + heart.height,
                            heart.x, heart.y,
                            heart.x + heart.width/2, heart.y
                        );
                        ctx.fill();
                    }
                }
            }
        }
        
        // Actualizar amigos
        function updateFriends() {
            for (const friend of friends) {
                // Animaci√≥n de flotaci√≥n
                friend.y += Math.sin(Date.now() / 500) * 0.5;
            }
        }
        
        // Dibujar amigos
        function drawFriends() {
            for (const friend of friends) {
                if (!friend.hugged && friend.image && friend.image.complete) {
                    ctx.drawImage(friend.image, friend.x, friend.y, friend.width, friend.height);
                }
            }
        }
        
        // Actualizar items
        function updateItems() {
            for (const item of items) {
                // Animaci√≥n de flotaci√≥n
                item.y += Math.sin(Date.now() / 500) * 0.5;
            }
        }
        
        // Dibujar items
        function drawItems() {
            for (const item of items) {
                if (!item.collected && item.image && item.image.complete) {
                    ctx.drawImage(item.image, item.x, item.y, item.width, item.height);
                }
            }
        }
        
        // Dibujar plataformas
        function drawPlatforms() {
            for (const platform of platforms) {
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                
                ctx.fillStyle = '#228B22';
                ctx.fillRect(platform.x, platform.y, platform.width, 10);
            }
        }
        
        // Comprobar colisiones
        function checkCollisions() {
            // Colisi√≥n con corazones
            for (const heart of hearts) {
                if (
                    !heart.collected &&
                    player.x < heart.x + heart.width &&
                    player.x + player.width > heart.x &&
                    player.y < heart.y + heart.height &&
                    player.y + player.height > heart.y
                ) {
                    heart.collected = true;
                    heartsCollected++;
                    score += 100;
                    playSound('collect');
                    updateUI();
                }
            }
            
            // Colisi√≥n con items
            for (const item of items) {
                if (
                    !item.collected &&
                    player.x < item.x + item.width &&
                    player.x + player.width > item.x &&
                    player.y < item.y + item.height &&
                    player.y + player.height > item.y
                ) {
                    item.collected = true;
                    score += 50;
                    playSound('collect');
                    updateUI();
                }
            }
            
            // Colisi√≥n con enemigos
            for (const enemy of enemies) {
                if (
                    player.x < enemy.x + enemy.width &&
                    player.x + player.width > enemy.x &&
                    player.y < enemy.y + enemy.height &&
                    player.y + player.height > enemy.y
                ) {
                    // El jugador est√° atacando con el poder del unicornio
                    if (unicornActive) {
                        playSound('enemy');
                        enemy.health--;
                        
                        if (enemy.type === 'boss') {
                            bossHealth = enemy.health;
                            updateBossHealth();
                            
                            // Efecto de destello
                            bossIsFlashing = true;
                            enemy.image = images.wolfHurt;
                            
                            // Cambiar a forma enfurecida
                            if (bossHealth <= 3 && enemy.image !== images.wolfAngry) {
                                enemy.image = images.wolfAngry;
                                enemy.speed = 3;
                                
                                // Efecto de destello grande
                                gameContainer.classList.add('boss-flash');
                                setTimeout(() => {
                                    gameContainer.classList.remove('boss-flash');
                                }, 500);
                            }
                        }
                        
                        if (enemy.health <= 0) {
                            // Eliminar enemigo
                            const index = enemies.indexOf(enemy);
                            if (index > -1) {
                                enemies.splice(index, 1);
                            }
                            
                            score += enemy.type === 'boss' ? 500 : 200;
                            updateUI();
                        }
                    } else {
                        // El jugador es golpeado
                        playerLoseLife();
                    }
                }
            }
        }
        
        // El jugador pierde una vida
        function playerLoseLife() {
            lives--;
            playSound('hurt');
            updateUI();
            
            if (lives <= 0) {
                // Game over
                gameOver();
            } else {
                // Reiniciar posici√≥n
                player.x = 100;
                player.y = 300;
                player.velocityX = 0;
                player.velocityY = 0;
            }
        }
        
        // Comprobar si se complet√≥ el nivel
        function checkLevelCompletion() {
            // Completar nivel 1-1: recolectar 2 corazones
            if (currentLevel === 1 && currentSubLevel === 1 && heartsCollected >= 2) {
                nextLevel();
            }
            
            // Completar nivel 1-2: derrotar al lobo
            if (currentLevel === 1 && currentSubLevel === 2 && enemies.length === 0) {
                nextLevel();
            }
            
            // Completar nivel 2-1: recolectar 3 corazones
            if (currentLevel === 2 && currentSubLevel === 1 && heartsCollected >= 3) {
                nextLevel();
            }
            
            // Completar nivel 2-2: derrotar al lobo jefe
            if (currentLevel === 2 && currentSubLevel === 2 && enemies.length === 0) {
                victory();
            }
        }
        
        // Pasar al siguiente nivel
        function nextLevel() {
            if (currentSubLevel < 2) {
                currentSubLevel++;
            } else {
                currentLevel++;
                currentSubLevel = 1;
            }
            
            setupLevel(currentLevel, currentSubLevel);
        }
        
        // Victoria
        function victory() {
            gameStarted = false;
            stopSound('bossBattle');
            playSound('victory');
            
            // Mostrar pantalla de victoria
            document.getElementById('victoryScreen').style.display = 'flex';
            document.getElementById('finalScore').textContent = score;
        }
        
        // Game over
        function gameOver() {
            gameStarted = false;
            
            // Mostrar pantalla de inicio
            document.getElementById('startScreen').style.display = 'flex';
        }
        
        // Reiniciar juego
        function restartGame() {
            document.getElementById('victoryScreen').style.display = 'none';
            startGame();
        }
        
        // Iniciar cuando se carga la p√°gina
        window.addEventListener('load', init);
    </script>
</body>
</html>
