<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oso Abrazos - Aventura Completa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }
        
        body {
            background: linear-gradient(to bottom, #6a11cb, #2575fc);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            touch-action: manipulation;
            -webkit-overflow-scrolling: touch;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
        }
        
        h1 {
            font-size: 2.8rem;
            text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5);
            color: #FFD700;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .subtitle {
            font-size: 1.3rem;
            margin-bottom: 25px;
            text-align: center;
            line-height: 1.5;
        }
        
        .game-wrapper {
            position: relative;
            width: 100%;
            height: 500px;
            margin-bottom: 30px;
        }
        
        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
            border: 5px solid #FFD700;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: ÊûÅ 0 30px rgba(0, 0, 0, 0.6);
        }
        
        #gameCanvas {
            display: block;
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            width: 100%;
            height: 100%;
        }
        
        #ui {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 12px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 16px;
            z-index: 10;
            min-width: 180px;
        }
        
        .ui-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .power-bar {
            width: 100px;
            height: 12px;
            background: #444;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .power-level {
            height: 100%;
            background: linear-gradient(to right, #FF69B4, #FF1493);
            width: 100%;
            border-radius: 8px;
            transition: width 0.3s;
        }
        
        #levelIndicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 10;
        }
        
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        
        #coverImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        
        #startButton {
            position: absolute;
            bottom: 40px;
            background: linear-gradient(to bottom, #FFD700, #FF9800);
            border: none;
            padding: 15px 30px;
            font-size: 1.3rem;
            border-radius: 50px;
            color: #8B4513;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, ÊûÅ);
            transition: all 0.3s;
            z-index: 21;
        }
        
        #startButton:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        #hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 10;
            text-align: center;
        }
        
        #soundToggle {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid white;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 15;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .boss-health {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 25px;
            background: #333;
           ÊûÅ-radius: 12px;
            overflow: hidden;
            z-index: 15;
            border: 3px solid #fff;
            display: none;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }

        .boss-health-bar {
            height: 100%;
            background: linear-gradient(to right, #ff0000, #ff6600, #ffcc00);
            width: 100%;
            transition: width 0.5s;
            position: relative;
        }

        .boss-health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 16;
            font-size: 14px;
        }

        .fire-warning {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: linear-gradient(to top, rgba(255, 0, ÊûÅ, 0.3), transparent);
            z-index: 14;
            display: none;
            animation: warningPulse 0.5s infinite;
            text-align: center;
            padding-top: 15px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
        }

        @keyframes warningPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        .victory-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: ÊûÅ%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.4), rgba(255, 140, 0, 0.2));
            z-index: 30;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        .victory-title {
            font-size: 3.5rem;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
            color: #FFD700;
            animation: victoryBounce 1s ease-in-out infinite alternate;
        }

        .victory-image {
            width: 300px;
            height: 200px;
            object-fit: contain;
            margin: 20px 0;
            border: 3px solid #FFD700;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        @keyframes victoryBounce {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 40;
        }

        .progress-bar {
            width: 300px;
            height: 20px;
            background: #555;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

ÊûÅ .progress {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }

        /* Controles tipo PlayStation */
        .playstation-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
            padding: 0 10px;
        }

        .d-pad {
            width: 120px;
            height: 120px;
            position: relative;
        }

        .d-pad-button {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .d-pad-up {
            top: 0;
            left: 40px;
        }

        .d-pad-down {
            bottom: 0;
            left: 40px;
        }

        .d-pad-left {
            top: 40px;
            left: 0;
        }

        .d-pad-right {
            top: 40px;
            right: 0;
        }

        .action-buttons {
            width: 120px;
            height: 120px;
            position: relative;
        }

        .action-button {
            position: absolute;
            width: 50px;
            height: 50ÊûÅ;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            color: white;
            font-weight: bold;
        }

        .action-button-x {
            top: 0;
            left: 35px;
            background: #4CAF50;
        }

        .action-button-circle {
            bottom: 0;
            left: 35px;
            background: #FF5252;
        }

        .action-button-square {
            top: 35px;
            left: 0;
            background: #2196F3;
        }

        .action-button-triangle {
            top: 35px;
            right: 0;
            background: #FFD700;
            color: #333;
        }

        /* Efecto de destello para el lobo */
        .boss-flash {
            animation: bossFlash 0.5s;
        }

        @keyframes bossFlash {
            0% { filter: brightness(1); }
            50% { filter: brightness(3); }
            100% { filter: brightness(1); }
        }

        @media (max-width: 850px) {
            .game-wrapper {
                height: 400px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            #ui {
                font-size: 14px;
                padding: 8px;
            }
            
            .boss-health {
                width: 300px;
            }
            
            .d-pad, .action-buttons {
                transform: scale(0.8);
            }
        }
    </style>
</head>
<body>
    <h1>üêª Oso Abrazos - Aventura Completa</h1>
    <p class="subtitle">¬°Ayuda al Oso Abrazos a recolectar corazones y derrotar al Lobo Feroz con el poder del Unicornio!</p>
    
    <div class="container">
        <div class="game-wrapper">
            <div id="gameContainer">
                <canvas id="gameCanvas" width="800" height="500"></canvas>

                <!-- UI del juego -->
                <div id="ui">
                    <div class="ui-item">‚≠ê Puntos: <span id="score">0</span></div>
                    <div class="ui-item">‚ù§Ô∏è Vidas: <spanÊûÅ="lives">3</span></div>
                    <div class="ui-item">üó∫Ô∏è Nivel: <span id="level">1-1</span></div>
                    <div id="unicornPower" class="ui-item" style="display: none;">
                        <span>ü¶Ñ Poder:</span>
                        <div class="power-bar">
                            <div class="power-level" id="unicornPowerLevel"></div>
                        </div>
                    </div>
                    <div id="heartsCollected" class="ui-item" style="display: none;">
                        <span>üíï Corazones: <span id="heartCount">0</span>/3</span>
                    </div>
                </div>

                <!-- Barra de salud del jefe -->
                <div id="bossHealth" class="boss-health">
                    <div class="boss-health-bar" id="bossHealthBar">
                        <div class="boss-health-text">üê∫ Lobo Feroz - Vida: <span id="bossHealthText">5/5</span></div>
                    </div>
                </div>

                <!-- Advertencia de ataque -->
                <div id="fireWarning" class="fire-warning">
                    ‚ö†Ô∏è ¬°CUIDADO! El lobo va a atacar con fuego ‚ö†Ô∏è
                </div>

                <div id="levelIndicator" class="level-indicator">Nivel 1-1</div>

                <!-- Pantalla de inicio -->
                <div id="startScreen">
                    <img id="coverImage" src="https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/oso_portada.png" alt="Portada del Juego">
                    <button id="startButton">üéÆ ¬°Comenzar Aventura!</button>
                </div>
                
                <!-- Pantalla de carga -->
                <div id="loadingScreen" class="loading-screen">
                    <h2>Cargando recursos del juego...</h2>
                    <div classÊûÅ="progress-bar">
                        <div class="progress" id="loadingProgress"></div>
                    </div>
                    <p id="loadingText">0%</p>
                </div>

                <!-- Pantalla de victoria -->
                <div id="victoryScreen" class="victory-animation">
                    <h2 class="victory-title">üéâ ¬°VICTORIA! üéâ</h2>
                    <img id="victoryImage" class="victory-image" src="https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/uniyosocombat.png" alt="Oso y Unicornio">
                    <p style="font-size: 1.5rem; margin: 10px 0;">¬°Has derrotado al Lobo Feroz!</p>
                    <p style="font-size: 1.2rem; margin: 10px 0;">Puntuaci√≥n final: <span id="finalScore">0</span></p>
                    <button id="restartButton" style="margin-top: 20px; padding: 12px 24px; font-size: 1.2rem; background: #4CAF50; color: white; border: none; border-radius: 50px; cursor: pointer;">üîÑ Jugar de nuevo</button>
                </div>
                
                <button id="soundToggle">üîä</button>
                
                <div id="hint">üí° Usa los controles para moverte y abrazar a tus amigos</div>
            </div>
        </div>

        <!-- Controles tipo PlayStation -->
        <div class="playstation-controls">
            <div class="d-pad">
                <div class="d-pad-button d-pad-up" id="upBtn">‚Üë</div>
                <div class="d-pad-button d-pad-down" id="downBtn">‚Üì</div>
                <div class="d-pad-button d-pad-left" id="leftBtn">‚Üê</div>
                <div class="d-pad-button d-pad-right" id="rightBtn">‚Üí</div>
            </div>
            
            <div class="action-buttons">
                <div class="action-button action-button-x" id="jumpBtn">SALTAR</div>
                <div class="action-button action-button-circle" id="hugBtn">ABRAZAR</div>
                <div class="action-button action-button-square" id="unicornBtn">UNICORNIO</div>
                <div class="action-button action-button-triangle" id="actionBtn">DISPARAR</div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('gameContainer');
        
        // URLs corregidas para im√°genes seg√∫n tu estructura de repositorio
        const imageUrls = {
            bear: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/oso_idle.svg',
            bearJump: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/oso_jump.svg',
            bearHug: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/oso_hugging.svg',
            wolf: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/lobo.svg',
            wolfAngry: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/loboferoz.png',
            wolfHurt: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/lobotriste.png',
            heart: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/lovepower.png',
            unicorn: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/unirshup.png',
            bearWithUnicorn: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/osoyuni.png',
            background1: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/fondos/bosque1.jpg',
            background2: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/fondos/bosque2.jpg',
            background3: 'ÊûÅ://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/fondos/bosque3.jpg',
            background4: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/fondos/bosque4.jpg',
            background5: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/fondos/background_1_2.jpeg',
            backgroundBoss: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/fondos/background%20final.jpeg',
            enemy1: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/Enemigos-01.svg',
            enemy2: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/Enemigos-02.svg',
            enemy3: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/Enemigos-03.svg',
            fireball: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/enemigos/fire.png',
            squirrel: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/ardilla.png',
            rabbit: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/conejo.png',
            bird: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/pajarito.png',
            honey: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/miel.png'
        };

        // URLs para sonidos
        const soundUrls = {
            background: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/background.mp3.mp3',
            jump: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/jump.mp3.mp3',
            collect: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/collect.mp3.mp3',
            hug: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/hug.mp3.mp3',
            hurt: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/hurt.mp3.mp3',
            enemy: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/enemy.mp3.mp3',
            powerup: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/powerup.mp3ÊûÅ',
            bossBattle: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/para%20la%20batalla.mp3',
            victory: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/power-up-game-sound-effect-359227.mp3',
            shoot: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/shot.mp3.mp3'
        };

        // Variables de juego
        let player, enemies = [], hearts = [], platforms = [], friends = [], items = [], projectiles = [], background;
        let keys = {};
        let score = 0;
        let lives = 3;
        let currentLevel = 1;
        let currentSubLevel = 1;
        let gameStarted = false;
        let heartsCollected = 0;
        let unicornPower = 0;
        let unicornActive = false;
        let bossHealth = 5;
        let bossMaxHealth = 5;
        let bossAttackTimer = 0;
        let bossFlashTimer = 0;
        let bossIsFlashing = false;
        let loadedResources = 0;
        let totalResources = Object.keys(imageUrls).length + Object.keys(soundUrls).length;
        let sounds = {};
        let images = {};
        let shootCooldown = 0;

        // Inicializar el juego
        function init() {
            // Configurar eventos de teclado
            window.addEventListener('keydown', (e) => {
                keys[e.key] = true;
                
                // Saltar con espacio o flecha arriba
                if ((e.key === ' ' || e.key === 'ArrowUp') && player && player.grounded) {
                    player.velocityY = -15;
                    playSound('jump');
                }
                
                // Llamar al unicornio con la tecla 'X'
                if ((e.key === 'x' || e.key === 'X') && heartsCollected >= 3 && !unicornActive) {
                    activateUnicorn();
                }
                
                // Abrazar con la tecla 'Z'
                if ((e.key === 'z' || e.key === 'Z') && player && player.grounded) {
                    player.isHugging = true;
                    setTimeout(() => {
                        if (player) player.isHugging = false;
                    }, 500);
                    playSound('hug');
                    checkHug();
                }
                
                // Disparar con la tecla 'C'
                if ((e.key === 'c' || e.key === 'C') && unicornActive && shootCooldown <= 0) {
                    shootHeart();
                }
            });
            
            window.addEventListener('keyup', (e) => {
                keys[e.key] = false;
            });
            
            // Configurar botones
            document.getElementById('startButton').addEventListener('click', startGame);
            document.getElementById('restartButton').addEventListener('click', restartGame);
            document.getElementById('soundToggle').addEventListener('click', toggleSound);
            
            // Configurar controles t√°ctiles
            setupTouchControls();
            
            // Cargar recursos
            loadResources();
        }
        
        // Configurar controles t√°ctiles
        function setupTouchControls() {
            // Botones de direcci√≥n
            const upBtn = document.getElementById('upBtn');
            const downBtn = document.getElementById('downBtn');
            const leftBtn = document.getElementById('leftBtn');
            const rightBtn = document.getElementById('rightBtn');
            
            // Botones de acci√≥n
            const jumpBtn = document.getElementById('jumpBtn');
            const hugBtn = document.getElementById('hugBtn');
            const unicornBtn = document.getElementById('unicornBtn');
            const actionBtn = document.getElementById('actionBtn');
            
            // Eventos para botones de direcci√≥n
            const handleDirectionStart = (direction) => {
                return (e) => {
                    e.preventDefault();
                    keys[direction] = true;
                };
            };
            
            const handleDirectionEnd = (direction) => {
                return (e) => {
                    e.preventDefault();
                    keys[direction] = false;
                };
            };
            
            // Configurar eventos t√°ctiles para botones de direcci√≥n
            upBtn.addEventListener('touchstart', handleDirectionStart('ArrowUp'));
            upBtn.addEventListener('touchend', handleDirectionEnd('ArrowUp'));
            upBtn.addEventListener('mousedown', handleÊûÅStart('ArrowUp'));
            upBtn.addEventListener('mouseup', handleDirectionEnd('ArrowUp'));
            upBtn.addEventListener('mouseleave', handleDirectionEnd('ArrowUp'));
            
            downBtn.addEventListener('touchstart', handleDirectionStart('ArrowDown'));
            downBtn.addEventListener('touchend', handleDirectionEnd('ArrowDown'));
            downBtn.addEventListener('mousedown', handleDirectionStart('ArrowDown'));
            downBtn.addEventListener('mouseup', handleDirectionEnd('ArrowDown'));
            downBtn.addEventListener('mouseleave', handleDirectionEnd('ArrowDown'));
            
            leftBtn.addEventListener('touchstart', handleDirectionStart('ArrowLeft'));
            leftBtn.addEventListener('touchend', handleDirectionEnd('ArrowLeft'));
            leftBtn.addEventListener('mousedown', handleDirectionStart('ArrowLeft'));
            leftBtn.addEventListener('mouseup', handleDirectionEnd('ArrowLeft'));
            leftBtn.addEventListener('mouseleave', handleDirectionEnd('ArrowLeft'));
            
            rightBtn.addEventListener('touchstart', handleDirectionStart('ArrowRight'));
            rightBtn.addEventListener('touchend', handleDirectionEnd('ArrowRight'));
            rightBtn.addEventListener('mousedown', handleDirectionStart('ArrowRight'));
            rightBtn.addEventListener('mouseup', handleDirectionEnd('ArrowRight'));
            rightBtn.addEventListener('mouseleave', handleDirectionEnd('ArrowRight'));
            
            // Configurar eventos para botones de acci√≥n
            jumpBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (player && player.grounded) {
                    player.velocityY = -15;
                    playSound('jump');
                }
            });
            
            jumpBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                if (player && player.grounded) {
                    player.velocityY = -15;
                    playSound('jump');
                }
            });
            
            hugBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (player && player.grounded) {
                    player.isHugging = true;
                    setTimeout(() => {
                        if (player) player.isHugging = false;
                    }, 500);
                    playSound('hug');
                    checkHug();
                }
            });
            
            hugBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                if (player && player.grounded) {
                    player.isHugging = true;
                    setTimeout(() => {
                        if (player) player.isHugging = false;
                    }, 500);
                    playSound('hug');
                    checkHug();
                }
            });
            
            unicornBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (heartsCollected >= 3 && !unicornActive) {
                    activateUnicorn();
                }
            });
            
            unicornBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                if (heartsCollected >= 3 && !unicornActive) {
                    activateUnicorn();
                }
            });
            
            actionBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (unicornActive && shootCooldown <= 0) {
                    shootHeart();
                }
            });
            
            actionBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                if (unicornActive && shootCooldown <= 0) {
                    shootHeart();
                }
            });
        }
        
        // Cargar recursos
        function loadResources() {
            // Cargar im√°genes
            for (const [name, url] of Object.entries(imageUrls)) {
                const img = new Image();
                img.onload = () => {
                    loadedResources++;
                    updateLoadingProgress();
                    images[name] = img;
                };
                img.onerror = () => {
                    console.error(`Error al cargar la imagen: ${name}`);
                    loadedResources++;
                    updateLoadingProgress();
                    // Crear una imagen de respaldo b√°sica
                    images[name] = createFallbackImage(name);
                };
                img.src = url;
            }
            
            // Cargar sonidos
            for (const [name, url] of Object.entries(soundUrls)) {
                const audio = new Audio();
                audio.addEventListener('canplaythrough', () => {
                    loadedResources++;
                    updateLoadingProgress();
                    sounds[name] = audio;
                });
                audio.addEventListener('error', () => {
                    console.error(`Error al cargar el sonido: ${name}`);
                    loadedResources++;
                    updateLoadingProgress();
                });
                audio.src = url;
                audio.preload = 'auto';
            }
        }
        
        // Crear imagen de respaldo
        function createFallbackImage(name) {
            const canvas = document.createElement('canvas');
            canvas.width = 50;
            canvas.height = 50;
            const ctx = canvas.getContext('2d');
            
            // Dibujar forma b√°sica seg√∫n el tipo de imagen
            if (name.includes('bear')) {
                ctx.fillStyle = '#8B4513';
                ctx.beginPath();
                ctx.arc(25, 25, 20, 0, Math.PI * 2);
                ctx.fill();
            } else if (name.includes('wolf')) {
                ctx.fillStyle = '#808080';
                ctx.beginPath();
                ctx.arc(25, 25, 20, 0, Math.PI * 2);
                ctx.fill();
            } else if (name.includes('heart')) {
                ctx.fillStyle = '#FF69B4';
                ctx.beginPath();
                ctx.moveTo(25, 5);
                ctx.bezierCurveTo(45, 5, 45, 45, 25, 45);
                ctx.bezierCurveTo(5, 45, 5, 5, 25, 5);
                ctx.fill();
            } else {
                ctx.fillStyle = '#3498db';
                ctx.fillRect(0, 0, 50, 50);
            }
            
            const img = new Image();
            img.src = canvas.toDataURL();
            return img;
        }
        
        // Actualizar barra de progreso
        function updateLoadingProgress() {
            const progress = (loadedResources / totalResourcesÊûÅ) * 100;
            document.getElementById('loadingProgress').style.width = `${progress}%`;
            document.getElementById('loadingText').textContent = `${Math.round(progress)}%`;
            
            if (loadedResources >= totalResources) {
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 500);
            }
        }
        
        // Iniciar juego
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            gameStarted = true;
            resetGame();
            playSound('background', true);
            gameLoop();
        }
        
        // Reiniciar juego
        function resetGame() {
            // Reiniciar variables
            score = 0;
            lives = 3;
            heartsCollected = 0;
            unicornPower = 0;
            unicornActive = false;
            currentLevel = 1;
            currentSubLevel = 1;
            projectiles = [];
            
            // Crear jugador
            player = {
                x: 100,
                y: 300,
                width: 60,
                height: 80,
                velocityX: 0,
                velocityY: 0,
                speed: 5,
                jumpForce: 15,
                grounded: false,
                image: images.bear,
                isJumping: false,
                isHugging: false,
                direction: 1, // 1 = derecha, -1 = izquierda
                invincible: 0 // Tiempo de invencibilidad despu√©s de recibir da√±o
            };
            
            // Configurar nivel
            setupLevel(currentLevel, currentSubLevel);
            
            // Actualizar UI
            updateUI();
        }
        
        // Configurar nivel
        function setupLevel(level, subLevel) {
            // Limpiar arrays
            enemies = [];
            hearts = [];
            platforms = [];
            friends = [];
            items = [];
            projectiles = [];
            
            // Configurar niveles
            if (level === 1) {
                if (subLevel === 1) {
                    // Nivel 1-1 - 3 corazones para poder avanzar
                    background = images.background1;
                    createPlatform(0, 400, 800, 100);
                    createPlatform(200, 300, 100, 20);
                    createPlatform(500, 250, 100, 20);
                    
                    // Crear 3 corazones (para poder activar el unicornio)
                    createHeart(250, 250);
                    createHeart(400, 200);
                    createHeart(550, 200);
                    
                    // Crear amigos (todos deben ser abrazados para avanzar)
                    createFriend(350, 330, 'squirrel');
                    createFriend(450, 330, 'rabbit');
                    createFriend(550, 330, 'bird');
                    
                    // Actualizar UI
                    document.getElementById('levelIndicator').textContent = 'Nivel 1-1: Introducci√≥n';
                    document.getElementById('heartsCollected').style.display = 'block';
                    document.getElementById('unicornPower').style.display = 'none';
                    document.getElementById('bossHealth').style.display = 'none';
                } else if (subLevel === 2) {
                    // Nivel 1-2
                    background = images.background2;
                    createPlatform(0, 400, 800, 100);
                    createPlatform(100, 300, 100, 20);
                    createPlatform(300, 250, 100, 20);
                    createPlatform(600, 300, 100, 20);
                    
                    // Crear enemigos
                    createEnemy(400, 330, 'normal');
                    
                    // Crear amigos
                    createFriend(200, 330, 'bird');
                    createFriend(500, 330, 'squirrel');
                    createFriend(650, 330, 'rabbit');
                    
                    // Crear miel
                    createItem(350, 250, 'honey');
                    
                    // Actualizar UI
                    document.getElementById('levelIndicator').textContent = 'Nivel 1-2: Encuentro con el lobo';
                } else if (subLevel === 3) {
                    // Nivel 1-3
                    background = images.background3;
                    createPlatform(0, 400, 800, 100);
                    createPlatform(150, 300, 100, 20);
                    createPlatform(350, 250, 100, 20);
                    createPlatform(550, 300, 100, 20);
                    
                    // Crear enemigos
                    createEnemy(300, 330, 'normal');
                    createEnemy(500, 330, 'normal');
                    
                    // Crear amigos
                    createFriend(200, 330, 'squirrel');
                    createFriend(400, 330, 'rabbit');
                    createFriend(600, 330, 'bird');
                    
                    // Crear corazones
                    createHeart(250, 250);
                    createHeart(450, 200);
                    
                    // Actualizar UI
                    document.getElementById('levelIndicator').textContent = 'Nivel 1-3: Cueva Misteriosa';
                }
            } else if (level === 2) {
                if (subLevel === 1) {
                    // Nivel 2-1
                    background = images.background4;
                    createPlatform(0, 400, 800, 100);
                    createPlatform(150, 300, 100, 20);
                    createPlatform(350, 250, 100, 20);
                    createPlatform(550, 300, 100, 20);
                    
                    // Crear corazones
                    createHeart(200, 250);
                    createHeart(400, 200);
                    createHeart(600, 250);
                    
                    // Crear enemigos
                    createEnemy(300, 330, 'normal');
                    createEnemy(500, 330, 'normal');
                    
                    // Crear amigos
                    createFriend(250, 330, 'squirrel');
                    createFriend(450, 330, 'rabbit');
                    createFriend(650, 330, 'bird');
                    
                    // Actualizar UI
                    document.getElementById('levelIndicator').textContent = 'Nivel 2-1: Monta√±as Altas';
                } else if (subLevel === 2) {
                    // Nivel 2-2
                    background = images.background5;
                    createPlatform(0, 400, 800, 100);
                    createPlatform(200, 300, 400, 20);
                    createPlatform(600, 300, 100, 20);
                    
                    // Crear enemigos
                    createEnemy(300, 330, 'normal');
                    createEnemy(500, 330, 'normal');
                    createEnemy(650, 330, 'normal');
                    
                    // Crear amigos
                    createFriend(250, 330, 'rabbit');
                    createFriend(450, 330, 'bird');
                    
                    // Actualizar UI
                    document.getElementById('levelIndicator').textContent = 'Nivel 2-2: Cascada Brillante';
                } else if (subLevel === 3) {
                    // Nivel 2-3: Batalla con el lobo
                    background = images.backgroundBoss;
                    createPlatform(0, 400, 800, 100);
                    createPlatform(200, 300, 400, 20);
                    
                    // Crear jefe (lobo)
                    createEnemy(400, 330, 'boss');
                    
                    // Cambiar m√∫sica
                    stopSound('background');
                    playSound('bossBattle', true);
                    
                    // Mostrar barra de salud del jefe
                    document.getElementById('bossHealth').style.display = 'block';
                    updateBossHealth();
                    
                    // Actualizar UI
                    document.getElementById('levelIndicator').textContent = 'Nivel 2-3: Guarida del Lobo';
                    document.getElementById('heartsCollected').style.display = 'none';
                    document.getElementById('unicornPower').style.display = 'block';
                }
            }
            
            // Actualizar indicador de nivel
            document.getElementById('level').textContent = `${level}-${subLevel}`;
        }
        
        // Crear plataforma
        function createPlatform(x, y, width, height) {
            platforms.push({ x, y, width, height });
        }
        
        // Crear coraz√≥n
        function createHeart(x, y) {
            hearts.push({
                x, y,
                width: 30,
                height: 30,
                collected: false,
                type: 'heart'
            });
        }
        
        // Crear amigo
        function createFriend(x, y, type) {
            let image;
            switch(type) {
                case 'squirrel':
                    image = images.squirrel;
                    break;
                case 'rabbit':
                    image = images.rabbit;
                    break;
                case 'bird':
                    image = images.bird;
                    break;
            }
            
            friends.push({
                x, y,
                width: 50,
                height: 50,
                type,
                image,
                hugged: false
            });
        }
        
        // Crear item
        function createItem(x, y, type) {
            items.push({
                x, y,
                width: 30,
                height: 30,
                type,
                collected: false,
                image: type === 'honey' ? images.honey : images.heart
            });
        }
        
        // Crear enemigo
        function createEnemy(x, y, type) {
            const enemy = {
                x, y,
                width: 60,
                height: 60,
                type,
                health: type === 'boss' ? bossMaxHealth : 1,
                speed: type === 'boss' ? 2 : 1,
                direction: 1,
                attackCooldown: 0,
                image: type === 'boss' ? images.wolf : images['enemy' + Math.floor(Math.random() * 3 + 1)]
            };
            
            if (type === 'boss') {
                enemy.width = 80;
                enemy.height = 80;
            }
            
            enemies.push(enemy);
        }
        
        // Activar unicornio
        function activateUnicorn() {
            unicornActive = true;
            unicornPower = 100;
            player.image = images.bearWithUnicorn;
            player.width = 72; // 20% m√°s grande
            player.height = 96; // 20% m√°s grande
            playSound('powerup');
            
            // Mostrar mensaje
            showHint('¬°Poder de unicornio activado! Ahora puedes disparar corazones', 3000);
            
            // Actualizar UI
            updateUnicornPower();
        }
        
        // Disparar coraz√≥n
        function shootHeart() {
            if (unicornActive && unicornPower >= 10 && shootCooldown <= 0) {
                playSound('shoot');
                
                // Crear proyectil (coraz√≥n)
                projectiles.push({
                    x: player.x + player.width/2,
                    y: player.y + player.height/2,
                    width: 20,
                    height: 20,
                    speed: 10,
                    direction: player.direction,
                    active: true
                });
                
                // Reducir poder del unicornio
                unicornPower -= 10;
                updateUnicornPower();
                
                // Establecer cooldown
                shootCooldown = 20;
                
                // Si el poder se agota, desactivar unicornio
                if (unicornPower <= 0) {
                    unicornActive = false;
                    player.image = images.bear;
                    player.width = 60;
                    player.height = 80;
                }
            }
        }
        
        // Comprobar abrazos
        function checkHug() {
            let allHugged = true;
            
            for (const friend of friends) {
                if (
                    !friend.hugged &&
                    player.x < friend.x + friend.width &&
                    player.x + player.width > friend.x &&
                    player.y < friend.y + friend.height &&
                    player.y + player.height > friend.y
                ) {
                    friend.hugged = true;
                    score += 50;
                    playSound('collect');
                    updateUI();
                }
                
                if (!friend.hugged) {
                    allHugged = false;
                }
            }
            
            // Si todos los amigos han sido abrazados, avanzar de nivel
            if (allHugged && friends.length > 0) {
                setTimeout(() => {
                    nextLevel();
                }, 1000);
            }
        }
        
        // Actualizar UI
        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = lives;
            document.getElementById('heartCount').textContent = heartsCollected;
            document.getElementById('level').textContent = `${currentLevel}-${currentSubLevel}`;
            
            updateUnicornPower();
        }
        
        // Actualizar poder del unicornio
        function updateUnicornÊûÅ() {
            const powerLevel = document.getElementById('unicornPowerLevel');
            powerLevel.style.width = `${unicornPower}%`;
        }
        
        // Actualizar salud del jefe
        function updateBossHealth() {
            const healthBar = document.getElementById('bossHealthBar');
            const healthText = document.getElementById('bossHealthText');
            const healthPercent = (bossHealth / bossMaxHealth) * 100;
            
            healthBar.style.width = `${healthPercent}%`;
            healthText.textContent = `${bossHealth}/${bossMaxHealth}`;
        }
        
        // Reproducir sonido
        function playSound(soundName, loop = false) {
            if (sounds[soundName]) {
                const sound = sounds[soundName].cloneNode();
                sound.loop = loop;
                sound.volume = 0.7;
                sound.play().catch(e => console.log("Error reproduciendo sonido:", e));
                return sound;
            }
            return null;
        }
        
        // Detener sonido
        function stopSound(soundName) {
            if (sounds[soundName]) {
                sounds[soundName].pause();
                sounds[soundName].currentTime = 0;
            }
        }
        
        // Mostrar pista
        function showHint(text, duration) {
            const hint = document.getElementById('hÊûÅ');
            hint.textContent = text;
            hint.style.opacity = '1';
            
            setTimeout(() => {
                hint.style.opacity = '0';
            }, duration);
        }
        
        // Alternar sonido
        function toggleSound() {
            const soundToggle = document.getElementById('soundToggle');
            if (sounds.background.paused) {
                sounds.background.play();
                soundToggle.textContent = 'üîä';
            } else {
                sounds.background.pause();
                soundToggle.textContent = 'üîá';
            }
        }
        
        // Bucle principal del juego
        function gameLoop() {
            if (!gameStarted) return;
            
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar fondo
            if (background && background.complete) {
                ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
            } else {
                // Fondo por defecto
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, "#87CEEB");
                gradient.addColorStop(1, "#E0F7FA");
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Actualizar y dibujar plataformas
            drawPlatforms();
            
            // Actualizar y dibujar jugador
            updatePlayer();
            drawPlayer();
            
            // Actualizar y dibujar enemigos
            updateEnemies();
            drawEnemies();
            
            // Actualizar y dibujar corazones
            updateHearts();
            drawHearts();
            
            // Actualizar y dibujar amigos
            updateFriends();
            drawFriends();
            
            // Actualizar y dibujar items
            updateItems();
            drawItems();
            
            // Actualizar y dibujar proyectiles
            updateProjectiles();
            drawProjectiles();
            
            // Comprobar colisiones
            checkCollisions();
            
            // Comprobar si se complet√≥ el nivel
            checkLevelCompletion();
            
            // Continuar el bucle
            requestAnimationFrame(gameLoop);
        }
        
        // Actualizar jugador
        function updatePlayer() {
            // Movimiento horizontal
            player.velocityX = 0;
            
            if (keys['ArrowLeft']) {
                player.velocityX = -player.speed;
                player.direction = -1;
            }
            
            if (keys['ArrowRight']) {
                player.velocityX = player.speed;
                player.direction = 1;
            }
            
            // Gravedad
            player.velocityY += 0.7;
            
            // Limitar velocidad vertical
            if (player.velocityY > 15) {
                player.velocityY = 15;
            }
            
            // Aplicar velocidad
            player.x += player.velocityX;
            player.y += player.velocityY;
            
            // Limitar al canvas
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
            if (player.y > canvas.height) {
                // El jugador cay√≥ al vac√≠o
                playerLoseLife();
            }
            
            // Comprobar colisi√≥n con plataformas
            player.grounded = false;
            for (const platform of platforms) {
                if (
                    player.x < platform.x + platform.width &&
                    player.x + player.width > platform.x &&
                    player.y + player.height > platform.y &&
                    player.y < platform.y + 10 &&
                    player.velocityY > 0
                ) {
                    player.y = platform.y - player.height;
                    player.velocityY = 0;
                    player.grounded = true;
                }
            }
            
            // Actualizar poder del unicornio
            if (unicornActive) {
                unicornPower -= 0.1;
                if (unicornPower <= 0) {
                    unicornActive = false;
                    player.image = images.bear;
                    player.width = 60;
                    player.height = 80;
                }
                updateUnicornPower();
            }
            
            // Actualizar cooldown de disparo
            if (shootCooldown > 0) {
                shootCooldown--;
            }
            
            // Actualizar invencibilidad
            if (player.invincible > 0) {
                player.invincible--;
            }
        }
        
        // Dibujar jugador
        function drawPlayer() {
            // Dibujar con efecto de parpadeo si es invencible
            if (player.invincible > 0 && player.invincible % 10 < 5) {
                ctx.globalAlpha = 0.5;
            }
            
            if (player.image && player.image.complete) {
                // Voltear imagen seg√∫n la direcci√≥n
                if (player.direction === -1) {
                    ctx.save();
                    ctx.scale(-1, 1);
                    ctx.drawImage(player.image, -player.x - player.width, player.y, player.width, player.height);
                    ctx.restore();
                } else {
                    ctx.drawImage(player.image, player.x, player.y, player.width, player.height);
                }
            } else {
                // Dibujar placeholder si la imagen no est√° cargada
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(player.x, player.y, player.width, player.height);
            }
            
            ctx.globalAlpha = 1;
        }
        
        // Actualizar enemigos
        function updateEnemies() {
            for (const enemy of enemies) {
                // Movimiento de los enemigos
                if (enemy.type === 'boss') {
                    // Movimiento del jefe
                    enemy.x += enemy.speed * enemy.direction;
                    
                    // Cambiar direcci√≥n al llegar a los l√≠mites
                    if (enemy.x < 100 || enemy.x > canvas.width - enemy.width - 100) {
                        enemy.direction *= -1;
                    }
                    
                    // Ataque del jefe
                    enemy.attackCooldown++;
                    if (enemy.attackCooldown >= 120) {
                        enemy.attackCooldown = 0;
                        
                        // Mostrar advertencia
                        document.getElementById('fireWarning').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('fireWarning').style.display = 'none';
                        }, 2000);
                    }
                    
                    // Efecto de destello
                    if (bossIsFlashing) {
                        bossFlashTimer++;
                        if (bossFlashTimer >= 30) {
                            bossIsFlashing = false;
                            bossFlashTimer = 0;
                            enemy.image = images.wolf;
                        }
                    }
                } else {
                    // Movimiento de enemigos normales
                    enemy.x += enemy.speed * enemy.direction;
                    
                    // Cambiar direcci√≥n al llegar a los l√≠mites
                    if (enemy.x < 0 || enemy.x > canvas.width - enemy.width) {
                        enemy.direction *= -1;
                    }
                }
            }
        }
        
        // Dibujar enemigos
        function drawEnemies() {
            for (const enemy of enemies) {
                if (enemy.image && enemy.image.complete) {
                    // Voltear imagen seg√∫n la direcci√≥n
                    if (enemy.direction === -1) {
                        ctx.save();
                        ctx.scale(-1, 1);
                        ctx.drawImage(enemy.image, -enemy.x - enemy.width, enemy.y, enemy.width, enemy.height);
                        ctx.restore();
                    } else {
                        ctx.drawImage(enemy.image, enemy.x, enemy.y, enemy.width, enemy.height);
                    }
                } else {
                    // Dibujar placeholder si la imagen no est√° cargada
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                }
                
                // Dibujar barra de salud para el jefe
                if (enemy.type === 'boss') {
                    const barWidth = enemy.width;
                    const barHeight = 8;
                    const healthPercent = enemy.health / enemy.maxHealth;
                    
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(enemy.x, enemy.y - 15, barWidth, barHeight);
                    
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                    ctx.fillRect(enemy.x, enemy.y - 15, barWidth * healthPercent, barHeight);
                }
            }
        }
        
        // Actualizar corazones
        function updateHearts() {
            for (const heart of hearts) {
                // Animaci√≥n de flotaci√≥n
                heart.y += Math.sin(Date.now() / 500) * 0.5;
            }
        }
        
        // Dibujar corazones
        function drawHearts() {
            for (const heart of hearts) {
                if (!heart.collected) {
                    if (images.heart && images.heart.complete) {
                        ctx.drawImage(images.heart, heart.x, heart.y, heart.width, heart.height);
                    } else {
                        // Dibujar placeholder si la imagen no est√° cargada
                        ctx.fillStyle = '#FF69B4';
                        ctx.beginPath();
                        ctx.moveTo(heart.x + heart.width/2, heart.y);
                        ctx.bezierCurveTo(
                            heart.x + heart.width, heart.y,
                            heart.x + heart.width, heart.y + heart.height,
                            heart.x + heart.width/2, heart.y + heart.height
                        );
                        ctx.bezierCurveTo(
                            heart.x, heart.y + heart.height,
                            heart.x, heart.y,
                            heart.x + heart.width/2, heart.y
                        );
                        ctx.fill();
                    }
                }
            }
        }
        
        // Actualizar amigos
        function updateFriends() {
            for (const friend of friends) {
                // Animaci√≥n de flotaci√≥n
                friend.y += Math.sin(Date.now() / 500) * 0.5;
            }
        }
        
        // Dibujar amigos
        function drawFriends() {
            for (const friend of friends) {
                if (!friend.hugged && friend.image && friend.image.complete) {
                    ctx.drawImage(friend.image, friend.x, friend.y, friend.width, friend.height);
                }
            }
        }
        
        // Actualizar items
        function updateItems() {
            for (const item of items) {
                // Animaci√≥n de flotaci√≥n
                item.y += Math.sin(Date.now() / 500) * 0.5;
            }
        }
        
        // Dibujar items
        function drawItems() {
            for (const item of items) {
                if (!item.collected && item.image && item.image.complete) {
                    ctx.drawImage(item.image, item.x, item.y, item.width, item.height);
                }
            }
        }
        
        // Actualizar proyectiles
        function updateProjectiles() {
            for (let i = projectiles.length - 1; i >= 0; i--) {
                const projectile = projectiles[i];
                
                // Mover proyectil
                projectile.x += projectile.speed * projectile.direction;
                
                // Eliminar proyectiles que salen de la pantalla
                if (projectile.x < -50 || projectile.x > canvas.width + 50) {
                    projectiles.splice(i, 1);
                    continue;
                }
                
                // Comprobar colisi√≥n con enemigos
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    
                    if (
                        projectile.x < enemy.x + enemy.width &&
                        projectile.x + projectile.width > enemy.x &&
                        projectile.y < enemy.y + enemy.height &&
                        projectile.y + projectile.height > enemy.y
                    ) {
                        // El proyectil golpea al enemigo
                        playSound('enemy');
                        enemy.health--;
                        
                        if (enemy.type === 'boss') {
                            bossHealth = enemy.health;
                            updateBossHealth();
                            
                            // Efecto de destello
                            bossIsFlashing = true;
                            enemy.image = images.wolfHurt;
                            
                            // Cambiar a forma enfurecida
                            if (bossHealth <= 3 && enemy.image !== images.wolfAngry) {
                                enemy.image = images.wolfAngry;
                                enemy.speed = 3;
                                
                                // Efecto de destello grande
                                gameContainer.classList.add('boss-flash');
                                setTimeout(() => {
                                    gameContainer.classList.remove('boss-flash');
                                }, 500);
                            }
                        }
                        
                        if (enemy.health <= 0) {
                            // Eliminar enemigo
                            enemies.splice(j, 1);
                            score += enemy.type === 'boss' ? 500 : 200;
                        }
                        
                        // Eliminar proyectil
                        projectiles.splice(i, 1);
                        break;
                    }
                }
            }
        }
        
        // Dibujar proyectiles
        function drawProjectiles() {
            for (const projectile of projectiles) {
                if (images.heart && images.heart.complete) {
                    ctx.drawImage(images.heart, projectile.x - projectile.width/2, projectile.y - projectile.height/2, projectile.width, projectile.height);
                } else {
                    // Dibujar placeholder si la imagen no est√° cargada
                    ctx.fillStyle = '#FF69B4';
                    ctx.beginPath();
                    ctx.arc(projectile.x, projectile.y, projectile.width/2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }
        
        // Dibujar plataformas
        function drawPlatforms() {
            for (const platform of platforms) {
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                
                ctx.fillStyle = '#228B22';
                ctx.fillRect(platform.x, platform.y, platform.width, 10);
            }
        }
        
        // Comprobar colisiones
        function checkCollisions() {
            // Colisi√≥n con corazones
            for (const heart of hearts) {
                if (
                    !heart.collected &&
                    player.x < heart.x + heart.width &&
                    player.x + player.width > heart.x &&
                    player.y < heart.y + heart.height &&
                    player.y + player.height > heart.y
                ) {
                    heart.collected = true;
                    heartsCollected++;
                    score += 100;
                    playSound('collect');
                    updateUI();
                }
            }
            
            // Colisi√≥n con items
            for (const item of items) {
                if (
                    !item.collected &&
                    player.x < item.x + item.width &&
                    player.x + player.width > item.x &&
                    player.y < item.y + item.height &&
                    player.y + player.height > item.y
                ) {
                    item.collected = true;
                    score += 50;
                    playSound('collect');
                    updateUI();
                }
            }
            
            // Colisi√≥n con enemigos - SOLO si el jugador no es invencible
            for (const enemy of enemies) {
                if (
                    player.invincible <= 0 &&
                    player.x < enemy.x + enemy.width &&
                    player.x + player.width > enemy.x &&
                    player.y < enemy.y + enemy.height &&
                    player.y + player.height > enemy.y
                ) {
                    // El jugador es golpeado
                    playerLoseLife();
                }
            }
        }
        
        // El jugador pierde una vida
        function playerLoseLife() {
            lives--;
            playSound('hurt');
            
            // Hacer al jugador invencible por un tiempo
            player.invincible = 120;
            
            updateUI();
            
            if (lives <= 0) {
                // Game over
                gameOver();
            } else {
                // Reiniciar posici√≥n
                player.x = 100;
                player.y = 300;
                player.velocityX = 0;
                player.velocityY = 0;
            }
        }
        
        // Comprobar si se complet√≥ el nivel
        function checkLevelCompletion() {
            let levelCompleted = false;
            
            // Completar nivel 1-1: recolectar 3 corazones y abrazar a todos los amigos
            if (currentLevel === 1 && currentSubLevel === 1) {
                let allHugged = true;
                for (const friend of friends) {
                    if (!friend.hugged) allHugged = false;
                }
                
                if (allHugged && friends.length > 0) {
                    levelCompleted = true;
                }
            }
            // Completar nivel 1-2: derrotar al lobo y abrazar a todos los amigos
            else if (currentLevel === 1 && currentSubLevel === 2) {
                let allHugged = true;
                for (const friend of friends) {
                    if (!friend.hugged) allHugged = false;
                }
                
                if (enemies.length === 0 && allHugged && friends.length > 0) {
                    levelCompleted = true;
                }
            }
            // Completar nivel 1-3: derrotar a todos los enemigos y abrazar a todos los amigos
            else if (currentLevel === 1 && currentSubLevel === 3) {
                let allHugged = true;
                for (const friend of friends) {
                    if (!friend.hugged) allHugged = false;
                }
                
                if (enemies.length === 0 && allHugged && friends.length > 0) {
                    levelCompleted = true;
                }
            }
            // Completar nivel 2-1: recolectar 3 corazones y abrazar a todos los amigos
            else if (currentLevel === 2 && currentSubLevel === 1) {
                let allHugged = true;
                for (const friend of friends) {
                    if (!friend.hugged) allHugged = false;
                }
                
                if (heartsCollected >= 3 && allHugged && friends.length > 0) {
                    levelCompleted = true;
                }
            }
            // Completar nivel 2-2: derrotar a todos los enemigos y abrazar a todos los amigos
            else if (currentLevel === 2 && currentSubLevel === 2) {
                let allHugged = true;
                for (const friend of friends) {
                    if (!friend.hugged) allHugged = false;
                }
                
                if (enemies.length === 0 && allHugged && friends.length > 0) {
                    levelCompleted = true;
                }
            }
            // Completar nivel 2-3: derrotar al lobo jefe
            else if (currentLevel === 2 && currentSubLevel === 3) {
                if (enemies.length === 0) {
                    levelCompleted = true;
                }
            }
            
            if (levelCompleted) {
                setTimeout(() => {
                    nextLevel();
                }, 1000);
            }
        }
        
        // Pasar al siguiente nivel
        function nextLevel() {
            if (currentLevel === 1 && currentSubLevel < 3) {
                currentSubLevel++;
            } else if (currentLevel === 2 && currentSubLevel < 3) {
                currentSubLevel++;
            } else if (currentLevel === 1 && currentSubLevel === 3) {
                currentLevel = 2;
                currentSubLevel = 1;
            } else if (currentLevel === 2 && currentSubLevel === 3) {
                victory();
                return;
            }
            
            setupLevel(currentLevel, currentSubLevel);
        }
        
        // Victoria
        function victory() {
            gameStarted = false;
            stopSound('bossBattle');
            playSound('victory');
            
            // Mostrar pantalla de victoria
            document.getElementById('victoryScreen').style.display = 'flex';
            document.getElementById('finalScore').textContent = score;
        }
        
        // Game over
        function gameOver() {
            gameStarted = false;
            
            // Mostrar pantalla de inicio
            document.getElementById('startScreen').style.display = 'flex';
        }
        
        // Reiniciar juego
        function restartGame() {
            document.getElementById('victoryScreen').style.display = 'none';
            startGame();
        }
        
        // Iniciar cuando se carga la p√°gina
        window.addEventListener('load', init);
    </script>
</body>
</html>
