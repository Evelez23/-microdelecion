<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oso Abrazos - Aventura Completa (Mejorado)</title>
  <style>
    body {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      text-align: center;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    
    h1 {
      font-size: 2.5rem;
      text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5);
      color: #FFD700;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 1.2rem;
      margin-bottom: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .game-wrapper {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    
    #gameContainer {
      position: relative;
      width: 800px;
      height: 500px;
      border: 5px solid #FFD700;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
    }
    
    #gameCanvas {
      display: block;
      background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
    }
    
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      text-align: left;
      font-size: 16px;
      z-index: 10;
    }
    
    .power-bar {
      width: 100px;
      height: 12px;
      background: #444;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 5px;
    }
    
    .power-level {
      height: 100%;
      background: linear-gradient(to right, #FF69B4, #FF1493);
      width: 100%;
      border-radius: 6px;
      transition: width 0.3s;
    }
    
    #levelIndicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      z-index: 10;
    }
    
    #startScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 20;
    }
    
    #coverImage {
      width: 800px; /* Ahora ocupa todo el ancho del juego */
      height: 500px; /* Ahora ocupa toda la altura del juego */
      object-fit: cover;
      margin-bottom: 20px;
      border: 3px solid #FFD700;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }
    
    #startButton, .storybook-btn, .celebration-btn {
      background: linear-gradient(to bottom, #FFD700, #FF9800);
      border: none;
      padding: 15px 30px;
      font-size: 1.2rem;
      border-radius: 50px;
      color: #8B4513;
      font-weight: bold;
      cursor: pointer;
      margin: 10px;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    #startButton:hover, .storybook-btn:hover, .celebration-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }
    
    #hint {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 10;
    }
    
    #soundToggle {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid white;
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 5;
    }
    
    .mobile-controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: flex;
      gap: 20px;
      opacity: 0.8;
      z-index: 10;
    }
    
    .mobile-controls-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .mobile-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      font-size: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .mobile-label {
      color: white;
      font-size: 0.8rem;
      text-shadow: 1px 1px 2px black;
    }
    
    #storybook {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 25;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
      text-align: center;
      overflow-y: auto;
    }
    
    .storybook-content {
      max-width: 700px;
      max-height: 90%;
      overflow-y: auto;
      padding: 20px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 15px;
      border: 2px solid #FFD700;
    }
    
    .storybook-images {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
    }
    
    .storybook-images img {
      width: 100px;
      height: 100px;
      border: 2px solid #FFD700;
      border-radius: 10px;
      object-fit: cover;
    }
    
    .storybook-controls {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* üî• Estilos para el jefe */
    .boss-health {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 400px;
      height: 25px;
      background: #333;
      border-radius: 12px;
      overflow: hidden;
      z-index: 15;
      border: 3px solid #fff;
      display: none;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
    }

    .boss-health-bar {
      height: 100%;
      background: linear-gradient(to right, #ff0000, #ff6600, #ffcc00);
      width: 100%;
      transition: width 0.5s;
      position: relative;
    }

    .boss-health-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      z-index: 16;
    }

    /* ‚ö° Animaci√≥n de advertencia de fuego */
    .fire-warning {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background: linear-gradient(to top, rgba(255, 0, 0, 0.3), transparent);
      z-index: 14;
      display: none;
      animation: warningPulse 0.5s infinite;
    }

    @keyframes warningPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.8; }
    }

    /* üíù Animaci√≥n de corazones brillantes */
    @keyframes heartGlow {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.1); filter: brightness(1.3); }
    }

    .heart-collectible {
      animation: heartGlow 1s infinite;
    }

    /* üéÜ Animaci√≥n de victoria mejorada */
    .victory-animation {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.4), rgba(255, 140, 0, 0.2));
      z-index: 30;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      text-align: center;
    }

    .victory-title {
      font-size: 4rem;
      margin-bottom: 20px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
      color: #FFD700;
      animation: victoryBounce 1s ease-in-out infinite alternate;
    }

    .victory-image {
      width: 300px;
      height: 200px;
      object-fit: contain;
      margin: 20px 0;
      border: 3px solid #FFD700;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    @keyframes victoryBounce {
      0% { transform: scale(1); }
      100% { transform: scale(1.05); }
    }

    /* üê∫ Animaci√≥n de enfado del lobo */
    .boss-enraged {
      animation: enrageShake 0.3s infinite;
    }

    @keyframes enrageShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px) rotate(-2deg); }
      75% { transform: translateX(5px) rotate(2deg); }
    }

    #loadingScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      z-index: 35;
    }
    
    .progress-bar {
      width: 300px;
      height: 20px;
      background: #555;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background: #4CAF50;
      width: 0%;
      transition: width 0.3s;
    }
    
    .error-message {
      background: rgba(255, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      max-width: 80%;
    }

    /* üî• Efecto de destello para el lobo */
    .boss-flash {
      animation: bossFlash 0.5s;
    }

    @keyframes bossFlash {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(3); }
    }

    /* üåü Efecto de transici√≥n entre niveles */
    .level-transition {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      z-index: 40;
      opacity: 0;
      display: none;
    }

    /* ü¶â Nuevo enemigo (b√∫ho) */
    .owl-enemy {
      animation: owlFloat 3s ease-in-out infinite;
    }

    @keyframes owlFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
  </style>
</head>
<body>
  <h1>üêª Oso Abrazos - Aventura Completa</h1>
  <p class="subtitle">¬°Ayuda al Oso Abrazos a derrotar al Lobo Feroz en 6 niveles emocionantes!</p>
  
  <div class="game-wrapper">
    <div id="gameContainer">
      <canvas id="gameCanvas" width="800" height="500"></canvas>

      <!-- UI Mejorada -->
      <div id="ui">
        <div>Puntos: <span id="score">0</span></div>
        <div>Vidas: <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
        <div>Nivel: <span id="level">1-1</span></div>
        <div id="unicornPower" style="display: none;">
          <span>ü¶Ñ Poder del Unicornio:</span>
          <div class="power-bar">
              <div class="power-level" id="unicornPowerLevel"></div>
          </div>
        </div>
        <div id="heartsCollected" style="display: none;">
          <span>üíï Corazones: <span id="heartCount">0</span>/3</span>
        </div>
      </div>

      <!-- üê∫ Barra de salud del jefe -->
      <div id="bossHealth" class="boss-health">
        <div class="boss-health-bar" id="bossHealthBar">
          <div class="boss-health-text">üê∫ Lobo Feroz - Vida: <span id="bossHealthText">5/5</span></div>
        </div>
      </div>

      <!-- ‚ö° Advertencia de fuego -->
      <div id="fireWarning" class="fire-warning">
        <div style="text-align: center; color: white; font-weight: bold; padding-top: 10px;">
          ‚ö†Ô∏è ¬°CUIDADO! El lobo va a atacar con fuego ‚ö†Ô∏è
        </div>
      </div>

      <div id="levelIndicator" class="level-indicator">Nivel 1-1</div>

      <!-- üåü Transici√≥n entre niveles -->
      <div id="levelTransition" class="level-transition"></div>

      <!-- Pantalla de inicio con nueva m√∫sica -->
      <div id="startScreen">
        <img id="coverImage" src="" alt="Portada del Juego">
        <button id="startButton">üéÆ ¬°Comenzar Aventura!</button>
      </div>
      
      <!-- Pantalla de carga -->
      <div id="loadingScreen">
        <h2>Cargando recursos del juego...</h2>
        <div class="progress-bar">
          <div class="progress" id="loadingProgress"></div>
        </div>
        <p id="loadingText">0%</p>
        <div id="loadingDetails" style="margin-top: 20px;"></div>
      </div>

      <!-- Pantalla de victoria mejorada -->
      <div id="victoryScreen" class="victory-animation">
        <h2 class="victory-title">üéâ ¬°VICTORIA! üéâ</h2>
        <img id="victoryImage" class="victory-image" src="" alt="Oso y Unicornio">
        <p style="font-size: 1.5rem; margin: 10px 0;">¬°Has completado todos los niveles!</p>
        <p style="font-size: 1.2rem; margin: 10px 0;">Puntuaci√≥n final: <span id="finalScore">0</span></p>
        <button class="celebration-btn" onclick="restartGame()">üîÑ Jugar de nuevo</button>
      </div>
      
      <!-- Controles para m√≥viles -->
      <div class="mobile-controls">
        <div class="mobile-controls-column">
          <div class="mobile-label">Movimiento</div>
          <button class="mobile-btn" id="leftBtn">‚Üê</button>
          <div style="display: flex; gap: 10px;">
            <button class="mobile-btn" id="upBtn">‚Üë</button>
            <button class="mobile-btn" id="downBtn">‚Üì</button>
          </div>
          <button class="mobile-btn" id="rightBtn">‚Üí</button>
        </div>
        <div class="mobile-controls-column">
          <div class="mobile-label">Acciones</div>
          <button class="mobile-btn" id="jumpBtn">üîÑ</button>
          <button class="mobile-btn" id="actionBtn">üí•</button>
        </div>
      </div>
      
      <button id="soundToggle">üîä</button>
      
      <div id="hint">üí° Usa las flechas para moverte y la barra espaciadora para saltar</div>
    </div>
  </div>

  <script>
    // Variables globales
    let canvas, ctx;
    let player, enemies = [], platforms = [], collectibles = [], projectiles = [];
    let keys = {};
    let score = 0;
    let lives = 3;
    let currentLevel = 1;
    let currentSubLevel = 1;
    let gameStarted = false;
    let bossHealth = 5;
    let bossMaxHealth = 5;
    let bossAttackTimer = 0;
    let bossAttackInterval = 120;
    let bossFireballs = [];
    let unicornPower = 0;
    let heartsCollected = 0;
    let totalHearts = 3;
    let bossEnraged = false;
    let bossFlashTimer = 0;
    let bossFlashDuration = 30;
    let bossIsFlashing = false;
    let owlEnemies = [];
    let owlSpawnTimer = 0;
    let owlSpawnInterval = 300;
    let victoryMusicPlayed = false;
    
    // Im√°genes y sonidos
    const images = {};
    const sounds = {};
    
    // Cargar recursos
    const resources = {
      images: {
        bear: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/oso1.png',
        bearJump: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/oso2.png',
        bearAttack: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/oso3.png',
        wolf: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/lobo/lobo1.png',
        wolfAttack: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/lobo/lobo2.png',
        wolfHurt: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/lobo/lobo3.png',
        unicorn: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/unicornio/uni1.png',
        bearWithUnicorn: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/Amigos/osoyuni.png',
        heart: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/corazon.png',
        cover: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/portada.png',
        victory: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/refs/heads/main/img/oso/uniyosocombat.png',
        owl: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/buho/buho1.png',
        fireball: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/fuego.png'
      },
      sounds: {
        background: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/fondo.mp3',
        jump: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/salto.mp3',
        collect: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/coleccionar.mp3',
        hit: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/golpe.mp3',
        victory: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/victoria.mp3',
        bossBattle: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/para%20la%20batalla.mp3',
        unicornCall: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/llamada.mp3',
        owlSound: 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/sounds/buho.mp3'
      }
    };
    
    // Inicializar el juego
    function init() {
      canvas = document.getElementById('gameCanvas');
      ctx = canvas.getContext('2d');
      
      // Mostrar pantalla de carga
      document.getElementById('loadingScreen').style.display = 'flex';
      
      // Cargar recursos
      loadResources().then(() => {
        // Ocultar pantalla de carga
        document.getElementById('loadingScreen').style.display = 'none';
        
        // Configurar la portada
        document.getElementById('coverImage').src = images.cover;
        
        // Configurar la imagen de victoria
        document.getElementById('victoryImage').src = images.victory;
        
        // Iniciar el bucle del juego
        gameLoop();
        
        // Mostrar pista despu√©s de un retraso
        setTimeout(() => {
          document.getElementById('hint').style.opacity = 1;
          setTimeout(() => {
            document.getElementById('hint').style.opacity = 0;
          }, 5000);
        }, 2000);
      });
      
      // Configurar eventos de teclado
      window.addEventListener('keydown', (e) => {
        keys[e.key] = true;
        
        // Saltar con espacio o flecha arriba
        if ((e.key === ' ' || e.key === 'ArrowUp') && player && player.grounded) {
          player.velocityY = -15;
          playSound('jump');
        }
        
        // Llamar al unicornio con la tecla 'U'
        if (e.key === 'u' || e.key === 'U') {
          callUnicorn();
        }
      });
      
      window.addEventListener('keyup', (e) => {
        keys[e.key] = false;
      });
      
      // Configurar botones de inicio
      document.getElementById('startButton').addEventListener('click', startGame);
      
      // Configurar controles t√°ctiles para m√≥viles
      setupMobileControls();
    }
    
    // Configurar controles m√≥viles
    function setupMobileControls() {
      const leftBtn = document.getElementById('leftBtn');
      const rightBtn = document.getElementById('rightBtn');
      const upBtn = document.getElementById('upBtn');
      const downBtn = document.getElementById('downBtn');
      const jumpBtn = document.getElementById('jumpBtn');
      const actionBtn = document.getElementById('actionBtn');
      
      // Controles de movimiento
      leftBtn.addEventListener('touchstart', () => keys['ArrowLeft'] = true);
      leftBtn.addEventListener('touchend', () => keys['ArrowLeft'] = false);
      
      rightBtn.addEventListener('touchstart', () => keys['ArrowRight'] = true);
      rightBtn.addEventListener('touchend', () => keys['ArrowRight'] = false);
      
      upBtn.addEventListener('touchstart', () => keys['ArrowUp'] = true);
      upBtn.addEventListener('touchend', () => keys['ArrowUp'] = false);
      
      downBtn.addEventListener('touchstart', () => keys['ArrowDown'] = true);
      downBtn.addEventListener('touchend', () => keys['ArrowDown'] = false);
      
      // Bot√≥n de salto
      jumpBtn.addEventListener('touchstart', () => {
        if (player && player.grounded) {
          player.velocityY = -15;
          playSound('jump');
        }
      });
      
      // Bot√≥n de acci√≥n (llamar al unicornio)
      actionBtn.addEventListener('touchstart', callUnicorn);
    }
    
    // Cargar recursos
    async function loadResources() {
      const totalResources = Object.keys(resources.images).length + Object.keys(resources.sounds).length;
      let loaded = 0;
      
      // Cargar im√°genes
      for (const [name, url] of Object.entries(resources.images)) {
        try {
          images[name] = await loadImage(url);
          loaded++;
          updateLoadingProgress(loaded, totalResources, `Imagen cargada: ${name}`);
        } catch (error) {
          console.error(`Error al cargar la imagen ${name}:`, error);
          loaded++;
          updateLoadingProgress(loaded, totalResources, `Error al cargar: ${name}`);
        }
      }
      
      // Cargar sonidos
      for (const [name, url] of Object.entries(resources.sounds)) {
        try {
          sounds[name] = await loadSound(url);
          loaded++;
          updateLoadingProgress(loaded, totalResources, `Sonido cargado: ${name}`);
        } catch (error) {
          console.error(`Error al cargar el sonido ${name}:`, error);
          loaded++;
          updateLoadingProgress(loaded, totalResources, `Error al cargar: ${name}`);
        }
      }
    }
    
    // Funci√≥n para cargar una imagen
    function loadImage(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }
    
    // Funci√≥n para cargar un sonido
    function loadSound(url) {
      return new Promise((resolve, reject) => {
        const audio = new Audio();
        audio.addEventListener('canplaythrough', () => resolve(audio));
        audio.addEventListener('error', reject);
        audio.src = url;
        audio.load();
      });
    }
    
    // Actualizar barra de progreso de carga
    function updateLoadingProgress(loaded, total, detail) {
      const progress = (loaded / total) * 100;
      document.getElementById('loadingProgress').style.width = `${progress}%`;
      document.getElementById('loadingText').textContent = `${Math.round(progress)}%`;
      document.getElementById('loadingDetails').innerHTML = detail;
    }
    
    // Iniciar el juego
    function startGame() {
      document.getElementById('startScreen').style.display = 'none';
      gameStarted = true;
      playSound('background', true);
      resetLevel();
    }
    
    // Reiniciar nivel
    function resetLevel() {
      // Limpiar arrays
      enemies = [];
      platforms = [];
      collectibles = [];
      projectiles = [];
      bossFireballs = [];
      owlEnemies = [];
      
      // Reiniciar variables
      bossHealth = bossMaxHealth;
      bossAttackTimer = 0;
      bossEnraged = false;
      bossIsFlashing = false;
      owlSpawnTimer = 0;
      
      // Crear jugador
      player = {
        x: 100,
        y: 300,
        width: 50,
        height: 70,
        velocityX: 0,
        velocityY: 0,
        speed: 5,
        jumpForce: 15,
        grounded: false,
        image: images.bear,
        attackCooldown: 0,
        attackDuration: 0,
        isAttacking: false,
        facingRight: true,
        unicornMode: false,
        unicornModeTimer: 0
      };
      
      // Configurar nivel actual
      setupLevel(currentLevel, currentSubLevel);
      
      // Actualizar UI
      updateUI();
    }
    
    // Configurar nivel
    function setupLevel(level, subLevel) {
      // Limpiar arrays
      platforms = [];
      collectibles = [];
      enemies = [];
      
      // Configurar niveles
      if (level === 1) {
        if (subLevel === 1) {
          // Nivel 1-1: Introducci√≥n
          createPlatform(0, 400, 800, 100);
          createPlatform(200, 300, 100, 20);
          createPlatform(500, 250, 100, 20);
          
          // Crear corazones para recolectar
          createCollectible(250, 250, 'heart');
          createCollectible(550, 200, 'heart');
          
          // Actualizar UI
          document.getElementById('levelIndicator').textContent = 'Nivel 1-1: Introducci√≥n';
          document.getElementById('heartsCollected').style.display = 'block';
          document.getElementById('unicornPower').style.display = 'none';
          document.getElementById('bossHealth').style.display = 'none';
        } else if (subLevel === 2) {
          // Nivel 1-2: Encuentro con el lobo
          createPlatform(0, 400, 800, 100);
          createPlatform(100, 300, 100, 20);
          createPlatform(300, 250, 100, 20);
          createPlatform(600, 300, 100, 20);
          
          // Crear enemigos
          createEnemy(400, 330, 'wolf');
          
          // Actualizar UI
          document.getElementById('levelIndicator').textContent = 'Nivel 1-2: Encuentro con el lobo';
          document.getElementById('heartsCollected').style.display = 'block';
          document.getElementById('unicornPower').style.display = 'none';
          document.getElementById('bossHealth').style.display = 'none';
        }
      } else if (level === 2) {
        if (subLevel === 1) {
          // Nivel 2-1: Preparaci√≥n para la batalla
          createPlatform(0, 400, 800, 100);
          createPlatform(150, 300, 100, 20);
          createPlatform(350, 250, 100, 20);
          createPlatform(550, 300, 100, 20);
          
          // Crear corazones
          createCollectible(200, 250, 'heart');
          createCollectible(400, 200, 'heart');
          createCollectible(600, 250, 'heart');
          
          // Actualizar UI
          document.getElementById('levelIndicator').textContent = 'Nivel 2-1: Preparaci√≥n para la batalla';
          document.getElementById('heartsCollected').style.display = 'block';
          document.getElementById('unicornPower').style.display = 'none';
          document.getElementById('bossHealth').style.display = 'none';
        } else if (subLevel === 2) {
          // Nivel 2-2: Batalla con el lobo (con m√∫sica especial)
          createPlatform(0, 400, 800, 100);
          createPlatform(200, 300, 400, 20);
          
          // Crear jefe (lobo)
          createEnemy(400, 330, 'wolfBoss');
          
          // Cambiar m√∫sica
          stopSound('background');
          playSound('bossBattle', true);
          
          // Mostrar barra de salud del jefe
          document.getElementById('bossHealth').style.display = 'block';
          updateBossHealth();
          
          // Actualizar UI
          document.getElementById('levelIndicator').textContent = 'Nivel 2-2: Batalla con el lobo';
          document.getElementById('heartsCollected').style.display = 'none';
          document.getElementById('unicornPower').style.display = 'block';
        } else if (subLevel === 3) {
          // Nivel 2-3: Batalla final
          createPlatform(0, 400, 800, 100);
          createPlatform(100, 300, 200, 20);
          createPlatform(500, 300, 200, 20);
          
          // Crear jefe (lobo enfurecido)
          createEnemy(400, 330, 'wolfBossEnraged');
          bossEnraged = true;
          bossMaxHealth = 8;
          bossHealth = bossMaxHealth;
          
          // Mostrar barra de salud del jefe
          document.getElementById('bossHealth').style.display = 'block';
          updateBossHealth();
          
          // Actualizar UI
          document.getElementById('levelIndicator').textContent = 'Nivel 2-3: Batalla Final';
          document.getElementById('heartsCollected').style.display = 'none';
          document.getElementById('unicornPower').style.display = 'block';
        }
      }
      
      // Actualizar indicador de nivel
      document.getElementById('level').textContent = `${level}-${subLevel}`;
    }
    
    // Crear plataforma
    function createPlatform(x, y, width, height) {
      platforms.push({
        x, y, width, height
      });
    }
    
    // Crear coleccionable
    function createCollectible(x, y, type) {
      collectibles.push({
        x, y,
        width: 30,
        height: 30,
        type,
        collected: false,
        image: type === 'heart' ? images.heart : images.unicorn
      });
    }
    
    // Crear enemigo
    function createEnemy(x, y, type) {
      const enemy = {
        x, y,
        width: 60,
        height: 60,
        type,
        health: type === 'wolfBoss' || type === 'wolfBossEnraged' ? bossMaxHealth : 1,
        maxHealth: type === 'wolfBoss' || type === 'wolfBossEnraged' ? bossMaxHealth : 1,
        speed: type === 'wolfBossEnraged' ? 3 : 2,
        direction: 1,
        attackCooldown: 0,
        image: type.includes('wolf') ? images.wolf : images.owl
      };
      
      if (type === 'wolfBoss' || type === 'wolfBossEnraged') {
        enemy.width = 80;
        enemy.height = 80;
      }
      
      enemies.push(enemy);
    }
    
    // Crear b√∫ho (nuevo enemigo)
    function createOwl(x, y) {
      owlEnemies.push({
        x, y,
        width: 40,
        height: 40,
        type: 'owl',
        health: 1,
        speed: 4,
        direction: Math.random() > 0.5 ? 1 : -1,
        image: images.owl,
        verticalDirection: 1,
        verticalSpeed: 2
      });
    }
    
    // Llamar al unicornio
    function callUnicorn() {
      if (heartsCollected >= totalHearts && !player.unicornMode) {
        playSound('unicornCall');
        player.unicornMode = true;
        player.unicornModeTimer = 300; // 5 segundos a 60 FPS
        player.image = images.bearWithUnicorn;
        player.width = 60; // 20% m√°s grande
        player.height = 84; // 20% m√°s grande
        unicornPower = 100;
        updateUnicornPower();
      }
    }
    
    // Actualizar UI
    function updateUI() {
      document.getElementById('score').textContent = score;
      
      // Actualizar vidas
      let livesText = '';
      for (let i = 0; i < lives; i++) {
        livesText += '‚ù§Ô∏è';
      }
      document.getElementById('lives').textContent = livesText;
      
      // Actualizar corazones recolectados
      document.getElementById('heartCount').textContent = heartsCollected;
      
      // Actualizar poder del unicornio
      updateUnicornPower();
    }
    
    // Actualizar poder del unicornio
    function updateUnicornPower() {
      const powerLevel = document.getElementById('unicornPowerLevel');
      powerLevel.style.width = `${unicornPower}%`;
      
      // Cambiar color seg√∫n el poder
      if (unicornPower > 70) {
        powerLevel.style.background = 'linear-gradient(to right, #00ff00, #00cc00)';
      } else if (unicornPower > 40) {
        powerLevel.style.background = 'linear-gradient(to right, #ffff00, #ffcc00)';
      } else {
        powerLevel.style.background = 'linear-gradient(to right, #ff0000, #cc0000)';
      }
    }
    
    // Actualizar salud del jefe
    function updateBossHealth() {
      const healthBar = document.getElementById('bossHealthBar');
      const healthText = document.getElementById('bossHealthText');
      const healthPercent = (bossHealth / bossMaxHealth) * 100;
      
      healthBar.style.width = `${healthPercent}%`;
      healthText.textContent = `${bossHealth}/${bossMaxHealth}`;
      
      // Cambiar color seg√∫n la salud
      if (healthPercent > 70) {
        healthBar.style.background = 'linear-gradient(to right, #00ff00, #00cc00)';
      } else if (healthPercent > 40) {
        healthBar.style.background = 'linear-gradient(to right, #ffff00, #ffcc00)';
      } else if (healthPercent > 20) {
        healthBar.style.background = 'linear-gradient(to right, #ff6600, #ff3300)';
      } else {
        healthBar.style.background = 'linear-gradient(to right, #ff0000, #cc0000)';
        healthBar.classList.add('boss-enraged');
      }
    }
    
    // Reproducir sonido
    function playSound(soundName, loop = false) {
      if (sounds[soundName]) {
        const sound = sounds[soundName].cloneNode();
        sound.loop = loop;
        sound.volume = 0.7;
        sound.play().catch(e => console.log("Error reproduciendo sonido:", e));
        return sound;
      }
      return null;
    }
    
    // Detener sonido
    function stopSound(soundName) {
      if (sounds[soundName]) {
        sounds[soundName].pause();
        sounds[soundName].currentTime = 0;
      }
    }
    
    // Bucle principal del juego
    function gameLoop() {
      if (!gameStarted) {
        requestAnimationFrame(gameLoop);
        return;
      }
      
      // Limpiar canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Dibujar fondo
      drawBackground();
      
      // Actualizar jugador
      updatePlayer();
      
      // Actualizar enemigos
      updateEnemies();
      
      // Actualizar b√∫hos
      updateOwls();
      
      // Actualizar proyectiles
      updateProjectiles();
      
      // Actualizar bolas de fuego del jefe
      updateBossFireballs();
      
      // Actualizar coleccionables
      updateCollectibles();
      
      // Dibujar plataformas
      drawPlatforms();
      
      // Dibujar jugador
      drawPlayer();
      
      // Dibujar enemigos
      drawEnemies();
      
      // Dibujar b√∫hos
      drawOwls();
      
      // Dibujar coleccionables
      drawCollectibles();
      
      // Dibujar proyectiles
      drawProjectiles();
      
      // Dibujar bolas de fuego del jefe
      drawBossFireballs();
      
      // Comprobar colisiones
      checkCollisions();
      
      // Comprobar si se complet√≥ el nivel
      checkLevelCompletion();
      
      // Actualizar temporizadores
      updateTimers();
      
      // Continuar el bucle
      requestAnimationFrame(gameLoop);
    }
    
    // Dibujar fondo
    function drawBackground() {
      // Fondo gradiente
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      
      if (currentLevel === 1) {
        // Niveles 1: cielo diurno
        gradient.addColorStop(0, '#87CEEB');
        gradient.addColorStop(1, '#E0F7FA');
      } else {
        // Niveles 2: cielo nocturno
        gradient.addColorStop(0, '#0c1445');
        gradient.addColorStop(1, '#1a237e');
        
        // Dibujar estrellas
        ctx.fillStyle = 'white';
        for (let i = 0; i < 50; i++) {
          const x = Math.random() * canvas.width;
          const y = Math.random() * (canvas.height / 2);
          const size = Math.random() * 2;
          ctx.fillRect(x, y, size, size);
        }
        
        // Dibujar luna
        ctx.fillStyle = '#f5f5f5';
        ctx.beginPath();
        ctx.arc(700, 80, 40, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = '#0c1445';
        ctx.beginPath();
        ctx.arc(690, 70, 35, 0, Math.PI * 2);
        ctx.fill();
      }
      
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    // Actualizar jugador
    function updatePlayer() {
      // Movimiento horizontal
      player.velocityX = 0;
      
      if (keys['ArrowLeft']) {
        player.velocityX = -player.speed;
        player.facingRight = false;
      }
      
      if (keys['ArrowRight']) {
        player.velocityX = player.speed;
        player.facingRight = true;
      }
      
      // Gravedad
      player.velocityY += 0.7;
      
      // Limitar velocidad vertical
      if (player.velocityY > 15) {
        player.velocityY = 15;
      }
      
      // Aplicar velocidad
      player.x += player.velocityX;
      player.y += player.velocityY;
      
      // Limitar al canvas
      if (player.x < 0) player.x = 0;
      if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
      if (player.y > canvas.height) {
        // El jugador cay√≥ al vac√≠o
        playerLoseLife();
      }
      
      // Comprobar colisi√≥n con plataformas
      player.grounded = false;
      for (const platform of platforms) {
        if (
          player.x < platform.x + platform.width &&
          player.x + player.width > platform.x &&
          player.y + player.height > platform.y &&
          player.y < platform.y + 10 &&
          player.velocityY > 0
        ) {
          player.y = platform.y - player.height;
          player.velocityY = 0;
          player.grounded = true;
        }
      }
      
      // Actualizar ataque
      if (player.attackCooldown > 0) {
        player.attackCooldown--;
      }
      
      if (player.attackDuration > 0) {
        player.attackDuration--;
        if (player.attackDuration === 0) {
          player.isAttacking = false;
          player.image = player.unicornMode ? images.bearWithUnicorn : images.bear;
        }
      }
      
      // Actualizar modo unicornio
      if (player.unicornMode) {
        player.unicornModeTimer--;
        unicornPower = (player.unicornModeTimer / 300) * 100;
        updateUnicornPower();
        
        if (player.unicornModeTimer <= 0) {
          player.unicornMode = false;
          player.image = images.bear;
          player.width = 50;
          player.height = 70;
        }
      }
    }
    
    // Dibujar jugador
    function drawPlayer() {
      // Dibujar sombra
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.fillRect(player.x + 5, player.y + player.height + 2, player.width - 10, 10);
      
      // Dibujar jugador
      if (player.isAttacking) {
        // Dibujar efecto de ataque
        ctx.fillStyle = player.unicornMode ? 'rgba(255, 105, 180, 0.5)' : 'rgba(255, 215, 0, 0.5)';
        ctx.beginPath();
        ctx.arc(
          player.facingRight ? player.x + player.width + 20 : player.x - 20,
          player.y + player.height / 2,
          30,
          0,
          Math.PI * 2
        );
        ctx.fill();
      }
      
      // Voltear imagen seg√∫n la direcci√≥n
      if (!player.facingRight) {
        ctx.save();
        ctx.scale(-1, 1);
        ctx.drawImage(player.image, -player.x - player.width, player.y, player.width, player.height);
        ctx.restore();
      } else {
        ctx.drawImage(player.image, player.x, player.y, player.width, player.height);
      }
    }
    
    // Actualizar enemigos
    function updateEnemies() {
      for (const enemy of enemies) {
        // Movimiento de los enemigos
        if (enemy.type.includes('wolfBoss')) {
          // Movimiento del jefe
          enemy.x += enemy.speed * enemy.direction;
          
          // Cambiar direcci√≥n al llegar a los l√≠mites
          if (enemy.x < 100 || enemy.x > canvas.width - enemy.width - 100) {
            enemy.direction *= -1;
          }
          
          // Ataque del jefe
          enemy.attackCooldown++;
          if (enemy.attackCooldown >= bossAttackInterval) {
            enemy.attackCooldown = 0;
            
            // Crear bola de fuego
            bossFireballs.push({
              x: enemy.x + enemy.width / 2,
              y: enemy.y + enemy.height / 2,
              radius: 15,
              speed: 7,
              direction: enemy.direction,
              targetY: player.y + player.height / 2
            });
            
            // Mostrar advertencia
            document.getElementById('fireWarning').style.display = 'block';
            setTimeout(() => {
              document.getElementById('fireWarning').style.display = 'none';
            }, 2000);
          }
          
          // Efecto de destello cuando cambia de imagen
          if (bossIsFlashing) {
            bossFlashTimer++;
            if (bossFlashTimer >= bossFlashDuration) {
              bossIsFlashing = false;
              bossFlashTimer = 0;
              enemy.image = bossEnraged ? images.wolfAttack : images.wolf;
            }
          }
        } else {
          // Movimiento de enemigos normales
          enemy.x += enemy.speed * enemy.direction;
          
          // Cambiar direcci√≥n al llegar a los l√≠mites
          if (enemy.x < 0 || enemy.x > canvas.width - enemy.width) {
            enemy.direction *= -1;
          }
        }
      }
    }
    
    // Dibujar enemigos
    function drawEnemies() {
      for (const enemy of enemies) {
        // Dibujar sombra
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.fillRect(enemy.x + 5, enemy.y + enemy.height + 2, enemy.width - 10, 10);
        
        // Dibujar enemigo
        if (enemy.direction === 1) {
          ctx.drawImage(enemy.image, enemy.x, enemy.y, enemy.width, enemy.height);
        } else {
          ctx.save();
          ctx.scale(-1, 1);
          ctx.drawImage(enemy.image, -enemy.x - enemy.width, enemy.y, enemy.width, enemy.height);
          ctx.restore();
        }
        
        // Dibujar barra de salud para el jefe
        if (enemy.type.includes('wolfBoss')) {
          const barWidth = enemy.width;
          const barHeight = 8;
          const healthPercent = enemy.health / enemy.maxHealth;
          
          ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
          ctx.fillRect(enemy.x, enemy.y - 15, barWidth, barHeight);
          
          ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
          ctx.fillRect(enemy.x, enemy.y - 15, barWidth * healthPercent, barHeight);
        }
      }
    }
    
    // Actualizar b√∫hos
    function updateOwls() {
      // Generar b√∫hos en niveles posteriores
      if (currentLevel === 2 && currentSubLevel >= 2) {
        owlSpawnTimer++;
        if (owlSpawnTimer >= owlSpawnInterval) {
          owlSpawnTimer = 0;
          
          // Crear b√∫ho en una posici√≥n aleatoria arriba
          createOwl(Math.random() * canvas.width, -50);
        }
      }
      
      // Actualizar b√∫hos existentes
      for (let i = owlEnemies.length - 1; i >= 0; i--) {
        const owl = owlEnemies[i];
        
        // Movimiento en forma de onda
        owl.x += owl.speed * owl.direction;
        owl.y += owl.verticalSpeed * owl.verticalDirection;
        
        // Cambiar direcci√≥n vertical
        if (owl.y < 50 || owl.y > canvas.height / 2) {
          owl.verticalDirection *= -1;
        }
        
        // Eliminar b√∫hos que salen de la pantalla
        if (owl.x < -100 || owl.x > canvas.width + 100) {
          owlEnemies.splice(i, 1);
        }
      }
    }
    
    // Dibujar b√∫hos
    function drawOwls() {
      for (const owl of owlEnemies) {
        // Dibujar b√∫ho
        if (owl.direction === 1) {
          ctx.drawImage(owl.image, owl.x, owl.y, owl.width, owl.height);
        } else {
          ctx.save();
          ctx.scale(-1, 1);
          ctx.drawImage(owl.image, -owl.x - owl.width, owl.y, owl.width, owl.height);
          ctx.restore();
        }
      }
    }
    
    // Actualizar bolas de fuego del jefe
    function updateBossFireballs() {
      for (let i = bossFireballs.length - 1; i >= 0; i--) {
        const fireball = bossFireballs[i];
        
        // Movimiento
        fireball.x += fireball.speed * fireball.direction;
        
        // Seguir al jugador en Y
        if (fireball.y < fireball.targetY) {
          fireball.y += 2;
        } else if (fireball.y > fireball.targetY) {
          fireball.y -= 2;
        }
        
        // Eliminar bolas de fuego que salen de la pantalla
        if (fireball.x < -50 || fireball.x > canvas.width + 50) {
          bossFireballs.splice(i, 1);
        }
      }
    }
    
    // Dibujar bolas de fuego del jefe
    function drawBossFireballs() {
      for (const fireball of bossFireballs) {
        // Dibujar fuego
        ctx.fillStyle = 'rgba(255, 100, 0, 0.8)';
        ctx.beginPath();
        ctx.arc(fireball.x, fireball.y, fireball.radius, 0, Math.PI * 2);
        ctx.fill();
        
        // Dibujar borde de fuego
        ctx.fillStyle = 'rgba(255, 255, 0, 0.9)';
        ctx.beginPath();
        ctx.arc(fireball.x, fireball.y, fireball.radius * 0.7, 0, Math.PI * 2);
        ctx.fill();
        
        // Dibujar n√∫cleo de fuego
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(fireball.x, fireball.y, fireball.radius * 0.4, 0, Math.PI * 2);
        ctx.fill();
      }
    }
    
    // Actualizar coleccionables
    function updateCollectibles() {
      for (const collectible of collectibles) {
        // Rotaci√≥n o animaci√≥n
        collectible.y += Math.sin(Date.now() / 500) * 0.5;
      }
    }
    
    // Dibujar coleccionables
    function drawCollectibles() {
      for (const collectible of collectibles) {
        if (!collectible.collected) {
          ctx.drawImage(collectible.image, collectible.x, collectible.y, collectible.width, collectible.height);
        }
      }
    }
    
    // Actualizar proyectiles
    function updateProjectiles() {
      for (let i = projectiles.length - 1; i >= 0; i--) {
        const projectile = projectiles[i];
        
        // Movimiento
        projectile.x += projectile.speed * projectile.direction;
        
        // Eliminar proyectiles que salen de la pantalla
        if (projectile.x < -50 || projectile.x > canvas.width + 50) {
          projectiles.splice(i, 1);
        }
      }
    }
    
    // Dibujar proyectiles
    function drawProjectiles() {
      for (const projectile of projectiles) {
        ctx.fillStyle = projectile.color;
        ctx.beginPath();
        ctx.arc(projectile.x, projectile.y, projectile.radius, 0, Math.PI * 2);
        ctx.fill();
      }
    }
    
    // Dibujar plataformas
    function drawPlatforms() {
      for (const platform of platforms) {
        // Dibujar plataforma
        ctx.fillStyle = '#8B4513';
        ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
        
        // Dibujar textura de hierba en la parte superior
        ctx.fillStyle = '#228B22';
        ctx.fillRect(platform.x, platform.y, platform.width, 10);
        
        // Dibujar detalles de hierba
        ctx.fillStyle = '#32CD32';
        for (let i = 0; i < platform.width; i += 15) {
          const height = 5 + Math.random() * 10;
          ctx.fillRect(platform.x + i, platform.y - height, 3, height);
        }
      }
    }
    
    // Comprobar colisiones
    function checkCollisions() {
      // Colisi√≥n con coleccionables
      for (const collectible of collectibles) {
        if (
          !collectible.collected &&
          player.x < collectible.x + collectible.width &&
          player.x + player.width > collectible.x &&
          player.y < collectible.y + collectible.height &&
          player.y + player.height > collectible.y
        ) {
          collectible.collected = true;
          playSound('collect');
          
          if (collectible.type === 'heart') {
            heartsCollected++;
            score += 100;
          }
          
          updateUI();
        }
      }
      
      // Colisi√≥n con enemigos
      for (const enemy of enemies) {
        if (
          player.x < enemy.x + enemy.width &&
          player.x + player.width > enemy.x &&
          player.y < enemy.y + enemy.height &&
          player.y + player.height > enemy.y
        ) {
          // El jugador est√° atacando
          if (player.isAttacking) {
            playSound('hit');
            enemy.health--;
            
            if (enemy.type.includes('wolfBoss')) {
              bossHealth = enemy.health;
              updateBossHealth();
              
              // Efecto de destello
              bossIsFlashing = true;
              enemy.image = images.wolfHurt;
            }
            
            if (enemy.health <= 0) {
              // Eliminar enemigo
              const index = enemies.indexOf(enemy);
              if (index > -1) {
                enemies.splice(index, 1);
              }
              
              score += enemy.type.includes('wolfBoss') ? 500 : 200;
              updateUI();
            }
          } else if (!player.unicornMode) {
            // El jugador es golpeado
            playerLoseLife();
          }
        }
      }
      
      // Colisi√≥n con b√∫hos
      for (let i = owlEnemies.length - 1; i >= 0; i--) {
        const owl = owlEnemies[i];
        
        if (
          player.x < owl.x + owl.width &&
          player.x + player.width > owl.x &&
          player.y < owl.y + owl.height &&
          player.y + player.height > owl.y
        ) {
          // El jugador est√° atacando
          if (player.isAttacking) {
            playSound('hit');
            owlEnemies.splice(i, 1);
            score += 150;
            updateUI();
          } else if (!player.unicornMode) {
            // El jugador es golpeado
            playerLoseLife();
          }
        }
      }
      
      // Colisi√≥n con bolas de fuego
      for (let i = bossFireballs.length - 1; i >= 0; i--) {
        const fireball = bossFireballs[i];
        
        if (
          player.x < fireball.x + fireball.radius &&
          player.x + player.width > fireball.x - fireball.radius &&
          player.y < fireball.y + fireball.radius &&
          player.y + player.height > fireball.y - fireball.radius
        ) {
          // El jugador es golpeado
          bossFireballs.splice(i, 1);
          
          if (!player.unicornMode) {
            playerLoseLife();
          }
        }
      }
    }
    
    // El jugador pierde una vida
    function playerLoseLife() {
      lives--;
      playSound('hit');
      updateUI();
      
      if (lives <= 0) {
        // Game over
        gameOver();
      } else {
        // Reiniciar posici√≥n
        player.x = 100;
        player.y = 300;
        player.velocityX = 0;
        player.velocityY = 0;
      }
    }
    
    // Comprobar si se complet√≥ el nivel
    function checkLevelCompletion() {
      // Completar nivel 1-1: recolectar 2 corazones
      if (currentLevel === 1 && currentSubLevel === 1 && heartsCollected >= 2) {
        nextLevel();
      }
      
      // Completar nivel 1-2: derrotar al lobo
      if (currentLevel === 1 && currentSubLevel === 2 && enemies.length === 0) {
        nextLevel();
      }
      
      // Completar nivel 2-1: recolectar 3 corazones
      if (currentLevel === 2 && currentSubLevel === 1 && heartsCollected >= 3) {
        nextLevel();
      }
      
      // Completar nivel 2-2: derrotar al lobo jefe
      if (currentLevel === 2 && currentSubLevel === 2 && enemies.length === 0) {
        nextLevel();
      }
      
      // Completar nivel 2-3: derrotar al lobo jefe enfurecido
      if (currentLevel === 2 && currentSubLevel === 3 && enemies.length === 0) {
        victory();
      }
    }
    
    // Pasar al siguiente nivel
    function nextLevel() {
      // Efecto de transici√≥n
      const transition = document.getElementById('levelTransition');
      transition.style.display = 'block';
      
      let opacity = 0;
      const fadeIn = setInterval(() => {
        opacity += 0.05;
        transition.style.opacity = opacity;
        
        if (opacity >= 1) {
          clearInterval(fadeIn);
          
          // Cambiar de nivel
          if (currentSubLevel < 3) {
            currentSubLevel++;
          } else {
            currentLevel++;
            currentSubLevel = 1;
          }
          
          resetLevel();
          
          // Efecto de desvanecimiento
          const fadeOut = setInterval(() => {
            opacity -= 0.05;
            transition.style.opacity = opacity;
            
            if (opacity <= 0) {
              clearInterval(fadeOut);
              transition.style.display = 'none';
            }
          }, 50);
        }
      }, 50);
    }
    
    // Victoria
    function victory() {
      if (!victoryMusicPlayed) {
        stopSound('bossBattle');
        playSound('victory');
        victoryMusicPlayed = true;
      }
      
      // Mostrar pantalla de victoria
      document.getElementById('victoryScreen').style.display = 'flex';
      document.getElementById('finalScore').textContent = score;
    }
    
    // Game over
    function gameOver() {
      // Reiniciar juego
      lives = 3;
      score = 0;
      currentLevel = 1;
      currentSubLevel = 1;
      heartsCollected = 0;
      
      // Mostrar pantalla de inicio
      document.getElementById('startScreen').style.display = 'flex';
      gameStarted = false;
      
      // Detener m√∫sica
      stopSound('background');
      stopSound('bossBattle');
    }
    
    // Reiniciar juego
    function restartGame() {
      // Ocultar pantalla de victoria
      document.getElementById('victoryScreen').style.display = 'none';
      
      // Reiniciar variables
      lives = 3;
      score = 0;
      currentLevel = 1;
      currentSubLevel = 1;
      heartsCollected = 0;
      victoryMusicPlayed = false;
      
      // Detener m√∫sica de victoria
      stopSound('victory');
      
      // Iniciar juego
      startGame();
    }
    
    // Actualizar temporizadores
    function updateTimers() {
      // Actualizar temporizador de destello del jefe
      if (bossIsFlashing) {
        bossFlashTimer++;
        if (bossFlashTimer >= bossFlashDuration) {
          bossIsFlashing = false;
          bossFlashTimer = 0;
          
          // Restaurar imagen del jefe
          for (const enemy of enemies) {
            if (enemy.type.includes('wolfBoss')) {
              enemy.image = bossEnraged ? images.wolfAttack : images.wolf;
            }
          }
        }
      }
    }
    
    // Iniciar cuando se carga la p√°gina
    window.addEventListener('load', init);
  </script>
</body>
</html>
