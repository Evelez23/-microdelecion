<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oso Abrazos - Aventura Completa</title>
  <style>
    body {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      text-align: center;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    
    h1 {
      font-size: 2.5rem;
      text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5);
      color: #FFD700;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 1.2rem;
      margin-bottom: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .game-wrapper {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    
    #gameContainer {
      position: relative;
      width: 800px;
      height: 500px;
      border: 5px solid #FFD700;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
    }
    
    #gameCanvas {
      display: block;
    }
    
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      text-align: left;
      font-size: 16px;
      z-index: 10;
    }
    
    .power-bar {
      width: 100px;
      height: 12px;
      background: #444;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 5px;
    }
    
    .power-level {
      height: 100%;
      background: linear-gradient(to right, #FF69B4, #FF1493);
      width: 100%;
      border-radius: 6px;
      transition: width 0.3s;
    }
    
    #levelIndicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      z-index: 10;
    }
    
    #startScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 20;
    }
    
    #coverImage {
      width: 300px;
      height: 200px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 3px solid #FFD700;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }
    
    #startButton, .storybook-btn, .celebration-btn {
      background: linear-gradient(to bottom, #FFD700, #FF9800);
      border: none;
      padding: 15px 30px;
      font-size: 1.2rem;
      border-radius: 50px;
      color: #8B4513;
      font-weight: bold;
      cursor: pointer;
      margin: 10px;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    #startButton:hover, .storybook-btn:hover, .celebration-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }
    
    #hint {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 10;
    }
    
    #soundToggle {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid white;
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 5;
    }
    
    .mobile-controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: flex;
      gap: 20px;
      opacity: 0.8;
      z-index: 10;
    }
    
    .mobile-controls-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .mobile-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      font-size: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .mobile-label {
      color: white;
      font-size: 0.8rem;
      text-shadow: 1px 1px 2px black;
    }
    
    #storybook {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 25;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
      text-align: center;
      overflow-y: auto;
    }
    
    .storybook-content {
      max-width: 700px;
      max-height: 90%;
      overflow-y: auto;
      padding: 20px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 15px;
      border: 2px solid #FFD700;
    }
    
    .storybook-images {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
    }
    
    .storybook-images img {
      width: 100px;
      height: 100px;
      border: 2px solid #FFD700;
      border-radius: 10px;
      object-fit: cover;
    }
    
    .storybook-controls {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* üî• Estilos para el jefe */
    .boss-health {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 400px;
      height: 25px;
      background: #333;
      border-radius: 12px;
      overflow: hidden;
      z-index: 15;
      border: 3px solid #fff;
      display: none;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
    }

    .boss-health-bar {
      height: 100%;
      background: linear-gradient(to right, #ff0000, #ff6600, #ffcc00);
      width: 100%;
      transition: width 0.5s;
      position: relative;
    }

    .boss-health-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      z-index: 16;
    }

    /* ‚ö° Animaci√≥n de advertencia de fuego */
    .fire-warning {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background: linear-gradient(to top, rgba(255, 0, 0, 0.3), transparent);
      z-index: 14;
      display: none;
      animation: warningPulse 0.5s infinite;
    }

    @keyframes warningPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.8; }
    }

    /* üíù Animaci√≥n de corazones brillantes */
    @keyframes heartGlow {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.1); filter: brightness(1.3); }
    }

    .heart-collectible {
      animation: heartGlow 1s infinite;
    }

    /* üéÜ Animaci√≥n de victoria mejorada */
    .victory-animation {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.4), rgba(255, 140, 0, 0.2));
      z-index: 30;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      text-align: center;
    }

    .victory-title {
      font-size: 4rem;
      margin-bottom: 20px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
      color: #FFD700;
      animation: victoryBounce 1s ease-in-out infinite alternate;
    }

    @keyframes victoryBounce {
      0% { transform: scale(1); }
      100% { transform: scale(1.05); }
    }

    /* üê∫ Animaci√≥n de enfado del lobo */
    .boss-enraged {
      animation: enrageShake 0.3s infinite;
    }

    @keyframes enrageShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px) rotate(-2deg); }
      75% { transform: translateX(5px) rotate(2deg); }
    }

    #loadingScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      z-index: 35;
    }
    
    .progress-bar {
      width: 300px;
      height: 20px;
      background: #555;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background: #4CAF50;
      width: 0%;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <h1>üêª Oso Abrazos - Aventura Completa</h1>
  <p class="subtitle">¬°Ayuda al Oso Abrazos a derrotar al Lobo Feroz en 6 niveles emocionantes!</p>
  
  <div class="game-wrapper">
    <div id="gameContainer">
      <canvas id="gameCanvas" width="800" height="500"></canvas>

      <!-- UI Mejorada -->
      <div id="ui">
        <div>Puntos: <span id="score">0</span></div>
        <div>Vidas: <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
        <div>Nivel: <span id="level">1-1</span></div>
        <div id="unicornPower" style="display: none;">
          <span>ü¶Ñ Poder del Unicornio:</span>
          <div class="power-bar">
              <div class="power-level" id="unicornPowerLevel"></div>
          </div>
        </div>
        <div id="heartsCollected" style="display: none;">
          <span>üíï Corazones: <span id="heartCount">0</span>/3</span>
        </div>
      </div>

      <!-- üê∫ Barra de salud del jefe -->
      <div id="bossHealth" class="boss-health">
        <div class="boss-health-bar" id="bossHealthBar">
          <div class="boss-health-text">üê∫ Lobo Feroz - Vida: <span id="bossHealthText">5/5</span></div>
        </div>
      </div>

      <!-- ‚ö° Advertencia de fuego -->
      <div id="fireWarning" class="fire-warning">
        <div style="text-align: center; color: white; font-weight: bold; padding-top: 10px;">
          ‚ö†Ô∏è ¬°CUIDADO! El lobo va a atacar con fuego ‚ö†Ô∏è
        </div>
      </div>

      <div id="levelIndicator" class="level-indicator">Nivel 1-1</div>

      <!-- Pantalla de inicio con nueva m√∫sica -->
      <div id="startScreen">
        <img id="coverImage" src="" alt="Portada del Juego">
        <button id="startButton">üéÆ ¬°Comenzar Aventura!</button>
      </div>
      
      <!-- Pantalla de carga -->
      <div id="loadingScreen">
        <h2>Cargando recursos del juego...</h2>
        <div class="progress-bar">
          <div class="progress" id="loadingProgress"></div>
        </div>
        <p id="loadingText">0%</p>
        <div id="loadingDetails" style="margin-top: 20px;"></div>
      </div>

      <!-- Pantalla de victoria mejorada -->
      <div id="victoryScreen" class="victory-animation">
        <h2 class="victory-title">üéâ ¬°VICTORIA! üéâ</h2>
        <p style="font-size: 1.5rem; margin-bottom: 20px;">¬°Has derrotado al Lobo Feroz!</p>
        <div style="font-size: 1.2rem; margin-bottom: 30px;">
          <p>Puntuaci√≥n Final: <span id="finalScore">0</span></p>
          <p>Corazones Recolectados: <span id="finalHearts">0</span></p>
        </div>
        <button id="nextLevelBtn" class="celebration-btn">üöÄ ¬°Jugar de nuevo!</button>
      </div>

      <!-- Storybook mejorado -->
      <div id="storybook" style="display: none;">
        <div class="storybook-content">
          <h2>üêª Oso Abrazos vs. üê∫ El Lobo Feroz</h2>
          <p>¬°El malvado Lobo Feroz ha invadido el bosque y quiere acabar con todos los abrazos!</p>
          <p>Debes recolectar <strong>3 corazones m√°gicos</strong> para invocar al Unicornio de la Amistad.</p>
          
          <div class="storybook-images">
            <img id="storyEnemy1" alt="Enemigo 1">
            <img id="storyEnemy2" alt="Enemigo 2">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxs="#FF1493" d="M466.4 245.9c42.6-37.4 45.1-99.2 5.8-138.4s-87.7-45.6-127.8-10.2l-32.3 28.7-32.3-28.7c-40.1-35.4-103.4-20.4-127.8 10.2s-36.8 101 5.8 138.4l176.1 156.1c4.4 3.9 10.8 3.9 15.2 0l176.1-156.1z"/></svg>" alt="Coraz√≥n">
            <img id="storyUnicorn" alt="Unicornio">
          </div>
          
          <p>üî• <strong>El lobo tiene 5 puntos de vida</strong> y lanzar√° fuego desde su boca.</p>
          <p>üíï <strong>¬°Recolecta corazones para invocar al unicornio!</strong></p>
          <p>ü¶Ñ <strong>Con el unicornio puedes disparar rayos de amistad</strong> para derrotar al lobo.</p>
          <p>‚ö†Ô∏è <strong>¬°Ten cuidado!</strong> 5 disparos del lobo te derrotar√°n.</p>
          
          <h3>Controles:</h3>
          <p>‚¨ÖÔ∏è ‚û°Ô∏è : Moverse izquierda/derecha</p>
          <p>‚¨ÜÔ∏è : Saltar</p>
          <p>ESPACIO : Abrazar</p>
          <p>Z : Disparar (con unicornio)</p>
          
          <div class="storybook-controls">
            <button id="startGame" class="storybook-btn">üí™ ¬°Entendido! ¬°A salvar el bosque!</button>
            <button id="backToMenu" class="storybook-btn">üìã Volver al men√∫</button>
          </div>
        </div>
      </div>

      <div id="hint">Ac√©rcate a los amigos y presiona ESPACIO para abrazarlos</div>
      <button id="soundToggle">üîä</button>

      <!-- Controles m√≥viles -->
      <div class="mobile-controls">
        <div class="mobile-controls-column">
          <button class="mobile-btn" id="leftBtn">‚¨Ö</button>
          <div class="mobile-label">Izquierda</div>
          
          <button class="mobile-btn" id="rightBtn">‚û°</button>
          <div class="mobile-label">Derecha</div>
          
          <button class="mobile-btn" id="jumpBtn">‚¨Ü</button>
          <div class="mobile-label">Saltar</div>
        </div>
        
        <div class="mobile-controls-column">
          <button class="mobile-btn" id="hugBtn">ü§ó</button>
          <div class="mobile-label">Abrazar</div>
          
          <button class="mobile-btn" id="fireBtn">üí´</button>
          <div class="mobile-label">Disparar</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Script de inicializaci√≥n -->
  <script>
    // URLs base para las im√°genes
    const baseUrl = "https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img";
    
    // Sprites
    const sprites = {
      idle: new Image(),
      walk: new Image(),
      jump: new Image(),
      run: new Image(),
      crouch: new Image(),
      hug: new Image(),
      cover: new Image(),
      squirrel: new Image(),
      rabbit: new Image(),
      bird: new Image(),
      enemy1: new Image(),
      enemy2: new Image(),
      enemy3: new Image(),
      // Fondos de nivel
      background_1_1: new Image(),
      background_1_2: new Image(),
      background_1_3: new Image(),
      background_2_1: new Image(),
      background_2_2: new Image(),
      background_2_3: new Image(),
      // Jefe y elementos especiales
      boss: new Image(),
      heart: new Image(),
      fire: new Image(),
      unicorn: new Image(),
      honey: new Image(),
      osoyuni: new Image()  // Nueva imagen de oso con unicornio
    };
    
    // URLs de las im√°genes
    const imageUrls = {
      idle: `${baseUrl}/oso/oso_idle.svg`,
      walk: `${baseUrl}/oso/oso_walk.svg`,
      jump: `${baseUrl}/oso/oso_jump.svg`,
      run: `${baseUrl}/oso/oso_run.svg`,
      crouch: `${baseUrl}/oso/oso_sit.svg`,
      hug: `${baseUrl}/oso/oso_hugging.svg`,
      cover: `${baseUrl}/oso/oso_portada.png`,
      squirrel: `${baseUrl}/Amigos/ardilla.png`,
      rabbit: `${baseUrl}/Amigos/conejo.png`,
      bird: `${baseUrl}/Amigos/pajarito.png`,
      enemy1: `${baseUrl}/enemigos/Enemigos-01.svg`,
      enemy2: `${baseUrl}/enemigos/Enemigos-02.svg`,
      enemy3: `${baseUrl}/enemigos/Enemigos-03.svg`,
      // Fondos de nivel
      background_1_1: `${baseUrl}/fondos/bosque1.jpg`,
      background_1_2: `${baseUrl}/fondos/bosque2.jpg`,
      background_1_3: `${baseUrl}/fondos/bosque3.jpg`,
      background_2_1: `${baseUrl}/fondos/bosque4.jpg`,
      background_2_2: `${baseUrl}/fondos/background_1_2.jpeg`,
      background_2_3: `${baseUrl}/fondos/background final.jpeg`,
      // Jefe y elementos especiales
      boss: `${baseUrl}/enemigos/loboferoz.png`,
      heart: `${baseUrl}/Amigos/lovepower.png`,
      fire: `${baseUrl}/enemigos/fire.png`,
      unicorn: `${baseUrl}/Amigos/unirshup.png`,
      honey: `${baseUrl}/Amigos/miel.png`,
      osoyuni: `${baseUrl}/Amigos/osoyuni.png`  // Nueva imagen de oso con unicornio
    };

    // Sonidos
    const sounds = {
      background: new Audio(`${baseUrl}/sounds/background.mp3.mp3`),
      jump: new Audio(`${baseUrl}/sounds/jump.mp3.mp3`),
      collect: new Audio(`${baseUrl}/sounds/collect.mp3.mp3`),
      hug: new Audio(`${baseUrl}/sounds/hug.mp3.mp3`),
      hurt: new Audio(`${baseUrl}/sounds/hurt.mp3.mp3`),
      enemy: new Audio(`${baseUrl}/sounds/enemy.mp3.mp3`),
      powerup: new Audio(`${baseUrl}/sounds/powerup.mp3.mp3`)
    };

    // Configurar sonidos
    for (let key in sounds) {
      sounds[key].volume = 0.6;
      sounds[key].preload = 'auto';
    }
    sounds.background.loop = true;

    // Variables para el estado de carga
    let totalResources = Object.keys(imageUrls).length;
    let loadedResources = 0;
    let failedResources = 0;

    // Esperar a que se cargue la p√°gina
    window.addEventListener('load', function() {
      console.log("üéÆ Inicializando juego Oso Abrazos...");
      
      // Inicializar variables globales
      window.gameState = {
        gameStarted: false,
        currentLevel: "1-1",
        score: 0,
        lives: 3,
        heartsCollected: 0,
        soundEnabled: true,
        bossFight: false
      };
      
      window.oso = {
        x: 100, y: 380,
        width: 80, height: 80,
        vx: 0, vy: 0,
        speed: 5,
        jumpForce: 15,
        gravity: 0.7,
        grounded: false,
        hugging: false,
        hugCooldown: 0,
        direction: 1,
        action: "idle",
        hasUnicorn: false,
        invincible: 0
      };
      
      window.boss = {
        x: 600, y: 350,
        width: 120, height: 120,
        health: 5,
        maxHealth: 5,
        enraged: false,
        phase: 1,
        attackCooldown: 0,
        warningTimer: 0,
        fireballs: []
      };
      
      window.unicorn = {
        active: false,
        power: 0,
        cooldown: 0
      };
      
      window.platforms = [];
      window.friends = [];
      window.enemies = [];
      window.items = [];
      window.hearts = [];
      window.projectiles = [];
      window.particles = [];
      window.keys = {};
      
      // Definir niveles
      window.LEVELS = {
        "1-1": { name: "Bosque Inicial", friends: 3, enemies: 2, items: 2, hasBoss: false },
        "1-2": { name: "Claro Soleado", friends: 4, enemies: 3, items: 3, hasBoss: false },
        "1-3": { name: "Cueva Misteriosa", friends: 5, enemies: 4, items: 4, hasBoss: false },
        "2-1": { name: "Monta√±as Altas", friends: 4, enemies: 5, items: 3, hasBoss: false },
        "2-2": { name: "Cascada Brillante", friends: 5, enemies: 5, items: 4, hasBoss: false },
        "2-3": { name: "Guarida del Lobo", friends: 0, enemies: 0, items: 0, hasBoss: true }
      };
      
      // Obtener referencias a elementos del DOM
      const gameCanvas = document.getElementById('gameCanvas');
      const startScreen = document.getElementById('startScreen');
      const startButton = document.getElementById('startButton');
      const victoryScreen = document.getElementById('victoryScreen');
      const nextLevelBtn = document.getElementById('nextLevelBtn');
      const storybook = document.getElementById('storybook');
      const startGameBtn = document.getElementById('startGame');
      const backToMenuBtn = document.getElementById('backToMenu');
      const soundToggle = document.getElementById('soundToggle');
      const hintElement = document.getElementById('hint');
      const loadingScreen = document.getElementById('loadingScreen');
      const loadingProgress = document.getElementById('loadingProgress');
      const loadingText = document.getElementById('loadingText');
      const loadingDetails = document.getElementById('loadingDetails');
      const coverImage = document.getElementById('coverImage');
      
      // Configurar canvas
      if (gameCanvas) {
        window.gameCtx = gameCanvas.getContext('2d');
      }
      
      // Configurar botones
      if (startButton) {
        startButton.addEventListener('click', function() {
          showStorybook();
        });
      }
      
      if (startGameBtn) {
        startGameBtn.addEventListener('click', startGame);
      }
      
      if (backToMenuBtn) {
        backToMenuBtn.addEventListener('click', backToMenu);
      }
      
      if (nextLevelBtn) {
        nextLevelBtn.addEventListener('click', nextLevel);
      }
      
      if (soundToggle) {
        soundToggle.addEventListener('click', toggleSound);
      }
      
      // Configurar controles t√°ctiles
      const leftBtn = document.getElementById('leftBtn');
      const rightBtn = document.getElementById('rightBtn');
      const jumpBtn = document.getElementById('jumpBtn');
      const hugBtn = document.getElementById('hugBtn');
      const fireBtn = document.getElementById('fireBtn');
      
      if (leftBtn) leftBtn.addEventListener('touchstart', () => window.keys["ArrowLeft"] = true);
      if (leftBtn) leftBtn.addEventListener('touchend', () => window.keys["ArrowLeft"] = false);
      
      if (rightBtn) rightBtn.addEventListener('touchstart', () => window.keys["ArrowRight"] = true);
      if (rightBtn) rightBtn.addEventListener('touchend', () => window.keys["ArrowRight"] = false);
      
      if (jumpBtn) jumpBtn.addEventListener('touchstart', () => {
        window.keys["ArrowUp"] = true;
        setTimeout(() => { window.keys["ArrowUp"] = false; }, 200);
      });
      
      if (hugBtn) hugBtn.addEventListener('touchstart', () => {
        window.keys[" "] = true;
        setTimeout(() => { window.keys[" "] = false; }, 200);
      });
      
      if (fireBtn) fireBtn.addEventListener('touchstart', () => {
        window.keys["z"] = true;
        setTimeout(() => { window.keys["z"] = false; }, 200);
      });
      
      // Configurar controles de teclado
      document.addEventListener('keydown', (e) => {
        // Prevenir la acci√≥n por defecto para la barra espaciadora
        if (e.code === 'Space') {
          e.preventDefault();
        }
        window.keys[e.key] = true;
      });
      
      document.addEventListener('keyup', (e) => {
        window.keys[e.key] = false;
      });
      
      // Precargar recursos
      loadResources();
      
      console.log("‚úÖ Juego inicializado correctamente");
    });
    
    // Funci√≥n para mostrar el storybook
    function showStorybook() {
      const startScreen = document.getElementById('startScreen');
      const storybook = document.getElementById('storybook');
      
      if (startScreen) startScreen.style.display = 'none';
      if (storybook) storybook.style.display = 'flex';
    }
    
    // Funci√≥n para volver al men√∫
    function backToMenu() {
      const storybook = document.getElementById('storybook');
      const startScreen = document.getElementById('startScreen');
      
      if (storybook) storybook.style.display = 'none';
      if (startScreen) startScreen.style.display = 'flex';
    }
    
    // Funci√≥n para iniciar el juego
    function startGame() {
      const storybook = document.getElementById('storybook');
      if (storybook) storybook.style.display = 'none';
      
      window.gameState.gameStarted = true;
      window.gameState.score = 0;
      window.gameState.lives = 3;
      window.gameState.heartsCollected = 0;
      
      // Iniciar m√∫sica de fondo si est√° habilitada
      if (window.gameState.soundEnabled) {
        sounds.background.play().catch(e => console.log("Audio autoplay prevented: ", e));
      }
      
      // Configurar nivel inicial
      setupLevel("1-1");
      
      // Iniciar bucle del juego
      if (!window.gameLoopRunning) {
        window.gameLoopRunning = true;
        gameLoop();
      }
    }
    
    // Funci√≥n para el siguiente nivel
    function nextLevel() {
      const victoryScreen = document.getElementById('victoryScreen');
      if (victoryScreen) victoryScreen.style.display = 'none';
      
      const nextLevelKey = getNextLevel(window.gameState.currentLevel);
      
      if (nextLevelKey) {
        setupLevel(nextLevelKey);
      } else {
        // Reiniciar juego si no hay m√°s niveles
        startGame();
      }
    }
    
    // Funci√≥n para alternar sonido
    function toggleSound() {
      window.gameState.soundEnabled = !window.gameState.soundEnabled;
      const soundToggle = document.getElementById('soundToggle');
      
      if (soundToggle) {
        soundToggle.textContent = window.gameState.soundEnabled ? "üîä" : "üîá";
      }
      
      if (window.gameState.soundEnabled) {
        sounds.background.play().catch(e => console.log("Audio autoplay prevented: ", e));
      } else {
        sounds.background.pause();
      }
    }
    
    // Funci√≥n para mostrar indicaciones
    function showHint(text, duration) {
      const hintElement = document.getElementById('hint');
      if (!hintElement) return;
      
      hintElement.textContent = text;
      hintElement.style.opacity = '1';
      
      setTimeout(() => {
        hintElement.style.opacity = '0';
      }, duration);
    }

    // Funci√≥n para reproducir sonido
    function playSound(soundName) {
      if (window.gameState.soundEnabled && sounds[soundName]) {
        // Crear una nueva instancia para permitir sonidos superpuestos
        const sound = new Audio(sounds[soundName].src);
        sound.volume = sounds[soundName].volume;
        sound.play().catch(e => console.log("Sound error: ", e));
      }
    }

    // Precargar recursos
    function loadResources() {
      const loadingScreen = document.getElementById('loadingScreen');
      const loadingProgress = document.getElementById('loadingProgress');
      const loadingText = document.getElementById('loadingText');
      const loadingDetails = document.getElementById('loadingDetails');
      const startScreen = document.getElementById('startScreen');
      const coverImage = document.getElementById('coverImage');
      
      for (let key in imageUrls) {
        sprites[key].onload = () => {
          loadedResources++;
          const progress = Math.floor((loadedResources / totalResources) * 100);
          if (loadingProgress) loadingProgress.style.width = `${progress}%`;
          if (loadingText) loadingText.textContent = `${progress}%`;
          
          if (loadedResources === totalResources) {
            setTimeout(() => {
              if (loadingScreen) loadingScreen.style.display = "none";
              if (startScreen) startScreen.style.display = "flex";
              
              // Mostrar imagen de portada
              if (coverImage) coverImage.src = imageUrls.cover;
              
              // Preparar im√°genes para el storybook
              document.getElementById('storyEnemy1').src = imageUrls.enemy1;
              document.getElementById('storyEnemy2').src = imageUrls.enemy2;
              document.getElementById('storyUnicorn').src = imageUrls.unicorn;
            }, 500);
          }
        };
        
        sprites[key].onerror = () => {
          loadedResources++;
          failedResources++;
          
          const progress = Math.floor((loadedResources / totalResources) * 100);
          if (loadingProgress) loadingProgress.style.width = `${progress}%`;
          if (loadingText) loadingText.textContent = `${progress}%`;
          
          if (loadingDetails) {
            loadingDetails.innerHTML += `<p>Error cargando: ${key} - <a href="${imageUrls[key]}" target="_blank">Ver URL</a></p>`;
          }
          
          if (loadedResources === totalResources) {
            if (loadingScreen) loadingScreen.style.display = "none";
            if (startScreen) startScreen.style.display = "flex";
            
            // Mostrar advertencia si hay errores
            if (failedResources > 0) {
              alert(`‚ö†Ô∏è Algunos recursos no se pudieron cargar (${failedResources}/${totalResources}). El juego puede no verse correctamente.`);
            }
          }
        };
        
        sprites[key].src = imageUrls[key];
      }
    }

    // ============= FUNCIONES PRINCIPALES DEL JUEGO =============
    function setupLevel(levelKey) {
      console.log(`üéØ Configurando nivel: ${levelKey}`);
      
      const level = window.LEVELS[levelKey];
      if (!level) {
        console.error("‚ùå Nivel no encontrado:", levelKey);
        return;
      }
      
      window.gameState.currentLevel = levelKey;
      window.gameState.bossFight = level.hasBoss;
      
      // Actualizar UI
      const levelElement = document.getElementById('level');
      if (levelElement) {
        levelElement.textContent = `${levelKey} - ${level.name}`;
      }
      
      const levelIndicator = document.getElementById('levelIndicator');
      if (levelIndicator) {
        levelIndicator.textContent = `Nivel ${levelKey}`;
      }
      
      if (level.hasBoss) {
        setupBossLevel();
      } else {
        setupNormalLevel(level);
      }
    }

    function setupNormalLevel(level) {
      console.log("üå≤ Configurando nivel normal");
      
      // Ocultar elementos de jefe
      const bossHealthElement = document.getElementById('bossHealth');
      const fireWarningElement = document.getElementById('fireWarning');
      const heartsCollectedElement = document.getElementById('heartsCollected');
      const unicornPowerElement = document.getElementById('unicornPower');
      
      if (bossHealthElement) bossHealthElement.style.display = 'none';
      if (fireWarningElement) fireWarningElement.style.display = 'none';
      if (heartsCollectedElement) heartsCollectedElement.style.display = 'none';
      if (unicornPowerElement) unicornPowerElement.style.display = 'none';
      
      // Configurar plataformas
      window.platforms = [
        { x: 0, y: 450, width: 800, height: 50 },
        { x: 200, y: 350, width: 100, height: 20 },
        { x: 400, y: 300, width: 100, height: 20 },
        { x: 600, y: 350, width: 100, height: 20 }
      ];
      
      // Configurar amigos
      window.friends = [];
      for (let i = 0; i < level.friends; i++) {
        const friendType = i % 3;
        let sprite;
        let friendName;
        
        switch (friendType) {
          case 0:
            sprite = sprites.squirrel;
            friendName = "ardilla";
            break;
          case 1:
            sprite = sprites.rabbit;
            friendName = "conejo";
            break;
          case 2:
            sprite = sprites.bird;
            friendName = "p√°jaro";
            break;
        }
        
        window.friends.push({
          x: 150 + i * 150,
          y: 380,
          width: 50,
          height: 50,
          sprite: sprite,
          type: friendType,
          name: friendName,
          hugged: false,
          floating: 0,
          floatDir: Math.random() > 0.5 ? 1 : -1
        });
      }
      
      // Configurar enemigos (SIEMPRE en el lado derecho, alejados del oso)
      window.enemies = [];
      for (let i = 0; i < level.enemies; i++) {
        const enemyType = i % 3;
        let sprite;
        
        switch (enemyType) {
          case 0:
            sprite = sprites.enemy1;
            break;
          case 1:
            sprite = sprites.enemy2;
            break;
          case 2:
            sprite = sprites.enemy3;
            break;
        }
        
        // Enemigos siempre en el lado derecho (a partir de 400px)
        window.enemies.push({
          x: 500 + i * 100, // Siempre en el lado derecho
          y: 380,
          width: 60,
          height: 60,
          sprite: sprite,
          direction: -1, // SIEMPRE mirando hacia la izquierda (hacia el oso)
          speed: 2,
          damage: 1,
          moveRange: 150,
          startX: 500 + i * 100
        });
      }
      
      // Configurar items (miel)
      window.items = [];
      for (let i = 0; i < level.items; i++) {
        window.items.push({
          x: 150 + i * 200,
          y: 250,
          width: 30,
          height: 30,
          collected: false
        });
      }
      
      // Configurar corazones
      window.hearts = [];
      for (let i = 0; i < 3; i++) {
        window.hearts.push({
          x: 250 + i * 200,
          y: 300,
          width: 30,
          height: 30,
          collected: false
        });
      }
      
      // Configurar posici√≥n del oso (SIEMPRE en el lado izquierdo)
      window.oso.x = 100;
      window.oso.y = 380;
      window.oso.vx = 0;
      window.oso.vy = 0;
      window.oso.grounded = false;
      window.oso.hugging = false;
      window.oso.hasUnicorn = false;
      
      // Configurar unicornio
      window.unicorn.active = false;
      window.unicorn.power = 0;
      
      // Limpiar proyectiles y part√≠culas
      window.projectiles = [];
      window.particles = [];
      
      // Mostrar indicaci√≥n
      showHint("Ac√©rcate a los amigos y presiona ESPACIO para abrazarlos", 5000);
    }

    function setupBossLevel() {
      console.log("üê∫ Configurando nivel de jefe");
      
      // Mostrar elementos de jefe
      const bossHealthElement = document.getElementById('bossHealth');
      const heartsCollectedElement = document.getElementById('heartsCollected');
      const unicornPowerElement = document.getElementById('unicornPower');
      
      if (bossHealthElement) bossHealthElement.style.display = 'block';
      if (heartsCollectedElement) heartsCollectedElement.style.display = 'block';
      if (unicornPowerElement) unicornPowerElement.style.display = 'block';
      
      // Configurar plataformas para la batalla final
      window.platforms = [
        { x: 0, y: 450, width: 800, height: 50 },
        { x: 150, y: 350, width: 100, height: 20 },
        { x: 400, y: 250, width: 100, height: 20 },
        { x: 650, y: 350, width: 100, height: 20 }
      ];
      
      // Configurar jefe
      window.boss.x = 600;
      window.boss.y = 350;
      window.boss.health = window.boss.maxHealth;
      window.boss.enraged = false;
      window.boss.phase = 1;
      window.boss.attackCooldown = 100;
      window.boss.warningTimer = 0;
      window.boss.fireballs = [];
      
      // Configurar posici√≥n del oso (SIEMPRE en el lado izquierdo)
      window.oso.x = 100;
      window.oso.y = 380;
      window.oso.vx = 0;
      window.oso.vy = 0;
      window.oso.grounded = false;
      window.oso.hugging = false;
      window.oso.hasUnicorn = false;
      
      // Configurar unicornio
      window.unicorn.active = false;
      window.unicorn.power = 0;
      
      // Limpiar arrays
      window.friends = [];
      window.enemies = [];
      window.items = [];
      window.hearts = [];
      window.projectiles = [];
      window.particles = [];
      
      // Actualizar barra de salud del jefe
      updateBossHealth();
      
      // Mostrar indicaci√≥n
      showHint("¬°Cuidado! El lobo lanzar√° bolas de fuego. Usa el poder del unicornio para atacar.", 5000);
    }

    function updateBossHealth() {
      const bossHealthBar = document.getElementById('bossHealthBar');
      const bossHealthText = document.getElementById('bossHealthText');
      
      if (bossHealthBar && bossHealthText) {
        const healthPercent = (window.boss.health / window.boss.maxHealth) * 100;
        bossHealthBar.style.width = `${healthPercent}%`;
        bossHealthText.textContent = `${window.boss.health}/${window.boss.maxHealth}`;
        
        // Cambiar color seg√∫n la salud
        if (healthPercent < 30) {
          bossHealthBar.style.background = 'linear-gradient(to right, #ff0000, #ff3300)';
        } else if (healthPercent < 60) {
          bossHealthBar.style.background = 'linear-gradient(to right, #ff6600, #ff9900)';
        } else {
          bossHealthBar.style.background = 'linear-gradient(to right, #ff0000, #ff6600, #ffcc00)';
        }
      }
    }

    function checkCollision(obj1, obj2) {
      return obj1.x < obj2.x + obj2.width &&
             obj1.x + obj1.width > obj2.x &&
             obj1.y < obj2.y + obj2.height &&
             obj1.y + obj1.height > obj2.y;
    }

    function gameLoop() {
      if (!window.gameState || !window.gameState.gameStarted) {
        requestAnimationFrame(gameLoop);
        return;
      }
      
      update();
      draw();
      
      // Continuar el bucle
      requestAnimationFrame(gameLoop);
    }

    function update() {
      // Actualizar amigos (animaci√≥n flotante)
      for (let friend of window.friends) {
        friend.floating += 0.05;
        friend.y += Math.sin(friend.floating) * 0.5 * friend.floatDir;
      }
      
      // Actualizar enemigos (movimiento)
      for (let enemy of window.enemies) {
        // Mover enemigos de un lado a otro
        enemy.x += enemy.speed * enemy.direction;
        
        // Cambiar direcci√≥n si llegan al l√≠mite de su rango
        if (Math.abs(enemy.x - enemy.startX) > enemy.moveRange) {
          enemy.direction *= -1;
        }
        
        // Colisi√≥n con enemigos
        if (checkCollision(window.oso, enemy) && !window.oso.hugging && window.oso.invincible <= 0) {
          takeDamage(enemy.damage);
        }
      }
      
      // Actualizar posici√≥n del oso
      updateOso();
      
      // Actualizar proyectiles
      for (let i = window.projectiles.length - 1; i >= 0; i--) {
        const proj = window.projectiles[i];
        proj.x += proj.vx;
        
        // Eliminar proyectiles fuera de pantalla
        if (proj.x < 0 || proj.x > 800) {
          window.projectiles.splice(i, 1);
          continue;
        }
        
        // Comprobar colisi√≥n de proyectiles con enemigos
        if (proj.type === 'unicorn') {
          for (let j = window.enemies.length - 1; j >= 0; j--) {
            const enemy = window.enemies[j];
            if (Math.abs(proj.x - (enemy.x + enemy.width/2)) < proj.radius + enemy.width/2 &&
                Math.abs(proj.y - (enemy.y + enemy.height/2)) < proj.radius + enemy.height/2) {
              // Eliminar enemigo y proyectil
              window.enemies.splice(j, 1);
              window.projectiles.splice(i, 1);
              window.gameState.score += 50;
              createParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, 15, '#FF69B4');
              break;
            }
          }
        }
      }
      
      // Actualizar part√≠culas
      for (let i = window.particles.length - 1; i >= 0; i--) {
        const p = window.particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life--;
        
        if (p.life <= 0) {
          window.particles.splice(i, 1);
        }
      }
      
      // Comprobar condiciones de victoria/derrota
      checkGameConditions();
      
      // Actualizar UI
      updateUI();
    }

    function updateOso() {
      // Aplicar gravedad
      window.oso.vy += window.oso.gravity;
      
      // Movimiento horizontal
      if (window.keys["ArrowLeft"] || window.keys["a"]) {
        window.oso.vx = -window.oso.speed;
        window.oso.direction = -1;
      } else if (window.keys["ArrowRight"] || window.keys["d"]) {
        window.oso.vx = window.oso.speed;
        window.oso.direction = 1;
      } else {
        window.oso.vx *= 0.8; // Fricci√≥n
      }
      
      // Saltar
      if ((window.keys["ArrowUp"] || window.keys["w"]) && window.oso.grounded) {
        window.oso.vy = -window.oso.jumpForce;
        window.oso.grounded = false;
        playSound("jump");
      }
      
      // Abrazar
      if (window.keys[" "] && window.oso.hugCooldown <= 0 && window.oso.grounded) {
        window.oso.hugging = true;
        window.oso.hugCooldown = 30;
        playSound("hug");
        
        // Comprobar colisi√≥n con amigos
        for (let friend of window.friends) {
          if (!friend.hugged && checkCollision(window.oso, friend)) {
            friend.hugged = true;
            window.gameState.score += 100;
            createParticles(friend.x + friend.width/2, friend.y + friend.height/2, 10, '#FF69B4');
            playSound("collect");
          }
        }
      } else {
        window.oso.hugging = false;
        if (window.oso.hugCooldown > 0) window.oso.hugCooldown--;
      }
      
      // Disparar con unicornio
      if ((window.keys["z"] || window.keys["Z"]) && window.unicorn.active && window.unicorn.cooldown <= 0 && window.unicorn.power > 0) {
        window.projectiles.push({
          x: window.oso.x + window.oso.width/2,
          y: window.oso.y + window.oso.height/2,
          vx: window.oso.direction * 10,
          vy: 0,
          radius: 8,
          type: 'unicorn',
          damage: 1
        });
        
        window.unicorn.cooldown = 15;
        window.unicorn.power -= 5;
        
        if (window.unicorn.power <= 0) {
          window.unicorn.active = false;
          window.oso.hasUnicorn = false;
        }
        
        playSound("enemy");
      }
      
      if (window.unicorn.cooldown > 0) window.unicorn.cooldown--;
      
      // Actualizar posici√≥n
      window.oso.x += window.oso.vx;
      window.oso.y += window.oso.vy;
      
      // Limitar a los bordes de la pantalla
      if (window.oso.x < 0) window.oso.x = 0;
      if (window.oso.x > 800 - window.oso.width) window.oso.x = 800 - window.oso.width;
      if (window.oso.y > 500) {
        // Caer fuera de la pantalla
        window.oso.y = 100;
        window.oso.x = 100;
        takeDamage(1);
      }
      
      // Comprobar colisi√≥n con plataformas
      window.oso.grounded = false;
      for (let platform of window.platforms) {
        if (window.oso.x + window.oso.width > platform.x && 
            window.oso.x < platform.x + platform.width &&
            window.oso.y + window.oso.height > platform.y && 
            window.oso.y + window.oso.height < platform.y + 10) {
          window.oso.y = platform.y - window.oso.height;
          window.oso.vy = 0;
          window.oso.grounded = true;
        }
      }
      
      // Comprobar colisi√≥n con enemigos
      if (window.oso.invincible <= 0) {
        for (let enemy of window.enemies) {
          if (checkCollision(window.oso, enemy)) {
            takeDamage(enemy.damage);
            window.oso.invincible = 60; // 1 segundo de invencibilidad
          }
        }
      } else {
        window.oso.invincible--;
      }
      
      // Comprobar colisi√≥n con corazones
      for (let heart of window.hearts) {
        if (!heart.collected && checkCollision(window.oso, heart)) {
          heart.collected = true;
          window.gameState.heartsCollected++;
          window.gameState.score += 50;
          createParticles(heart.x + heart.width/2, heart.y + heart.height/2, 15, '#FF69B4');
          playSound("collect");
          
          // Si se recolectan 3 corazones, activar unicornio
          if (window.gameState.heartsCollected >= 3 && !window.unicorn.active) {
            window.unicorn.active = true;
            window.oso.hasUnicorn = true;
            window.unicorn.power = 100;
            const unicornPowerElement = document.getElementById('unicornPower');
            if (unicornPowerElement) unicornPowerElement.style.display = 'block';
            showHint("¬°Unicornio de la Amistad activado! Presiona Z para disparar rayos de amistad.", 5000);
          }
        }
      }
      
      // Comprobar colisi√≥n con items (miel)
      for (let item of window.items) {
        if (!item.collected && checkCollision(window.oso, item)) {
          item.collected = true;
          window.gameState.score += 30;
          createParticles(item.x + item.width/2, item.y + item.height/2, 8, '#FF9800');
          playSound("powerup");
        }
      }
    }

    function draw() {
      const ctx = window.gameCtx;
      const canvas = document.getElementById('gameCanvas');
      
      if (!ctx || !canvas) {
        console.error("‚ùå Canvas no encontrado");
        return;
      }
      
      // Limpiar canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Dibujar fondo seg√∫n el nivel
      const bgImage = sprites[`background_${window.gameState.currentLevel.replace('-', '_')}`];
      if (bgImage && bgImage.complete) {
        ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
      } else {
        // Fondo por defecto si la imagen no est√° cargada
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, "#87CEEB");
        gradient.addColorStop(1, "#E0F7FA");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
      
      // Dibujar plataformas
      for (let platform of window.platforms) {
        ctx.fillStyle = '#8D6E63';
        ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
        ctx.fillStyle = '#5D4037';
        ctx.fillRect(platform.x, platform.y, platform.width, 5);
      }
      
      // Dibujar items (miel)
      for (let item of window.items) {
        if (!item.collected) {
          if (sprites.honey && sprites.honey.complete) {
            ctx.drawImage(sprites.honey, item.x, item.y, item.width, item.height);
          } else {
            ctx.fillStyle = '#FFB300';
            ctx.beginPath();
            ctx.arc(item.x + item.width/2, item.y + item.height/2, item.width/2, 0, Math.PI * 2);
            ctx.fill();
          }
        }
      }
      
      // Dibujar amigos
      for (let friend of window.friends) {
        if (!friend.hugged && friend.sprite && friend.sprite.complete) {
          ctx.drawImage(friend.sprite, friend.x, friend.y, friend.width, friend.height);
        }
      }
      
      // Dibujar enemigos (SIEMPRE mirando hacia la izquierda)
      for (let enemy of window.enemies) {
        if (enemy.sprite && enemy.sprite.complete) {
          // Enemigos siempre mirando hacia la izquierda (hacia el oso)
          ctx.save();
          ctx.scale(-1, 1);
          ctx.drawImage(enemy.sprite, -enemy.x - enemy.width, enemy.y, enemy.width, enemy.height);
          ctx.restore();
        } else {
          // Placeholder si el sprite no est√° cargado
          ctx.fillStyle = '#F44336';
          ctx.beginPath();
          ctx.arc(enemy.x + enemy.width/2, enemy.y + enemy.height/2, enemy.width/2, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      
      // Dibujar corazones
      for (let heart of window.hearts) {
        if (!heart.collected) {
          if (sprites.heart && sprites.heart.complete) {
            ctx.drawImage(sprites.heart, heart.x, heart.y, heart.width, heart.height);
          } else {
            ctx.fillStyle = '#FF69B4';
            ctx.beginPath();
            ctx.moveTo(heart.x + heart.width/2, heart.y);
            ctx.bezierCurveTo(
              heart.x + heart.width, heart.y,
              heart.x + heart.width, heart.y + heart.height,
              heart.x + heart.width/2, heart.y + heart.height
            );
            ctx.bezierCurveTo(
              heart.x, heart.y + heart.height,
              heart.x, heart.y,
              heart.x + heart.width/2, heart.y
            );
            ctx.fill();
          }
        }
      }
      
      // Dibujar proyectiles
      for (let proj of window.projectiles) {
        if (proj.type === 'unicorn') {
          ctx.fillStyle = '#9370DB';
          ctx.beginPath();
          ctx.arc(proj.x, proj.y, proj.radius, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      
      // Dibujar part√≠culas
      for (let particle of window.particles) {
        ctx.globalAlpha = particle.life / particle.maxLife;
        ctx.fillStyle = particle.color;
        ctx.beginPath();
        ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.globalAlpha = 1;
      
      // Dibujar jefe si est√° activo
      if (window.gameState.bossFight) {
        if (sprites.boss && sprites.boss.complete) {
          // Jefe siempre mirando hacia la izquierda (hacia el oso)
          ctx.save();
          ctx.scale(-1, 1);
          ctx.drawImage(sprites.boss, -window.boss.x - window.boss.width, window.boss.y, window.boss.width, window.boss.height);
          ctx.restore();
        } else {
          ctx.fillStyle = window.boss.enraged ? '#FF0000' : '#808080';
          ctx.fillRect(window.boss.x, window.boss.y, window.boss.width, window.boss.height);
        }
        
        // Dibujar bolas de fuego del jefe
        for (let fireball of window.boss.fireballs) {
          if (sprites.fire && sprites.fire.complete) {
            ctx.drawImage(sprites.fire, fireball.x - fireball.radius, fireball.y - fireball.radius, fireball.radius * 2, fireball.radius * 2);
          } else {
            ctx.fillStyle = '#FF4500';
            ctx.beginPath();
            ctx.arc(fireball.x, fireball.y, fireball.radius, 0, Math.PI * 2);
            ctx.fill();
          }
        }
      }
      
      // Dibujar oso - CON UNICORNIO si est√° activo
      if (window.oso.hasUnicorn && sprites.osoyuni && sprites.osoyuni.complete) {
        // Usar imagen de oso con unicornio
        ctx.save();
        if (window.oso.direction === -1) {
          ctx.scale(-1, 1);
          ctx.drawImage(sprites.osoyuni, -window.oso.x - window.oso.width, window.oso.y, window.oso.width, window.oso.height);
        } else {
          ctx.drawImage(sprites.osoyuni, window.oso.x, window.oso.y, window.oso.width, window.oso.height);
        }
        ctx.restore();
      } else {
        // Dibujar oso normal
        let osoSprite = sprites.idle;
        
        if (window.oso.hugging) {
          osoSprite = sprites.hug;
        } else if (!window.oso.grounded) {
          osoSprite = sprites.jump;
        } else if (Math.abs(window.oso.vx) > 0) {
          osoSprite = window.oso.vx > window.oso.speed * 0.7 ? sprites.run : sprites.walk;
        }
        
        if (osoSprite && osoSprite.complete) {
          // Voltear sprite seg√∫n la direcci√≥n
          ctx.save();
          if (window.oso.direction === -1) {
            ctx.scale(-1, 1);
            ctx.drawImage(osoSprite, -window.oso.x - window.oso.width, window.oso.y, window.oso.width, window.oso.height);
          } else {
            ctx.drawImage(osoSprite, window.oso.x, window.oso.y, window.oso.width, window.oso.height);
          }
          ctx.restore();
        } else {
          // Dibujar placeholder si el sprite no est√° cargado
          ctx.fillStyle = '#8B4513';
          ctx.fillRect(window.oso.x, window.oso.y, window.oso.width, window.oso.height);
        }
      }
      
      // Efecto de abrazo
      if (window.oso.hugging) {
        ctx.strokeStyle = "#FFD700";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(window.oso.x + window.oso.width/2, window.oso.y + window.oso.height/2, 60, 0, Math.PI * 2);
        ctx.stroke();
      }
    }

    function takeDamage(amount) {
      if (window.oso.invincible > 0) return;
      
      window.gameState.lives -= amount;
      playSound("hurt");
      
      if (window.gameState.lives <= 0) {
        window.gameState.lives = 0;
        gameOver();
      }
      
      // Efecto de parpadeo al recibir da√±o
      window.oso.invincible = 60;
    }

    function createParticles(x, y, count, color) {
      for (let i = 0; i < count; i++) {
        window.particles.push({
          x: x,
          y: y,
          vx: (Math.random() - 0.5) * 5,
          vy: (Math.random() - 0.5) * 5,
          size: Math.random() * 5 + 2,
          color: color,
          life: 30,
          maxLife: 30
        });
      }
    }

    function updateUI() {
      // Actualizar puntuaci√≥n
      const scoreElement = document.getElementById('score');
      if (scoreElement) {
        scoreElement.textContent = window.gameState.score;
      }
      
      // Actualizar vidas
      const livesElement = document.getElementById('lives');
      if (livesElement) {
        let livesText = '';
        for (let i = 0; i < window.gameState.lives; i++) {
          livesText += '‚ù§Ô∏è';
        }
        livesElement.textContent = livesText;
      }
      
      // Actualizar nivel
      const levelElement = document.getElementById('level');
      if (levelElement) {
        levelElement.textContent = window.gameState.currentLevel;
      }
      
      // Actualizar poder del unicornio
      const unicornPowerLevelElement = document.getElementById('unicornPowerLevel');
      if (unicornPowerLevelElement) {
        unicornPowerLevelElement.style.width = `${window.unicorn.power}%`;
      }
      
      // Actualizar corazones recolectados
      const heartCountElement = document.getElementById('heartCount');
      if (heartCountElement) {
        heartCountElement.textContent = window.gameState.heartsCollected;
      }
    }

    function checkGameConditions() {
      // Comprobar victoria en nivel normal
      if (!window.gameState.bossFight) {
        const allFriendsHugged = window.friends.every(friend => friend.hugged);
        if (allFriendsHugged && window.friends.length > 0) {
          levelComplete();
        }
      }
      
      // Comprobar victoria en jefe
      if (window.gameState.bossFight && window.boss.health <= 0) {
        victory();
      }
    }

    function levelComplete() {
      console.log("‚úÖ Nivel completado");
      window.gameState.gameStarted = false;
      
      // Mostrar mensaje de nivel completado
      showHint("¬°Nivel completado! Pr√≥ximo nivel...", 3000);
      
      // Avanzar al siguiente nivel despu√©s de un breve retraso
      setTimeout(() => {
        const nextLevelKey = getNextLevel(window.gameState.currentLevel);
        if (nextLevelKey) {
          setupLevel(nextLevelKey);
          window.gameState.gameStarted = true;
        } else {
          // No hay m√°s niveles, reiniciar juego
          startGame();
        }
      }, 3000);
    }

    function victory() {
      console.log("üéâ ¬°Victoria!");
      window.gameState.gameStarted = false;
      
      const victoryScreen = document.getElementById('victoryScreen');
      const finalScore = document.getElementById('finalScore');
      const finalHearts = document.getElementById('finalHearts');
      
      if (victoryScreen) victoryScreen.style.display = 'flex';
      if (finalScore) finalScore.textContent = window.gameState.score;
      if (finalHearts) finalHearts.textContent = window.gameState.heartsCollected;
      
      // Reproducir sonido de victoria
      playSound("collect");
    }

    function gameOver() {
      console.log("üíÄ Game Over");
      window.gameState.gameStarted = false;
      
      showHint("¬°Game Over! Presiona F5 para reintentar.", 5000);
    }

    function getNextLevel(currentLevel) {
      const levelKeys = Object.keys(window.LEVELS);
      const currentIndex = levelKeys.indexOf(currentLevel);
      
      if (currentIndex < levelKeys.length - 1) {
        return levelKeys[currentIndex + 1];
      }
      
      return null; // No hay m√°s niveles
    }
  </script>
</body>
</html>
