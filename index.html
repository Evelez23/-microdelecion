<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Oso Abrazos - Aventura Completa</title>
  <style>
    body {
      margin: 0;
      background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
      font-family: 'Comic Sans MS', cursive, sans-serif;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    
    #gameContainer {
      position: relative;
      width: 800px;
    }
    
    #gameCanvas {
      background: linear-gradient(to bottom, #a3e0a0, #8bc34a);
      border: 5px solid #5a3921;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    }
    
    #ui {
      position: absolute;
      top: 15px;
      left: 15px;
      color: #fff;
      font-size: 18px;
      text-shadow: 2px 2px 0 #000;
      z-index: 10;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 10px;
    }
    
    #startScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      z-index: 20;
    }
    
    #startScreen h1 {
      font-size: 48px;
      color: #FFD700;
      margin-bottom: 20px;
      text-shadow: 3px 3px 0 #000;
    }
    
    #startScreen p {
      font-size: 20px;
      margin-bottom: 30px;
      text-align: center;
      max-width: 80%;
    }
    
    #startButton {
      padding: 15px 30px;
      font-size: 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Comic Sans MS', cursive;
      box-shadow: 0 5px #2E7D32;
      transition: all 0.1s;
      margin-bottom: 20px;
    }
    
    #startButton:hover {
      background: #66BB6A;
    }
    
    #startButton:active {
      box-shadow: 0 2px #2E7D32;
      transform: translateY(3px);
    }
    
    #controls {
      margin-top: 20px;
      font-size: 16px;
      text-align: center;
      background: rgba(255, 255, 255, 0.2);
      padding: 10px;
      border-radius: 10px;
    }
    
    .heart {
      display: inline-block;
      color: #FF5252;
      margin: 0 2px;
      font-size: 20px;
    }
    
    #loadingScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      z-index: 30;
    }
    
    .progress-bar {
      width: 300px;
      height: 20px;
      background: #555;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background: #4CAF50;
      width: 0%;
      transition: width 0.3s;
    }
    
    .friend-info {
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
      color: #333;
      max-width: 80%;
    }
    
    .friend-example {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 15px 0;
    }
    
    .friend-demo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .friend-demo::after {
      content: "¡Abrazame!";
      position: absolute;
      bottom: -25px;
      font-size: 10px;
      white-space: nowrap;
      color: #FFF;
      text-shadow: 1px 1px 1px #000;
    }
    
    #hint {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.8);
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 14px;
      color: #333;
      display: none;
      z-index: 25;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="500"></canvas>
    <div id="ui">
      <div>Puntos: <span id="score">0</span></div>
      <div>Vidas: <span id="lives">❤️❤️❤️</span></div>
      <div>Nivel: <span id="level">1</span></div>
    </div>
    <div id="startScreen">
      <h1>Oso Abrazos Adventure</h1>
      <img id="coverImage" src="" alt="Oso Abrazos Game Cover" style="width: 80%; max-width: 400px; border-radius: 10px; margin-bottom: 20px; display: none;">
      <p>¡Ayuda al Oso Abrazos a recolectar miel y abrazar a todos sus amigos!<br>Pero cuidado con las abejas enfadadas...</p>
      <button id="startButton">¡Comenzar Aventura!</button>
      <div id="controls">
        <p>Controles:<br>Flechas o WASD para moverte<br>ESPACIO para abrazar</p>
      </div>
      <div class="friend-info">
        <p>Encuentra a estos amigos y abrázalos con la tecla ESPACIO:</p>
        <div class="friend-example">
          <div class="friend-demo" style="background: #4FC3F7;"></div>
          <div class="friend-demo" style="background: #BA68C8;"></div>
          <div class="friend-demo" style="background: #4DB6AC;"></div>
        </div>
        <p>¡Cada amigo abrazado te da 100 puntos!</p>
      </div>
    </div>
    <div id="loadingScreen">
      <h2>Cargando...</h2>
      <div class="progress-bar">
        <div class="progress" id="loadingProgress"></div>
      </div>
      <p id="loadingText">0%</p>
    </div>
    <div id="hint">Acércate a los amigos (círculos de colores) y presiona ESPACIO para abrazarlos</div>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const scoreElement = document.getElementById("score");
    const livesElement = document.getElementById("lives");
    const levelElement = document.getElementById("level");
    const startScreen = document.getElementById("startScreen");
    const startButton = document.getElementById("startButton");
    const loadingScreen = document.getElementById("loadingScreen");
    const loadingProgress = document.getElementById("loadingProgress");
    const loadingText = document.getElementById("loadingText");
    const coverImage = document.getElementById("coverImage");
    const hintElement = document.getElementById("hint");

    // URLs base para las imágenes
    const baseUrl = "https://raw.githubusercontent.com/Evelez23/-microdelecion/main/img";
    
    // Sprites
    const sprites = {
      idle: new Image(),
      walk: new Image(),
      jump: new Image(),
      run: new Image(),
      crouch: new Image(),
      hug: new Image(),
      cover: new Image()
    };
    
    // URLs de las imágenes
    const imageUrls = {
      idle: `${baseUrl}/oso/oso_idle.svg`,
      walk: `${baseUrl}/oso/oso_walk.svg`,
      jump: `${baseUrl}/oso/oso_jump.svg`,
      run: `${baseUrl}/oso/oso_run.svg`,
      crouch: `${baseUrl}/oso/oso_sit.svg`,
      hug: `${baseUrl}/oso/oso_hugging.svg`,
      cover: `${baseUrl}/oso/oso_portada.jpg`
    };

    // Estado del juego
    let gameState = {
      score: 0,
      lives: 3,
      level: 1,
      gameStarted: false
    };

    // Estado del oso
    let oso = {
      x: 100,
      y: 380,
      width: 80,
      height: 80,
      vx: 0,
      vy: 0,
      speed: 5,
      jumpForce: 15,
      gravity: 0.7,
      grounded: true,
      action: "idle",
      direction: 1, // 1: derecha, -1: izquierda
      hugging: false,
      hugCooldown: 0,
      invincible: 0
    };

    // Elementos del juego
    let platforms = [
      {x: 0, y: 450, width: 800, height: 50},
      {x: 200, y: 350, width: 100, height: 20},
      {x: 400, y: 300, width: 100, height: 20},
      {x: 600, y: 250, width: 100, height: 20}
    ];

    let friends = [];
    let enemies = [];
    let items = [];
    let particles = [];
    let hintTimer = 0;

    // Teclas
    let keys = {};
    window.addEventListener("keydown", e => {
      keys[e.key] = true;
      // Prevenir scroll con las flechas
      if(["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].includes(e.key)) {
        e.preventDefault();
      }
    });
    window.addEventListener("keyup", e => keys[e.key] = false);

    // Iniciar juego
    startButton.addEventListener("click", startGame);

    // Precargar recursos
    let totalResources = Object.keys(imageUrls).length;
    let loadedResources = 0;

    function loadResources() {
      for (let key in imageUrls) {
        sprites[key].onload = () => {
          loadedResources++;
          const progress = Math.floor((loadedResources / totalResources) * 100);
          loadingProgress.style.width = `${progress}%`;
          loadingText.textContent = `${progress}%`;
          
          if (loadedResources === totalResources) {
            loadingScreen.style.display = "none";
            startScreen.style.display = "flex";
            
            // Mostrar imagen de portada
            coverImage.src = imageUrls.cover;
            coverImage.style.display = "block";
          }
        };
        sprites[key].onerror = () => {
          console.error(`Error loading image: ${imageUrls[key]}`);
          loadedResources++;
          if (loadedResources === totalResources) {
            loadingScreen.style.display = "none";
            startScreen.style.display = "flex";
          }
        };
        sprites[key].src = imageUrls[key];
      }
    }

    function startGame() {
      gameState.gameStarted = true;
      startScreen.style.display = "none";
      resetLevel();
      
      // Mostrar pista al inicio del juego
      showHint("Acércate a los amigos (círculos de colores) y presiona ESPACIO para abrazarlos", 5000);
      
      gameLoop();
    }

    function resetLevel() {
      // Reiniciar posición del oso
      oso.x = 100;
      oso.y = 380;
      oso.vx = 0;
      oso.vy = 0;
      oso.action = "idle";
      oso.hugging = false;
      oso.invincible = 0;
      
      // Generar amigos (círculos azules, morados y verdes)
      friends = [];
      for (let i = 0; i < 5 + gameState.level; i++) {
        friends.push({
          x: Math.random() * 700 + 50,
          y: 380,
          width: 60,
          height: 60,
          hugged: false,
          type: Math.floor(Math.random() * 3), // Diferentes tipos de amigos
          floating: 0,
          floatDir: Math.random() > 0.5 ? 1 : -1
        });
      }
      
      // Generar enemigos en niveles más altos
      enemies = [];
      if (gameState.level > 1) {
        for (let i = 0; i < gameState.level - 1; i++) {
          enemies.push({
            x: Math.random() * 700 + 50,
            y: 380,
            width: 50,
            height: 50,
            vx: Math.random() > 0.5 ? 2 : -2
          });
        }
      }
      
      // Generar items (miel)
      items = [];
      for (let i = 0; i < 3 + gameState.level; i++) {
        items.push({
          x: Math.random() * 700 + 50,
          y: Math.random() * 300 + 100,
          width: 30,
          height: 30,
          collected: false
        });
      }
    }

    function showHint(text, duration) {
      hintElement.textContent = text;
      hintElement.style.display = "block";
      hintTimer = duration / 16.67; // Convertir ms a frames (approx 60fps)
    }

    function update() {
      if (!gameState.gameStarted) return;
      
      // Actualizar temporizador de pista
      if (hintTimer > 0) {
        hintTimer--;
        if (hintTimer <= 0) {
          hintElement.style.display = "none";
        }
      }
      
      // Reducir tiempo de invencibilidad
      if (oso.invincible > 0) oso.invincible--;
      
      // Movimiento lateral
      oso.vx = 0;
      if ((keys["ArrowRight"] || keys["d"]) && !oso.hugging) {
        oso.vx = oso.speed;
        oso.action = oso.grounded ? "run" : "jump";
        oso.direction = 1;
      } else if ((keys["ArrowLeft"] || keys["a"]) && !oso.hugging) {
        oso.vx = -oso.speed;
        oso.action = oso.grounded ? "run" : "jump";
        oso.direction = -1;
      } else if (!oso.hugging) {
        oso.action = oso.grounded ? "idle" : "jump";
      }
      
      // Salto
      if ((keys["ArrowUp"] || keys["w"]) && oso.grounded && !oso.hugging) {
        oso.vy = -oso.jumpForce;
        oso.grounded = false;
        oso.action = "jump";
        createParticles(oso.x + oso.width/2, oso.y + oso.height, 5, "#8BC34A");
      }
      
      // Abrazo (espacio)
      if (keys[" "] && oso.hugCooldown <= 0 && oso.grounded) {
        oso.action = "hug";
        oso.hugging = true;
        oso.hugCooldown = 30;
        oso.vx = 0;
        
        // Verificar si abraza a un amigo
        let huggedFriend = false;
        for (let friend of friends) {
          if (!friend.hugged && checkCollision(oso, friend)) {
            friend.hugged = true;
            gameState.score += 100;
            huggedFriend = true;
            createParticles(friend.x + friend.width/2, friend.y + friend.height/2, 10, "#FFD700");
            
            // Mostrar mensaje de puntos
            createTextParticle(friend.x + friend.width/2, friend.y, "+100", "#FFD700");
          }
        }
        
        if (!huggedFriend) {
          // Mostrar pista si no hay amigos cerca
          showHint("¡No hay amigos cerca! Busca los círculos de colores para abrazarlos", 3000);
        }
      }
      
      // Enfriamiento del abrazo
      if (oso.hugCooldown > 0) {
        oso.hugCooldown--;
        if (oso.hugCooldown === 0) {
          oso.hugging = false;
        }
      }
      
      // Aplicar gravedad
      oso.vy += oso.gravity;
      
      // Actualizar posición X
      oso.x += oso.vx;
      
      // Limitar movimiento horizontal
      if (oso.x < 0) oso.x = 0;
      if (oso.x + oso.width > canvas.width) oso.x = canvas.width - oso.width;
      
      // Actualizar posición Y
      oso.y += oso.vy;
      
      // Colisión con plataformas
      oso.grounded = false;
      for (let platform of platforms) {
        if (
          oso.x + oso.width > platform.x &&
          oso.x < platform.x + platform.width &&
          oso.y + oso.height > platform.y &&
          oso.y + oso.height <= platform.y + platform.height + oso.vy &&
          oso.vy > 0
        ) {
          oso.y = platform.y - oso.height;
          oso.vy = 0;
          oso.grounded = true;
          if (oso.action === "jump") oso.action = "idle";
        }
      }
      
      // Limitar movimiento vertical
      if (oso.y + oso.height > canvas.height) {
        oso.y = canvas.height - oso.height;
        oso.vy = 0;
        oso.grounded = true;
        if (oso.action === "jump") oso.action = "idle";
      }
      
      // Actualizar amigos (animación flotante)
      for (let friend of friends) {
        friend.floating += 0.05;
        friend.y += Math.sin(friend.floating) * 0.5 * friend.floatDir;
      }
      
      // Actualizar enemigos
      for (let enemy of enemies) {
        enemy.x += enemy.vx;
        
        // Rebotar en los bordes
        if (enemy.x <= 0 || enemy.x + enemy.width >= canvas.width) {
          enemy.vx *= -1;
        }
        
        // Colisión con enemigos
        if (checkCollision(oso, enemy) && !oso.hugging && oso.invincible <= 0) {
          hurtOso();
        }
        
        // Los enemigos pueden ser "curados" con abrazos
        if (checkCollision(oso, enemy) && oso.hugging) {
          enemy.vx = 0;
          createParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, 15, "#E91E63");
          enemies.splice(enemies.indexOf(enemy), 1);
          gameState.score += 200;
          createTextParticle(enemy.x + enemy.width/2, enemy.y, "+200", "#E91E63");
        }
      }
      
      // Recolectar items
      for (let item of items) {
        if (!item.collected && checkCollision(oso, item)) {
          item.collected = true;
          gameState.score += 50;
          createParticles(item.x + item.width/2, item.y + item.height/2, 8, "#FF9800");
          createTextParticle(item.x + item.width/2, item.y, "+50", "#FF9800");
        }
      }
      
      // Actualizar partículas
      for (let i = particles.length - 1; i >= 0; i--) {
        if (particles[i].type === 'text') {
          particles[i].y -= 1;
          particles[i].life--;
        } else {
          particles[i].x += particles[i].vx;
          particles[i].y += particles[i].vy;
          particles[i].life--;
        }
        
        if (particles[i].life <= 0) {
          particles.splice(i, 1);
        }
      }
      
      // Comprobar si todos los amigos han sido abrazados
      let allHugged = true;
      for (let friend of friends) {
        if (!friend.hugged) {
          allHugged = false;
          break;
        }
      }
      
      if (allHugged && friends.length > 0) {
        gameState.level++;
        levelElement.textContent = gameState.level;
        showHint(`¡Nivel ${gameState.level}! Encuentra y abraza a más amigos`, 3000);
        resetLevel();
      }
      
      // Actualizar UI
      scoreElement.textContent = gameState.score;
      livesElement.textContent = "❤️".repeat(gameState.lives);
    }

    // Función para dibujar el sprite
    function drawOsoSprite() {
      const sprite = sprites[oso.action] || sprites.idle;

      // Efecto de parpadeo cuando es invencible
      if (oso.invincible > 0 && oso.invincible % 6 < 3) {
        ctx.globalAlpha = 0.5;
      }

      if (sprite.complete) {
        ctx.save();
        if (oso.direction === -1) {
          ctx.scale(-1, 1);
          ctx.drawImage(sprite, -oso.x - oso.width, oso.y, oso.width, oso.height);
        } else {
          ctx.drawImage(sprite, oso.x, oso.y, oso.width, oso.height);
        }
        ctx.restore();
      } else {
        // Dibujar placeholder si el sprite no está cargado
        ctx.fillStyle = "#3E2723";
        ctx.fillRect(oso.x, oso.y, oso.width, oso.height);
      }
      
      ctx.globalAlpha = 1;
    }

    function draw() {
      if (!gameState.gameStarted) return;
      
      // Limpiar canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Dibujar fondo
      drawBackground();
      
      // Dibujar plataformas
      for (let platform of platforms) {
        ctx.fillStyle = "#8D6E63";
        ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
        ctx.fillStyle = "#5D4037";
        ctx.fillRect(platform.x, platform.y, platform.width, 5);
      }
      
      // Dibujar items
      for (let item of items) {
        if (!item.collected) {
          ctx.fillStyle = "#FFB300";
          ctx.beginPath();
          ctx.arc(item.x + item.width/2, item.y + item.height/2, item.width/2, 0, Math.PI * 2);
          ctx.fill();
          
          // Detalles de la miel
          ctx.strokeStyle = "#E65100";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(item.x + item.width/2, item.y + item.height/2, item.width/3, 0, Math.PI * 2);
          ctx.stroke();
        }
      }
      
      // Dibujar amigos (círculos azules, morados y verdes)
      for (let friend of friends) {
        if (!friend.hugged) {
          // Círculo de amigo
          ctx.fillStyle = ["#4FC3F7", "#BA68C8", "#4DB6AC"][friend.type];
          ctx.beginPath();
          ctx.arc(friend.x + friend.width/2, friend.y + friend.height/2, friend.width/2, 0, Math.PI * 2);
          ctx.fill();
          
          // Cara del amigo
          ctx.fillStyle = "#000";
          ctx.beginPath();
          ctx.arc(friend.x + friend.width/3, friend.y + friend.height/3, 5, 0, Math.PI * 2);
          ctx.arc(friend.x + 2*friend.width/3, friend.y + friend.height/3, 5, 0, Math.PI * 2);
          ctx.fill();
          
          // Sonrisa
          ctx.beginPath();
          ctx.arc(friend.x + friend.width/2, friend.y + 2*friend.height/3, 8, 0, Math.PI);
          ctx.stroke();
          
          // Dibujar corazón flotante sobre amigos no abrazados
          ctx.fillStyle = "#FF5252";
          ctx.beginPath();
          ctx.moveTo(friend.x + friend.width/2, friend.y - 15 + Math.sin(Date.now()/300) * 5);
          ctx.bezierCurveTo(
            friend.x + friend.width/2, friend.y - 25 + Math.sin(Date.now()/300) * 5,
            friend.x + friend.width/2 + 10, friend.y - 30 + Math.sin(Date.now()/300) * 5,
            friend.x + friend.width/2 + 10, friend.y - 20 + Math.sin(Date.now()/300) * 5
          );
          ctx.bezierCurveTo(
            friend.x + friend.width/2 + 10, friend.y - 15 + Math.sin(Date.now()/300) * 5,
            friend.x + friend.width/2, friend.y - 10 + Math.sin(Date.now()/300) * 5,
            friend.x + friend.width/2, friend.y - 15 + Math.sin(Date.now()/300) * 5
          );
          ctx.bezierCurveTo(
            friend.x + friend.width/2, friend.y - 10 + Math.sin(Date.now()/300) * 5,
            friend.x + friend.width/2 - 10, friend.y - 15 + Math.sin(Date.now()/300) * 5,
            friend.x + friend.width/2 - 10, friend.y - 20 + Math.sin(Date.now()/300) * 5
          );
          ctx.bezierCurveTo(
            friend.x + friend.width/2 - 10, friend.y - 30 + Math.sin(Date.now()/300) * 5,
            friend.x + friend.width/2, friend.y - 25 + Math.sin(Date.now()/300) * 5,
            friend.x + friend.width/2, friend.y - 15 + Math.sin(Date.now()/300) * 5
          );
          ctx.fill();
        }
      }
      
      // Dibujar enemigos
      for (let enemy of enemies) {
        ctx.fillStyle = "#F44336";
        ctx.beginPath();
        ctx.arc(enemy.x + enemy.width/2, enemy.y + enemy.height/2, enemy.width/2, 0, Math.PI * 2);
        ctx.fill();
        
        // Cara de enemigo
        ctx.fillStyle = "#000";
        ctx.beginPath();
        ctx.arc(enemy.x + enemy.width/3, enemy.y + enemy.height/3, 5, 0, Math.PI * 2);
        ctx.arc(enemy.x + 2*enemy.width/3, enemy.y + enemy.height/3, 5, 0, Math.PI * 2);
        ctx.fill();
        
        // Ceño fruncido
        ctx.beginPath();
        ctx.moveTo(enemy.x + enemy.width/3, enemy.y + 2*enemy.height/3);
        ctx.lineTo(enemy.x + 2*enemy.width/3, enemy.y + 2*enemy.height/3);
        ctx.stroke();
      }
      
      // Dibujar oso
      drawOsoSprite();
      
      // Dibujar partículas
      for (let particle of particles) {
        ctx.globalAlpha = particle.life / 30;
        ctx.fillStyle = particle.color;
        
        if (particle.type === 'text') {
          ctx.font = '16px Comic Sans MS';
          ctx.fillText(particle.text, particle.x, particle.y);
        } else {
          ctx.beginPath();
          ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      ctx.globalAlpha = 1;
      
      // Dibujar efecto de abrazo
      if (oso.hugging) {
        ctx.strokeStyle = "#FFD700";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(oso.x + oso.width/2, oso.y + oso.height/2, 60, 0, Math.PI * 2);
        ctx.stroke();
      }
    }

    function drawBackground() {
      // Cielo
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, "#87CEEB");
      gradient.addColorStop(1, "#E0F7FA");
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Nubes
      ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
      for (let i = 0; i < 5; i++) {
        const x = (Date.now() / 30000 + i * 0.2) % 1 * canvas.width * 2 - canvas.width;
        const y = 50 + i * 40;
        drawCloud(x, y);
      }
      
      // Montañas
      ctx.fillStyle = "#78909C";
      ctx.beginPath();
      ctx.moveTo(0, 400);
      ctx.lineTo(200, 400);
      ctx.lineTo(100, 300);
      ctx.fill();
      
      ctx.beginPath();
      ctx.moveTo(150, 400);
      ctx.lineTo(350, 400);
      ctx.lineTo(250, 280);
      ctx.fill();
      
      ctx.beginPath();
      ctx.moveTo(600, 400);
      ctx.lineTo(800, 400);
      ctx.lineTo(700, 320);
      ctx.fill();
    }

    function drawCloud(x, y) {
      ctx.beginPath();
      ctx.arc(x, y, 20, 0, Math.PI * 2);
      ctx.arc(x + 15, y - 10, 15, 0, Math.PI * 2);
      ctx.arc(x + 35, y, 25, 0, Math.PI * 2);
      ctx.fill();
    }

    function checkCollision(obj1, obj2) {
      return obj1.x < obj2.x + obj2.width &&
             obj1.x + obj1.width > obj2.x &&
             obj1.y < obj2.y + obj2.height &&
             obj1.y + obj1.height > obj2.y;
    }

    function createParticles(x, y, count, color) {
      for (let i = 0; i < count; i++) {
        particles.push({
          x: x,
          y: y,
          vx: (Math.random() - 0.5) * 5,
          vy: (Math.random() - 0.5) * 5,
          size: Math.random() * 5 + 2,
          color: color,
          life: 30
        });
      }
    }

    function createTextParticle(x, y, text, color) {
      particles.push({
        x: x,
        y: y,
        text: text,
        color: color,
        life: 60,
        type: 'text'
      });
    }

    function hurtOso() {
      gameState.lives--;
      createParticles(oso.x + oso.width/2, oso.y + oso.height/2, 20, "#FF5252");
      createTextParticle(oso.x + oso.width/2, oso.y, "-1 Vida", "#FF5252");
      oso.invincible = 120; // 2 segundos de invencibilidad (60fps)
      
      if (gameState.lives <= 0) {
        gameOver();
      } else {
        // Respawn seguro
        oso.x = 100;
        oso.y = 380;
      }
    }

    function gameOver() {
      gameState.gameStarted = false;
      startScreen.style.display = "flex";
      startButton.textContent = "Jugar de nuevo";
      
      // Mostrar mensaje de game over
      const gameOverText = document.createElement("div");
      gameOverText.innerHTML = `<h2>¡Game Over!</h2><p>Puntuación final: ${gameState.score}</p>`;
      gameOverText.style.textAlign = "center";
      gameOverText.style.marginTop = "20px";
      gameOverText.style.color = "#FFD700";
      
      if (!document.getElementById("gameOverText")) {
        gameOverText.id = "gameOverText";
        startScreen.appendChild(gameOverText);
      } else {
        document.getElementById("gameOverText").innerHTML = gameOverText.innerHTML;
      }
      
      // Reiniciar estado del juego
      gameState.score = 0;
      gameState.lives = 3;
      gameState.level = 1;
      scoreElement.textContent = "0";
      levelElement.textContent = "1";
    }

    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    // Iniciar carga de recursos
    loadResources();
    
    // Iniciar loop aunque el juego no haya empezado (para dibujar la pantalla de inicio)
    gameLoop();
  </script>
</body>
  </html>
