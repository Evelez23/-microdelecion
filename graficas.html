<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gr√°ficas de Casos</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tabletop@1.6.0/tabletop.min.js"></script>
</head>
<body>
  <nav>
    <a href="index.html">Inicio</a>
    <a href="formulario.html">‚ûï Agregar Caso</a>
    <a href="graficas.html" style="color:#f1c40f;">üìä Ver Gr√°ficas</a>
  </nav>

  <div class="container">
    <h1>Visualizaci√≥n de Casos Cl√≠nicos</h1>

    <canvas id="edadChart" style="max-height:400px;"></canvas>
    <canvas id="generoChart" style="max-height:400px; margin-top:40px;"></canvas>
  </div>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRSYFRG8sb61AiPcOU8ZkKZ-qB78TTeznBcqEs-ey45ANLr7kK7X8iqN34IupCOR0dZEqwBlgkJ6VLY/pub?output=csv";

    function agruparEdades(edad) {
      const e = parseInt(edad);
      if (isNaN(e)) return "No especificado";
      if (e <= 2) return "0‚Äì2 a√±os";
      if (e <= 5) return "3‚Äì5 a√±os";
      if (e <= 8) return "6‚Äì8 a√±os";
      if (e <= 12) return "9‚Äì12 a√±os";
      if (e <= 18) return "13‚Äì18 a√±os";
      return "18+ a√±os";
    }

    function contarValores(lista, clave) {
      const conteo = {};
      lista.forEach(row => {
        const valor = (row[clave] || "No especificado").trim();
        conteo[valor] = (conteo[valor] || 0) + 1;
      });
      return conteo;
    }

    function contarEdades(lista) {
      const grupos = {};
      lista.forEach(row => {
        const grupo = agruparEdades(row["Edad"]);
        grupos[grupo] = (grupos[grupo] || 0) + 1;
      });
      return grupos;
    }

    function graficar(idCanvas, titulo, dataObj, tipo="bar") {
      const ctx = document.getElementById(idCanvas).getContext("2d");
      new Chart(ctx, {
        type: tipo,
        data: {
          labels: Object.keys(dataObj),
          datasets: [{
            label: titulo,
            data: Object.values(dataObj),
            backgroundColor: [
              "#3498db", "#9b59b6", "#f1c40f", "#e67e22", "#2ecc71", "#e74c3c"
            ],
            borderColor: "#2c3e50",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: titulo }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      Tabletop.init({
        key: sheetURL,
        simpleSheet: true,
        callback: data => {
          const edades = contarEdades(data);
          const generos = contarValores(data, "*G√©nero");
          graficar("edadChart", "Distribuci√≥n por Edad", edades, "bar");
          graficar("generoChart", "Casos por G√©nero", generos, "pie");
        }
      });
    });
  </script>
</body>
</html>
