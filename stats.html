<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Estadísticas – Microdeleción 15q11.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    .chart-container {
      width: 100%;
      min-height: 400px;
      margin: 20px 0;
      position: relative;
    }
    
    .loading-chart {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 400px;
      flex-direction: column;
    }
    
    .fa-spinner {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: #4A6FA5;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .chart-legend {
      margin-top: 1rem;
      font-size: 0.9rem;
      text-align: center;
      color: #4a5568;
    }
    
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .summary-card {
      background: #f8fafc;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }
    
    .summary-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: #2b6cb0;
    }
    
    .error-card {
      background: #fff5f5;
      border: 1px solid #fed7d7;
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1rem 0;
      color: #e53e3e;
    }
  </style>
</head>
<body>
  <header>
    <h1>Estadísticas de Casos</h1>
    <p id="stats-subtitle">Análisis de datos de pacientes con microdeleción 15q11.2</p>
    <nav aria-label="Principal">
      <a class="nav-link" href="index.html">Inicio</a>
      <a class="nav-link" href="form.html">Agregar Caso</a>
      <a class="nav-link active" href="stats.html">Estadísticas</a>
      <a class="nav-link" href="patients.html">Pacientes</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h2><i class="fas fa-chart-pie"></i> Resumen Estadístico</h2>
      <div class="stats-summary" id="stats-summary">
        <div class="summary-card">
          <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2><i class="fas fa-user-friends"></i> Distribución por Género</h2>
      <div class="chart-container">
        <div class="loading-chart">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Cargando gráfico de género...</p>
        </div>
        <canvas id="generoChart"></canvas>
      </div>
      <div class="chart-legend" id="generoLegend"></div>
    </section>

    <section class="card">
      <h2><i class="fas fa-birthday-cake"></i> Distribución por Edades</h2>
      <div class="chart-container">
        <div class="loading-chart">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Cargando gráfico de edades...</p>
        </div>
        <canvas id="edadChart"></canvas>
      </div>
      <div class="chart-legend" id="edadLegend"></div>
    </section>

    <section class="card">
      <h2><i class="fas fa-comment-medical"></i> Síntomas más Frecuentes</h2>
      <div class="chart-container">
        <div class="loading-chart">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Cargando gráfico de síntomas...</p>
        </div>
        <canvas id="sintomasChart"></canvas>
      </div>
      <div class="chart-legend" id="sintomasLegend"></div>
    </section>
  </main>

  <footer>
    <div class="footer-content">
      <p>© 2025 – Investigación colaborativa sobre microdeleción 15q11.2</p>
      <div class="footer-links">
        <a href="privacy.html">Privacidad</a>
        <a href="ethics.html">Ética</a>
        <a href="contact.html">Contacto</a>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script type="module">
    import { read, utils } from 'https://cdn.sheetjs.com/xlsx-0.19.3/package/xlsx.mjs';

    // Función para corregir caracteres
    const fixEncoding = (str) => {
      if (!str) return '';
      return str
        .replace(/Ã¡/g, 'á').replace(/Ã©/g, 'é').replace(/Ã/g, 'í')
        .replace(/Ã³/g, 'ó').replace(/Ãº/g, 'ú').replace(/Ã±/g, 'ñ')
        .replace(/Ã¼/g, 'ü').replace(/Â¿/g, '¿').replace(/Â¡/g, '¡');
    };

    // Función para analizar síntomas
    const parseSymptoms = (symptomsStr) => {
      if (!symptomsStr) return [];
      return symptomsStr.split(';').map(s => s.trim()).filter(s => s.length > 0);
    };

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // 1. Cargar datos
        const excelUrl = 'https://raw.githubusercontent.com/Evelez23/-microdelecion/main/listaPacientes.xlsx';
        const response = await fetch(excelUrl);
        
        if (!response.ok) {
          throw new Error(`Error al cargar el archivo: ${response.status}`);
        }
        
        const data = await response.arrayBuffer();
        const workbook = read(data);
        const pacientes = utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        
        if (!pacientes || pacientes.length === 0) {
          throw new Error('El archivo no contiene datos de pacientes');
        }

        // 2. Procesar datos
        const edades = pacientes.map(p => {
          const edadStr = String(p.Edad || p.edad || '').replace(/\D+/g, '');
          return edadStr ? parseInt(edadStr) : null;
        }).filter(edad => edad !== null && !isNaN(edad));
        
        const generos = {
          Femenino: pacientes.filter(p => 
            (p['*Género'] === 'F' || p['*GÃ©nero'] === 'F') && 
            (p.Edad || p.edad)
          ).length,
          Masculino: pacientes.filter(p => 
            (p['*Género'] === 'M' || p['*GÃ©nero'] === 'M') && 
            (p.Edad || p.edad)
          ).length
        };

        // Análisis de síntomas
        const sintomasCount = {};
        pacientes.forEach(p => {
          const sintomasStr = p['Síntomas principales'] || p['SÃ­ntomas principales'] || '';
          const sintomas = parseSymptoms(sintomasStr);
          sintomas.forEach(s => {
            sintomasCount[s] = (sintomasCount[s] || 0) + 1;
          });
        });

        const sintomasOrdenados = Object.entries(sintomasCount)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10); // Top 10 síntomas

        // 3. Actualizar resumen
        document.getElementById('stats-summary').innerHTML = `
          <div class="summary-card">
            <div class="summary-value">${pacientes.length}</div>
            <div class="stat-label">Casos totales</div>
          </div>
          <div class="summary-card">
            <div class="summary-value">${edades.length ? (edades.reduce((a, b) => a + b, 0) / edades.length).toFixed(1) : 'N/D'}</div>
            <div class="stat-label">Edad promedio</div>
          </div>
          <div class="summary-card">
            <div class="summary-value">${Math.round((generos.Femenino / pacientes.length) * 100)}%</div>
            <div class="stat-label">Mujeres</div>
          </div>
          <div class="summary-card">
            <div class="summary-value">${Object.keys(sintomasCount).length}</div>
            <div class="stat-label">Síntomas distintos</div>
          </div>
        `;

        // 4. Renderizar gráficos
        renderGenderChart(generos);
        renderAgeChart(edades);
        renderSymptomsChart(sintomasOrdenados);

      } catch (error) {
        console.error("Error:", error);
        document.querySelector('main').innerHTML = `
          <div class="error-card">
            <h3>Error al cargar estadísticas</h3>
            <p>${error.message}</p>
            <p>Por favor, verifica:</p>
            <ul>
              <li>Que el archivo Excel esté en <code>main/listaPacientes.xlsx</code></li>
              <li>Que la conexión a internet funcione</li>
              <li>Que el archivo tenga la estructura correcta</li>
            </ul>
            <button onclick="window.location.reload()">Reintentar</button>
          </div>
        `;
      }
    });

    function renderGenderChart(data) {
      const ctx = document.getElementById('generoChart');
      const legendContainer = document.getElementById('generoLegend');
      
      // Eliminar spinner
      ctx.previousElementSibling.remove();
      
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(data),
          datasets: [{
            data: Object.values(data),
            backgroundColor: ['#FF6B6B', '#4A6FA5'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
      
      // Leyenda personalizada
      legendContainer.innerHTML = `
        <p><span style="display: inline-block; width: 12px; height: 12px; background: #FF6B6B; margin-right: 5px;"></span>
        Femenino: ${data.Femenino} pacientes (${Math.round((data.Femenino/(data.Femenino+data.Masculino))*100)}%)</p>
        <p><span style="display: inline-block; width: 12px; height: 12px; background: #4A6FA5; margin-right: 5px;"></span>
        Masculino: ${data.Masculino} pacientes (${Math.round((data.Masculino/(data.Femenino+data.Masculino))*100)}%)</p>
      `;
    }

    function renderAgeChart(edades) {
      const ctx = document.getElementById('edadChart');
      const legendContainer = document.getElementById('edadLegend');
      
      // Eliminar spinner
      ctx.previousElementSibling.remove();
      
      // Agrupar edades en rangos
      const ageGroups = {
        '0-5': edades.filter(age => age <= 5).length,
        '6-12': edades.filter(age => age > 5 && age <= 12).length,
        '13-18': edades.filter(age => age > 12 && age <= 18).length,
        '19-30': edades.filter(age => age > 18 && age <= 30).length,
        '31+': edades.filter(age => age > 30).length
      };
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(ageGroups),
          datasets: [{
            label: 'Pacientes',
            data: Object.values(ageGroups),
            backgroundColor: '#6BFF6B',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Número de pacientes'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Rango de edades'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
      
      // Leyenda
      legendContainer.innerHTML = `
        <p>Distribución de ${edades.length} pacientes con edad registrada</p>
        <p>Edad promedio: ${(edades.reduce((a, b) => a + b, 0) / edades.length).toFixed(1)} años</p>
      `;
    }

    function renderSymptomsChart(sintomas) {
      const ctx = document.getElementById('sintomasChart');
      const legendContainer = document.getElementById('sintomasLegend');
      
      // Eliminar spinner
      ctx.previousElementSibling.remove();
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sintomas.map(s => s[0]),
          datasets: [{
            label: 'Frecuencia',
            data: sintomas.map(s => s[1]),
            backgroundColor: '#FFA500',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          scales: {
            x: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Número de pacientes'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Síntomas'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
      
      // Leyenda
      legendContainer.innerHTML = `
        <p>Top ${sintomas.length} síntomas más frecuentes</p>
        <p>Total de síntomas distintos registrados: ${sintomas.length}</p>
      `;
    }
  </script>
</body>
</html>
